{% extends "base.html" %}

{% block title %}Signals - Mandate Pipeline{% endblock %}

{% block nav_index %}./{% endblock %}
{% block nav_signals %}./signals-unified.html{% endblock %}
{% block nav_signals_info %}./signals-info.html{% endblock %}
{% block nav_decisions %}./igov/{% endblock %}

{% block content %}
<!-- Stats -->
<div class="mb-3">
    <p class="text-sm text-muted" id="stats-text">
        {{ total_paragraphs }} paragraphs across {{ resolution_count }} resolution{% if resolution_count != 1 %}s{% endif %}{% if proposal_count > 0 %} and {{ proposal_count }} non-adopted proposal{% if proposal_count != 1 %}s{% endif %}{% endif %}
    </p>
</div>

<!-- Search -->
<div class="mb-2">
    <input type="text" id="search-input" placeholder="Search by symbol, title, or content..."
           class="w-full px-3 py-1.5 border border-gray-300 rounded-md bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
</div>

<!-- Filter Controls - Compact -->
<div class="mb-2 flex items-center gap-2">
    <label for="signal-filter" class="text-[10px] font-semibold uppercase tracking-wide text-gray-500 flex-shrink-0">Signal:</label>
    <select id="signal-filter" multiple size="3" aria-label="Select multiple signal types" aria-multiselectable="true" class="flex-1 max-w-md px-2 py-1 border border-gray-300 rounded-md bg-white text-xs shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
        {% for check in checks %}
        <option value="{{ check.signal }}">{{ check.signal }}</option>
        {% endfor %}
    </select>
    <button id="clear-filters" class="px-3 py-1 text-xs font-medium text-gray-600 hover:text-gray-900 transition-colors flex-shrink-0">
        Clear
    </button>
</div>

<!-- Main Content Area with Split View -->
<div class="flex gap-6" id="main-content">
    <!-- Document List -->
    <div class="flex-1 min-w-0" id="document-list">
        <div class="space-y-4" id="documents-container">
            {% for doc in documents %}
            <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors{% if doc.doc_type == 'proposal' %} border-l-4 border-l-amber-400{% endif %}"
                 data-symbol="{{ doc.symbol }}"
                 data-source="{{ doc.origin }}"
                 data-doctype="{{ doc.doc_type }}"
                 data-signals="{{ doc.signal_summary.keys()|list|join(',') }}"
                 data-un-url="{{ doc.un_url }}">
                <!-- Document Header -->
                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 cursor-pointer document-header hover:bg-gray-100 transition-colors">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="font-semibold text-gray-900" data-search>
                                    {{ doc.symbol }}
                                </span>
                                {% if doc.doc_type == 'proposal' %}
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
                                    Proposal
                                </span>
                                {% endif %}
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded text-xs font-bold flex-shrink-0
                                    {% if doc.origin == 'Plenary' %}bg-amber-50 text-amber-700
                                    {% elif doc.origin == 'C1' %}bg-red-50 text-red-700
                                    {% elif doc.origin == 'C2' %}bg-green-50 text-green-700
                                    {% elif doc.origin == 'C3' %}bg-blue-50 text-blue-700
                                    {% elif doc.origin == 'C4' %}bg-purple-50 text-purple-700
                                    {% elif doc.origin == 'C5' %}bg-orange-50 text-orange-700
                                    {% elif doc.origin == 'C6' %}bg-teal-50 text-teal-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ doc.origin[:2] }}
                                </span>
                                <span class="text-xs text-gray-500">{{ doc.signal_paragraphs|length }} signal{% if doc.signal_paragraphs|length != 1 %}s{% endif %}</span>
                            </div>
                            {% if doc.title %}
                            <p class="text-sm text-gray-600 truncate" title="{{ doc.title }}" data-search>{{ doc.title }}</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <svg class="w-4 h-4 text-gray-400 toggle-icon transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <a href="{{ doc.un_url }}" target="_blank"
                               class="text-xs text-muted hover:text-un-blue transition-colors"
                               onclick="event.stopPropagation()">
                                View PDF
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Paragraphs -->
                <div class="divide-y divide-gray-100 document-paragraphs" style="display: none;">
                    {% for para in doc.signal_paragraphs %}
                    <div class="px-4 py-3 paragraph-item" data-signals="{{ para.signals|join(',') }}">
                        <div class="flex flex-wrap items-start gap-2 text-sm text-gray-700 leading-relaxed">
                            <div class="inline-flex flex-wrap gap-1.5 items-center">
                                {% for signal in para.signals %}
                                <span class="px-2 py-0.5 rounded text-xs font-medium signal-tag inline-flex items-center justify-center
                                    {% if signal == 'agenda' %}bg-blue-100 text-blue-700
                                    {% elif signal == 'PGA' %}bg-purple-100 text-purple-700
                                    {% elif signal == 'process' %}bg-amber-100 text-amber-700
                                    {% elif signal == 'report' %}bg-green-100 text-green-700
                                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                                    {{ signal }}
                                </span>
                                {% endfor %}
                            </div>
                            <span class="font-medium text-gray-700">{{ para.number }}.</span>
                            <span class="flex-1 min-w-0 paragraph-text" data-search>{{ para.text|highlight_signals(para.signals) }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-muted">No documents match the selected filters.</p>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const signalFilter = document.getElementById('signal-filter');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const documentsContainer = document.getElementById('documents-container');
    const documentCards = document.querySelectorAll('.document-card');
    const emptyState = document.getElementById('empty-state');
    const statsText = document.getElementById('stats-text');

    // Get selected values from multiselect
    function getSelectedValues(selectElement) {
        return Array.from(selectElement.selectedOptions).map(opt => opt.value);
    }

    // Helper function to highlight search term
    function highlightSearchTerm(text, searchTerm) {
        if (!searchTerm) return text;
        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
    }

    // Remove existing highlights
    function removeHighlights() {
        document.querySelectorAll('mark.bg-yellow-200').forEach(mark => {
            const parent = mark.parentNode;
            parent.replaceChild(document.createTextNode(mark.textContent), mark);
            parent.normalize();
        });
    }

    // Apply search highlighting
    function applySearchHighlights(searchTerm) {
        if (!searchTerm) return;
        
        document.querySelectorAll('[data-search]').forEach(element => {
            const text = element.textContent;
            if (text.toLowerCase().includes(searchTerm.toLowerCase())) {
                element.innerHTML = highlightSearchTerm(text, searchTerm);
            }
        });
    }

    // Toggle document paragraphs
    function toggleDocument(card) {
        const paragraphsDiv = card.querySelector('.document-paragraphs');
        const toggleIcon = card.querySelector('.toggle-icon');
        
        if (paragraphsDiv.style.display === 'none') {
            paragraphsDiv.style.display = 'block';
            toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            paragraphsDiv.style.display = 'none';
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    }

    // Add click handlers to document headers
    documentCards.forEach(card => {
        const header = card.querySelector('.document-header');
        header.addEventListener('click', function() {
            toggleDocument(card);
        });
    });

    // Parse URL params and set initial filter state
    function initFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const signals = params.getAll('signal');
        const searchQuery = params.get('q') || '';

        // Set search input
        searchInput.value = searchQuery;

        // Set multiselect values
        signals.forEach(signal => {
            const opt = signalFilter.querySelector(`option[value="${signal}"]`);
            if (opt) opt.selected = true;
        });

        applyFilters();
    }

    // Update URL without reloading
    function updateUrl() {
        const params = new URLSearchParams();
        const searchQuery = searchInput.value.trim();
        
        if (searchQuery) {
            params.set('q', searchQuery);
        }
        getSelectedValues(signalFilter).forEach(v => params.append('signal', v));

        const newUrl = params.toString()
            ? `${window.location.pathname}?${params.toString()}`
            : window.location.pathname;
        history.replaceState(null, '', newUrl);
    }

    function applyFilters() {
        const selectedSignals = getSelectedValues(signalFilter);
        const searchQuery = searchInput.value.toLowerCase().trim();
        let resolutionCount = 0;
        let proposalCount = 0;
        let paragraphCount = 0;

        // Remove previous highlights
        removeHighlights();

        documentCards.forEach(card => {
            const cardDoctype = card.dataset.doctype;
            const cardSignals = card.dataset.signals.split(',').filter(s => s);

            // Check signal filter (match any selected)
            const signalMatch = selectedSignals.length === 0 || selectedSignals.some(s => cardSignals.includes(s));

            // Check search match
            let searchMatch = !searchQuery;
            let hasSearchMatchInPara = false;
            
            if (searchQuery) {
                // Check symbol and title
                const symbolText = card.querySelector('[data-search]').textContent.toLowerCase();
                const titleElement = card.querySelectorAll('[data-search]')[1];
                const titleText = titleElement ? titleElement.textContent.toLowerCase() : '';
                
                searchMatch = symbolText.includes(searchQuery) || titleText.includes(searchQuery);
                
                // Check paragraphs
                const paragraphs = card.querySelectorAll('.paragraph-text');
                paragraphs.forEach(para => {
                    if (para.textContent.toLowerCase().includes(searchQuery)) {
                        searchMatch = true;
                        hasSearchMatchInPara = true;
                    }
                });
            }

            if (signalMatch && searchMatch) {
                card.classList.remove('hidden');
                if (cardDoctype === 'resolution') {
                    resolutionCount++;
                } else {
                    proposalCount++;
                }

                // Filter paragraphs within the card if signal filter is active
                const paragraphs = card.querySelectorAll('.paragraph-item');
                let visibleParaCount = 0;
                paragraphs.forEach(para => {
                    const paraSignals = para.dataset.signals.split(',').filter(s => s);
                    const paraText = para.querySelector('.paragraph-text');
                    const paraSearchMatch = !searchQuery || paraText.textContent.toLowerCase().includes(searchQuery);
                    
                    if ((selectedSignals.length === 0 || selectedSignals.some(s => paraSignals.includes(s))) && paraSearchMatch) {
                        para.classList.remove('hidden');
                        paragraphCount++;
                        visibleParaCount++;
                    } else {
                        para.classList.add('hidden');
                    }
                });

                // Auto-expand if search matches content in paragraphs
                if (hasSearchMatchInPara && searchQuery) {
                    const paragraphsDiv = card.querySelector('.document-paragraphs');
                    const toggleIcon = card.querySelector('.toggle-icon');
                    paragraphsDiv.style.display = 'block';
                    toggleIcon.style.transform = 'rotate(180deg)';
                }
            } else {
                card.classList.add('hidden');
            }
        });

        // Apply search highlights
        if (searchQuery) {
            applySearchHighlights(searchQuery);
        }

        // Show/hide empty state
        const visibleCount = resolutionCount + proposalCount;
        if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
            documentsContainer.classList.add('hidden');
        } else {
            emptyState.classList.add('hidden');
            documentsContainer.classList.remove('hidden');
        }

        // Update stats
        const parts = [];
        if (resolutionCount > 0) {
            parts.push(`${resolutionCount} resolution${resolutionCount !== 1 ? 's' : ''}`);
        }
        if (proposalCount > 0) {
            parts.push(`${proposalCount} non-adopted proposal${proposalCount !== 1 ? 's' : ''}`);
        }
        statsText.textContent = parts.length > 0 ? parts.join(' and ') : '0 documents';

        updateUrl();
    }

    // Event listeners
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300); // Debounce search
    });
    
    signalFilter.addEventListener('change', applyFilters);

    clearFiltersBtn.addEventListener('click', function() {
        // Clear search
        searchInput.value = '';
        // Deselect all options in multiselect
        Array.from(signalFilter.options).forEach(opt => opt.selected = false);
        applyFilters();
    });

    // Initialize from URL
    initFromUrl();
});
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }} Â· <a href="./data.json" class="text-un-blue hover:underline">JSON API</a>
{% endblock %}
