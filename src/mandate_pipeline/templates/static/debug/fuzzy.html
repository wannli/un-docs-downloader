{% extends "base.html" %}

{% block title %}Fuzzy Match Explorer - Mandate Pipeline{% endblock %}

{% block nav_index %}../{% endblock %}
{% block nav_signals_info %}../signals-info.html{% endblock %}
{% block nav_decisions %}../igov/{% endblock %}
{% block nav_api %}../data.json{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="mb-8">
    <ol class="flex items-center gap-2 text-sm text-muted">
        <li><a href="../index.html" class="hover:text-un-blue transition-colors">Home</a></li>
        <li class="text-gray-300">/</li>
        <li><a href="./index.html" class="hover:text-un-blue transition-colors">Debug</a></li>
        <li class="text-gray-300">/</li>
        <li class="text-gray-900 font-medium">Fuzzy Match Explorer</li>
    </ol>
</nav>

<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Fuzzy Match Explorer</h1>
    <p class="mt-2 text-muted">
        Explore how resolutions are matched to proposals using fuzzy title matching.
        Threshold: <strong>85%</strong> similarity required for automatic linking.
    </p>
</div>

<!-- Stats -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-gray-900">{{ stats.total_resolutions }}</div>
        <div class="text-sm text-muted">Resolutions</div>
    </div>
    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-gray-900">{{ stats.total_proposals }}</div>
        <div class="text-sm text-muted">Proposals</div>
    </div>
    <div class="bg-white border border-green-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-600">{{ stats.fuzzy_linked }}</div>
        <div class="text-sm text-muted">Fuzzy Linked</div>
    </div>
    <div class="bg-white border border-amber-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-amber-600">{{ stats.near_misses }}</div>
        <div class="text-sm text-muted">Near Misses (70-84%)</div>
    </div>
</div>

<!-- Search -->
<div class="mb-6">
    <input type="text" id="search-input" placeholder="Search resolutions by symbol or title..."
           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-un-blue focus:border-un-blue outline-none">
</div>

<!-- Filter Tabs -->
<div class="flex gap-2 mb-6">
    <button onclick="filterEntries('all')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-un-blue text-white" data-filter="all">
        All ({{ fuzzy_entries|length }})
    </button>
    <button onclick="filterEntries('linked')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="linked">
        Linked ({{ stats.fuzzy_linked }})
    </button>
    <button onclick="filterEntries('near-miss')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="near-miss">
        Near Misses ({{ stats.near_misses }})
    </button>
    <button onclick="filterEntries('no-match')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="no-match">
        No Match ({{ stats.no_match }})
    </button>
</div>

<!-- Entries -->
<div class="space-y-4" id="fuzzy-entries">
    {% for entry in fuzzy_entries %}
    {% set best_score = entry.candidates[0].score if entry.candidates else 0 %}
    {% set status = 'linked' if entry.linked else ('near-miss' if best_score >= 70 else 'no-match') %}
    <div class="fuzzy-entry border border-gray-200 rounded-lg overflow-hidden"
         data-symbol="{{ entry.symbol|lower }}"
         data-title="{{ entry.title|lower }}"
         data-status="{{ status }}">
        <!-- Header -->
        <div class="p-4 bg-gray-50">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <a href="../../documents/{{ entry.filename }}" class="font-mono font-medium text-gray-900 hover:text-un-blue transition-colors">
                            {{ entry.symbol }}
                        </a>
                        {% if entry.linked %}
                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">linked</span>
                        {% elif best_score >= 70 %}
                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700">near miss</span>
                        {% else %}
                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">no match</span>
                        {% endif %}
                    </div>
                    {% if entry.title %}
                    <p class="text-sm text-muted mt-1">{{ entry.title }}</p>
                    {% endif %}
                </div>
                {% if entry.linked %}
                <a href="../../documents/{{ entry.linked_symbol|replace('/', '_') }}.html"
                   class="px-3 py-1 rounded bg-green-50 border border-green-200 text-green-700 text-xs font-medium hover:bg-green-100 transition-colors">
                    &rarr; {{ entry.linked_symbol }}
                </a>
                {% endif %}
            </div>

            <!-- Normalized title -->
            <div class="mt-2 text-xs text-gray-500">
                <span class="font-medium">Normalized:</span>
                <code class="ml-1 px-1 py-0.5 bg-white rounded border border-gray-200">"{{ entry.normalized_title }}"</code>
            </div>
        </div>

        <!-- Candidates -->
        {% if entry.candidates %}
        <div class="p-4 border-t border-gray-200">
            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">
                Top Matches ({{ entry.candidates|length }} candidates)
            </h4>
            <div class="space-y-2">
                {% for cand in entry.candidates[:5] %}
                <div class="flex items-center gap-3 p-2 rounded {% if cand.symbol == entry.linked_symbol %}bg-green-50 border border-green-200{% elif cand.score >= 85 %}bg-amber-50{% else %}bg-gray-50{% endif %}">
                    <!-- Score bar -->
                    <div class="w-16 flex-shrink-0">
                        <div class="flex items-center gap-1">
                            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full rounded-full
                                    {% if cand.score >= 85 %}bg-green-500
                                    {% elif cand.score >= 70 %}bg-amber-500
                                    {% else %}bg-gray-400{% endif %}"
                                     style="width: {{ cand.score }}%"></div>
                            </div>
                            <span class="text-xs font-mono font-medium
                                {% if cand.score >= 85 %}text-green-700
                                {% elif cand.score >= 70 %}text-amber-700
                                {% else %}text-gray-600{% endif %}">
                                {{ cand.score|int }}%
                            </span>
                        </div>
                    </div>

                    <!-- Symbol and title -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <a href="../../documents/{{ cand.symbol|replace('/', '_') }}.html"
                               class="font-mono text-sm text-gray-900 hover:text-un-blue transition-colors">
                                {{ cand.symbol }}
                            </a>
                            {% if cand.agenda_overlap %}
                            <span class="px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700">agenda match</span>
                            {% endif %}
                            {% if cand.symbol == entry.linked_symbol %}
                            <span class="px-1.5 py-0.5 rounded text-xs bg-green-100 text-green-700">LINKED</span>
                            {% endif %}
                        </div>
                        <p class="text-xs text-muted truncate mt-0.5">{{ cand.title }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if entry.candidates|length > 5 %}
            <p class="text-xs text-muted mt-2">+ {{ entry.candidates|length - 5 }} more candidates below threshold</p>
            {% endif %}
        </div>
        {% else %}
        <div class="p-4 border-t border-gray-200 text-sm text-muted">
            No proposals with &gt;50% title similarity found.
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<script>
// Search functionality
document.getElementById('search-input').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll('.fuzzy-entry').forEach(entry => {
        const symbol = entry.dataset.symbol;
        const title = entry.dataset.title;
        const matches = symbol.includes(query) || title.includes(query);
        entry.style.display = matches ? '' : 'none';
    });
});

// Filter functionality
function filterEntries(filter) {
    // Update button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
            btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            btn.classList.add('bg-un-blue', 'text-white');
        } else {
            btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            btn.classList.remove('bg-un-blue', 'text-white');
        }
    });

    // Filter entries
    document.querySelectorAll('.fuzzy-entry').forEach(entry => {
        const status = entry.dataset.status;
        if (filter === 'all') {
            entry.style.display = '';
        } else {
            entry.style.display = status === filter ? '' : 'none';
        }
    });
}
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }}
{% endblock %}
