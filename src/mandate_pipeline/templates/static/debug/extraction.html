{% extends "base.html" %}

{% block title %}Extraction Verification - Mandate Pipeline{% endblock %}

{% block nav_index %}../index.html{% endblock %}
{% block nav_documents %}../documents/index.html{% endblock %}
{% block nav_provenance %}../provenance/index.html{% endblock %}
{% block nav_origin_matrix %}../origin_matrix.html{% endblock %}
{% block nav_debug %}./index.html{% endblock %}
{% block nav_linking %}./linking.html{% endblock %}
{% block nav_orphans %}./orphans.html{% endblock %}
{% block nav_extraction %}./extraction.html{% endblock %}
{% block nav_api %}../data.json{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="mb-8">
    <ol class="flex items-center gap-2 text-sm text-muted">
        <li><a href="../index.html" class="hover:text-un-blue transition-colors">Home</a></li>
        <li class="text-gray-300">/</li>
        <li><a href="./index.html" class="hover:text-un-blue transition-colors">Debug</a></li>
        <li class="text-gray-300">/</li>
        <li class="text-gray-900 font-medium">Extraction Verification</li>
    </ol>
</nav>

<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Extraction Verification</h1>
    <p class="mt-2 text-muted">
        Review extraction quality for each document. Verify that titles, paragraphs, and references were correctly extracted from PDFs.
    </p>
</div>

<!-- Summary Stats -->
<div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-8">
    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-gray-900">{{ stats.total_docs }}</div>
        <div class="text-sm text-muted">Documents</div>
    </div>
    <div class="bg-white border border-green-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-600">{{ stats.with_title }}</div>
        <div class="text-sm text-muted">With Title</div>
    </div>
    <div class="bg-white border border-blue-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-blue-600">{{ stats.with_paragraphs }}</div>
        <div class="text-sm text-muted">With Paragraphs</div>
    </div>
    <div class="bg-white border border-purple-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-purple-600">{{ stats.with_refs }}</div>
        <div class="text-sm text-muted">With Symbol Refs</div>
    </div>
    <div class="bg-white border border-amber-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-amber-600">{{ stats.potential_issues }}</div>
        <div class="text-sm text-muted">Potential Issues</div>
    </div>
</div>

<!-- Quality Indicators Legend -->
<div class="bg-gray-50 rounded-lg p-4 mb-8">
    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Quality Indicators</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-green-500"></span>
            <span class="text-gray-700">Good extraction</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-amber-500"></span>
            <span class="text-gray-700">Missing some data</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-red-500"></span>
            <span class="text-gray-700">Extraction issue</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-gray-400"></span>
            <span class="text-gray-700">Not applicable</span>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="flex gap-4 mb-6">
    <div class="flex-1">
        <input type="text" id="search-input" placeholder="Search by symbol..."
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-un-blue focus:border-un-blue outline-none">
    </div>
    <select id="filter-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-un-blue focus:border-un-blue outline-none">
        <option value="all">All Documents</option>
        <option value="issues">With Issues</option>
        <option value="no-title">Missing Title</option>
        <option value="no-paragraphs">No Paragraphs</option>
        <option value="few-paragraphs">Few Paragraphs (&lt;3)</option>
    </select>
</div>

<!-- Documents Table -->
<div class="overflow-x-auto">
    <table class="w-full text-sm">
        <thead class="bg-gray-50 sticky top-0">
            <tr>
                <th class="text-left py-3 px-4 font-medium text-gray-500">Symbol</th>
                <th class="text-left py-3 px-4 font-medium text-gray-500">Title</th>
                <th class="text-center py-3 px-4 font-medium text-gray-500">Paras</th>
                <th class="text-center py-3 px-4 font-medium text-gray-500">Signals</th>
                <th class="text-center py-3 px-4 font-medium text-gray-500">Refs</th>
                <th class="text-center py-3 px-4 font-medium text-gray-500">Agenda</th>
                <th class="text-center py-3 px-4 font-medium text-gray-500">Quality</th>
                <th class="text-right py-3 px-4 font-medium text-gray-500">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="documents-table">
            {% for doc in documents %}
            {% set has_title = doc.title and doc.title|length > 5 %}
            {% set has_paras = doc.num_paragraphs > 0 %}
            {% set has_signals = doc.signal_summary|length > 0 %}
            {% set has_refs = doc.symbol_references|length > 0 %}
            {% set has_agenda = doc.agenda_items|length > 0 %}
            {% set few_paras = doc.num_paragraphs > 0 and doc.num_paragraphs < 3 %}
            {% set quality_score = (1 if has_title else 0) + (1 if has_paras else 0) + (0.5 if has_signals else 0) %}
            {% set has_issue = not has_title or not has_paras or few_paras %}
            <tr class="doc-row hover:bg-gray-50 transition-colors"
                data-symbol="{{ doc.symbol|lower }}"
                data-has-issue="{{ 'true' if has_issue else 'false' }}"
                data-no-title="{{ 'true' if not has_title else 'false' }}"
                data-no-paragraphs="{{ 'true' if not has_paras else 'false' }}"
                data-few-paragraphs="{{ 'true' if few_paras else 'false' }}">
                <td class="py-3 px-4">
                    <a href="../../documents/{{ doc.filename }}" class="font-mono font-medium text-gray-900 hover:text-un-blue transition-colors">
                        {{ doc.symbol }}
                    </a>
                </td>
                <td class="py-3 px-4 max-w-xs">
                    {% if has_title %}
                    <span class="text-gray-700 truncate block" title="{{ doc.title }}">{{ doc.title[:40] }}{% if doc.title|length > 40 %}...{% endif %}</span>
                    {% else %}
                    <span class="text-red-500 text-xs">Missing or short title</span>
                    {% endif %}
                </td>
                <td class="py-3 px-4 text-center">
                    <span class="inline-flex items-center justify-center min-w-[2rem] px-2 py-0.5 rounded-full text-xs font-medium
                        {% if doc.num_paragraphs >= 3 %}bg-green-100 text-green-700
                        {% elif doc.num_paragraphs > 0 %}bg-amber-100 text-amber-700
                        {% else %}bg-red-100 text-red-700{% endif %}">
                        {{ doc.num_paragraphs }}
                    </span>
                </td>
                <td class="py-3 px-4 text-center">
                    {% if has_signals %}
                    <span class="text-green-600">{{ doc.signal_summary|length }}</span>
                    {% else %}
                    <span class="text-gray-400">&mdash;</span>
                    {% endif %}
                </td>
                <td class="py-3 px-4 text-center">
                    {% if has_refs %}
                    <span class="text-blue-600">{{ doc.symbol_references|length }}</span>
                    {% else %}
                    <span class="text-gray-400">&mdash;</span>
                    {% endif %}
                </td>
                <td class="py-3 px-4 text-center">
                    {% if has_agenda %}
                    <span class="text-purple-600">{{ doc.agenda_items|length }}</span>
                    {% else %}
                    <span class="text-gray-400">&mdash;</span>
                    {% endif %}
                </td>
                <td class="py-3 px-4 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <span class="w-2 h-2 rounded-full {% if has_title %}bg-green-500{% else %}bg-red-500{% endif %}" title="Title"></span>
                        <span class="w-2 h-2 rounded-full {% if has_paras and not few_paras %}bg-green-500{% elif has_paras %}bg-amber-500{% else %}bg-red-500{% endif %}" title="Paragraphs"></span>
                        <span class="w-2 h-2 rounded-full {% if has_signals %}bg-green-500{% else %}bg-gray-300{% endif %}" title="Signals"></span>
                    </div>
                </td>
                <td class="py-3 px-4 text-right">
                    <a href="{{ doc.un_url }}" target="_blank" class="text-xs text-un-blue hover:underline">
                        PDF
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Document Details Panel (expandable) -->
<div id="detail-panel" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-lg max-h-96 overflow-y-auto">
    <div class="max-w-5xl mx-auto p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900" id="detail-symbol"></h3>
            <button onclick="closeDetailPanel()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="detail-content"></div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('search-input').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    filterTable();
});

// Filter functionality
document.getElementById('filter-select').addEventListener('change', function(e) {
    filterTable();
});

function filterTable() {
    const query = document.getElementById('search-input').value.toLowerCase();
    const filter = document.getElementById('filter-select').value;

    document.querySelectorAll('.doc-row').forEach(row => {
        const symbol = row.dataset.symbol;
        const matchesSearch = symbol.includes(query);

        let matchesFilter = true;
        switch (filter) {
            case 'issues':
                matchesFilter = row.dataset.hasIssue === 'true';
                break;
            case 'no-title':
                matchesFilter = row.dataset.noTitle === 'true';
                break;
            case 'no-paragraphs':
                matchesFilter = row.dataset.noParagraphs === 'true';
                break;
            case 'few-paragraphs':
                matchesFilter = row.dataset.fewParagraphs === 'true';
                break;
        }

        row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
}

function closeDetailPanel() {
    document.getElementById('detail-panel').classList.add('hidden');
}
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }}
{% endblock %}
