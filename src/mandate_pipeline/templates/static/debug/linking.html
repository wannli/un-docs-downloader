{% extends "base.html" %}

{% block title %}Linking Audit - Mandate Pipeline{% endblock %}

{% block nav_index %}../../index.html{% endblock %}
{% block nav_documents %}../../documents/index.html{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="mb-8">
    <ol class="flex items-center gap-2 text-sm text-muted">
        <li><a href="../../index.html" class="hover:text-un-blue transition-colors">Home</a></li>
        <li class="text-gray-300">/</li>
        <li><a href="./index.html" class="hover:text-un-blue transition-colors">Debug</a></li>
        <li class="text-gray-300">/</li>
        <li class="text-gray-900 font-medium">Linking Audit</li>
    </ol>
</nav>

<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Linking Audit Report</h1>
    <p class="mt-2 text-muted">
        Detailed breakdown of how each resolution was linked to its source proposals.
    </p>
</div>

<!-- Summary Stats -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
    <div class="bg-white border border-gray-200 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-900">{{ stats.total }}</div>
        <div class="text-sm text-muted">Total Resolutions</div>
    </div>
    <div class="bg-white border border-green-200 rounded-lg p-4">
        <div class="text-2xl font-bold text-green-600">{{ stats.linked }}</div>
        <div class="text-sm text-muted">Successfully Linked</div>
    </div>
    <div class="bg-white border border-red-200 rounded-lg p-4">
        <div class="text-2xl font-bold text-red-600">{{ stats.unlinked }}</div>
        <div class="text-sm text-muted">Unlinked</div>
    </div>
    <div class="bg-white border border-blue-200 rounded-lg p-4">
        <div class="text-2xl font-bold text-blue-600">{{ "%.1f"|format(stats.coverage_pct) }}%</div>
        <div class="text-sm text-muted">Coverage</div>
    </div>
</div>

<!-- Method Breakdown -->
<div class="bg-white border border-gray-200 rounded-lg p-4 mb-8">
    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Linking Methods Used</h2>
    <div class="grid grid-cols-2 gap-4">
        <div class="text-center">
            <div class="text-xl font-bold text-green-600">{{ stats.by_method.undl }}</div>
            <div class="text-sm text-muted">UNDL Metadata</div>
            <div class="text-xs text-gray-400">(authoritative)</div>
        </div>
        <div class="text-center">
            <div class="text-xl font-bold text-blue-600">{{ stats.by_method.symbol_ref }}</div>
            <div class="text-sm text-muted">Symbol Reference</div>
            <div class="text-xs text-gray-400">(from PDF text)</div>
        </div>
    </div>
</div>

<!-- UNDL Cache Stats -->
<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">UNDL Metadata Cache</h2>
        <span class="text-xs text-muted">{{ undl_cache.total_entries }} entries | {{ "%.2f"|format(undl_cache.cache_size_bytes / 1024) }} KB</span>
    </div>
    {% if undl_cache.entries %}
    <div class="max-h-48 overflow-y-auto">
        <table class="w-full text-sm">
            <thead class="sticky top-0 bg-gray-50">
                <tr>
                    <th class="text-left py-1 px-2 text-xs font-medium text-gray-500">Symbol</th>
                    <th class="text-left py-1 px-2 text-xs font-medium text-gray-500">Draft Refs</th>
                    <th class="text-right py-1 px-2 text-xs font-medium text-gray-500">Size</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for entry in undl_cache.entries[:20] %}
                <tr class="hover:bg-white">
                    <td class="py-1 px-2 font-mono text-xs">{{ entry.symbol }}</td>
                    <td class="py-1 px-2 text-xs text-muted">{{ entry.draft_symbols|join(", ") or "None" }}</td>
                    <td class="py-1 px-2 text-xs text-muted text-right">{{ entry.size_bytes }} B</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if undl_cache.entries|length > 20 %}
    <p class="text-xs text-muted mt-2">Showing 20 of {{ undl_cache.entries|length }} entries</p>
    {% endif %}
    {% else %}
    <p class="text-sm text-muted">No cached entries.</p>
    {% endif %}
</div>

<!-- Search -->
<div class="mb-6">
    <input type="text" id="search-input" placeholder="Search by symbol..."
           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-un-blue focus:border-un-blue outline-none">
</div>

<!-- Audit Entries -->
<div class="space-y-4" id="audit-entries">
    {% for symbol, audit in audit_data.items() %}
    <div class="audit-entry border border-gray-200 rounded-lg overflow-hidden" data-symbol="{{ symbol|lower }}">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 bg-gray-50 cursor-pointer" onclick="toggleAudit('{{ symbol }}')">
            <div class="flex items-center gap-3">
                <span class="font-mono font-medium text-gray-900">{{ symbol }}</span>
                {% if audit.final_method %}
                <span class="px-2 py-0.5 rounded text-xs font-medium
                    {% if audit.final_method == 'undl' %}bg-green-100 text-green-700
                    {% elif audit.final_method == 'symbol_ref' %}bg-blue-100 text-blue-700
                    {% else %}bg-amber-100 text-amber-700{% endif %}">
                    {{ audit.final_method }}
                </span>
                <span class="text-xs text-muted">{{ audit.confidence }}% confidence</span>
                {% else %}
                <span class="px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">unlinked</span>
                {% endif %}
            </div>
            <svg class="w-5 h-5 text-gray-400 transform transition-transform" id="chevron-{{ symbol }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>

        <!-- Details (hidden by default) -->
        <div class="hidden p-4 border-t border-gray-200 bg-white" id="details-{{ symbol }}">
            {% if audit.title %}
            <p class="text-sm text-muted mb-4">{{ audit.title }}</p>
            {% endif %}

            <!-- Pass 0: UNDL -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                    {% if audit.pass0_undl.found %}
                    <span class="text-green-500">&#10004;</span>
                    {% elif audit.pass0_undl.attempted %}
                    <span class="text-red-500">&#10008;</span>
                    {% else %}
                    <span class="text-gray-400">&#9679;</span>
                    {% endif %}
                    <span class="text-sm font-medium text-gray-700">Pass 0: UNDL Metadata</span>
                </div>
                <div class="ml-6 text-xs text-muted">
                    {% if audit.pass0_undl.found %}
                    Found refs: {{ audit.pass0_undl.refs|join(", ") }}<br>
                    Linked locally: {{ audit.pass0_undl.linked|join(", ") or "None available locally" }}
                    {% elif audit.pass0_undl.attempted %}
                    No cross-references found in UNDL metadata
                    {% else %}
                    Skipped (already linked or not attempted)
                    {% endif %}
                </div>
            </div>

            <!-- Pass 1: Symbol Refs -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                    {% if audit.pass1_symbol_refs.linked %}
                    <span class="text-green-500">&#10004;</span>
                    {% elif audit.pass1_symbol_refs.attempted %}
                    <span class="text-red-500">&#10008;</span>
                    {% else %}
                    <span class="text-gray-400">&#9679;</span>
                    {% endif %}
                    <span class="text-sm font-medium text-gray-700">Pass 1: Symbol References</span>
                </div>
                <div class="ml-6 text-xs text-muted">
                    {% if audit.pass1_symbol_refs.refs_in_text %}
                    Proposal refs in text: {{ audit.pass1_symbol_refs.refs_in_text|join(", ") }}<br>
                    {% else %}
                    No L. symbol references found in PDF text<br>
                    {% endif %}
                    {% if audit.pass1_symbol_refs.linked %}
                    Linked: {{ audit.pass1_symbol_refs.linked|join(", ") }}
                    {% elif audit.pass1_symbol_refs.attempted %}
                    No matching local proposals found
                    {% else %}
                    Skipped (already linked)
                    {% endif %}
                </div>
            </div>

            <!-- Final Result -->
            <div class="pt-4 border-t border-gray-100">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">Final Result:</span>
                    {% if audit.final_linked %}
                    <div class="flex items-center gap-2">
                        {% for linked_symbol in audit.final_linked %}
                        <a href="../../documents/{{ linked_symbol|replace('/', '_') }}.html"
                           class="px-2 py-1 rounded bg-green-50 text-green-700 text-xs font-medium hover:bg-green-100 transition-colors">
                            {{ linked_symbol }}
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <span class="text-sm text-red-600">No link established</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
function toggleAudit(symbol) {
    const details = document.getElementById('details-' + symbol);
    const chevron = document.getElementById('chevron-' + symbol);

    details.classList.toggle('hidden');
    chevron.classList.toggle('rotate-180');
}

// Search functionality
document.getElementById('search-input').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll('.audit-entry').forEach(entry => {
        const symbol = entry.dataset.symbol;
        entry.style.display = symbol.includes(query) ? '' : 'none';
    });
});
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }}
{% endblock %}
