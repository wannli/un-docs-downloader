{% extends "base.html" %}

{% block title %}Unified Signals Explorer - Mandate Pipeline{% endblock %}

{% block nav_index %}./index.html{% endblock %}
{% block nav_signals %}./signals.html{% endblock %}
{% block nav_signals_info %}./signals-info.html{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Unified Signals Explorer</h1>
    <p class="mt-2 text-muted" id="stats-text">
        {{ total_paragraphs }} paragraphs across {{ resolution_count }} resolution{% if resolution_count != 1 %}s{% endif %}{% if proposal_count > 0 %} and {{ proposal_count }} non-adopted proposal{% if proposal_count != 1 %}s{% endif %}{% endif %}
    </p>
</div>

<!-- Session Selector and Search -->
<div class="mb-8 flex flex-wrap gap-4 items-end">
    <div class="flex-1 min-w-[200px]">
        <label for="session-selector" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Sessions</label>
        <select id="session-selector" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="4">
            <option value="current" selected>Current Session</option>
            <option value="79" selected>Session 79</option>
            <option value="78" selected>Session 78</option>
        </select>
        <p class="mt-1 text-xs text-gray-500">Hold Ctrl/Cmd to select multiple</p>
    </div>
    <div class="flex-1 min-w-[300px]">
        <label for="search-input" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Search Documents</label>
        <input type="text" id="search-input" placeholder="Search by symbol, title, or content..."
               class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
    </div>
</div>

<!-- Filter Controls -->
<div class="mb-8 flex flex-wrap gap-4 items-end">
    <div class="flex-1 min-w-[200px]">
        <label for="source-filter" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Source</label>
        <select id="source-filter" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="4">
            {% for origin_code in origin_order %}
            <option value="{{ origin_code }}">{{ origin_names.get(origin_code, origin_code) }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="flex-1 min-w-[200px]">
        <label for="signal-filter" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Signal Type</label>
        <select id="signal-filter" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="4">
            {% for check in checks %}
            <option value="{{ check.signal }}"
                {% if check.signal == 'agenda' %}class="text-blue-700"
                {% elif check.signal == 'PGA' %}class="text-purple-700"
                {% elif check.signal == 'process' %}class="text-amber-700"
                {% elif check.signal == 'report' %}class="text-green-700"{% endif %}>{{ check.signal }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="flex-1 min-w-[200px]">
        <label for="doctype-filter" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Document Type</label>
        <select id="doctype-filter" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="2">
            <option value="resolution">Resolutions</option>
            <option value="proposal">Non-adopted Proposals</option>
        </select>
    </div>
    <button id="clear-filters" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">
        Clear filters
    </button>
</div>

<!-- Main Content Area with Split View -->
<div class="flex gap-6" id="main-content">
    <!-- Document List -->
    <div class="flex-1 min-w-0" id="document-list">
        <div class="space-y-4" id="documents-container">
            {% for doc in documents %}
            <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors{% if doc.doc_type == 'proposal' %} border-l-4 border-l-amber-400{% endif %}"
                 data-symbol="{{ doc.symbol }}"
                 data-source="{{ doc.origin }}"
                 data-doctype="{{ doc.doc_type }}"
                 data-signals="{{ doc.signal_summary.keys()|list|join(',') }}"
                 data-un-url="{{ doc.un_url }}"
                 data-title="{{ doc.title or '' }}"
                 data-session="current">
                <!-- Document Header -->
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="font-semibold text-gray-900">
                                    {{ doc.symbol }}
                                </span>
                                {% if doc.doc_type == 'proposal' %}
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
                                    Proposal
                                </span>
                                {% endif %}
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded text-xs font-bold flex-shrink-0
                                    {% if doc.origin == 'Plenary' %}bg-amber-50 text-amber-700
                                    {% elif doc.origin == 'C1' %}bg-red-50 text-red-700
                                    {% elif doc.origin == 'C2' %}bg-green-50 text-green-700
                                    {% elif doc.origin == 'C3' %}bg-blue-50 text-blue-700
                                    {% elif doc.origin == 'C4' %}bg-purple-50 text-purple-700
                                    {% elif doc.origin == 'C5' %}bg-orange-50 text-orange-700
                                    {% elif doc.origin == 'C6' %}bg-teal-50 text-teal-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ doc.origin[:2] }}
                                </span>
                            </div>
                            {% if doc.title %}
                            <p class="text-sm text-gray-600 truncate" title="{{ doc.title }}">{{ doc.title }}</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <a href="{{ doc.un_url }}" target="_blank"
                               class="text-xs text-muted hover:text-un-blue transition-colors">
                                View PDF
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Signal Summary -->
                <div class="px-4 py-3">
                    <div class="flex flex-wrap gap-2">
                        {% for signal, count in doc.signal_summary.items() %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                            {% if signal == 'agenda' %}bg-blue-100 text-blue-800
                            {% elif signal == 'PGA' %}bg-purple-100 text-purple-800
                            {% elif signal == 'process' %}bg-amber-100 text-amber-800
                            {% elif signal == 'report' %}bg-green-100 text-green-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ signal }} ({{ count }})
                        </span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Expandable Content -->
                <div class="border-t border-gray-200 hidden expandable-content" id="content-{{ loop.index }}">
                    <div class="px-4 py-3 space-y-3">
                        {% if doc.signal_paragraphs %}
                        <!-- Detailed paragraph view (for current session) -->
                        {% for para in doc.signal_paragraphs %}
                        <div class="border-l-2 border-gray-300 pl-3 para-item" data-signals="{{ para.signals|join(',') }}">
                            <div class="text-xs text-gray-500 mb-1">Paragraph {{ para.number }}</div>
                            <p class="text-sm text-gray-900">{{ para.text }}</p>
                            <div class="flex flex-wrap gap-1 mt-2">
                                {% for signal in para.signals %}
                                <span class="px-1.5 py-0.5 rounded text-xs font-medium
                                    {% if signal == 'agenda' %}bg-blue-100 text-blue-800
                                    {% elif signal == 'PGA' %}bg-purple-100 text-purple-800
                                    {% elif signal == 'process' %}bg-amber-100 text-amber-800
                                    {% elif signal == 'report' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ signal }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        {% elif doc.signals %}
                        <!-- Summary view (for historical sessions) -->
                        <div class="text-sm text-gray-700 mb-3">
                            <strong>Signal Summary:</strong> This document contains signals in {{ doc.signals|length }} paragraph{{ 's' if doc.signals|length != 1 else '' }}.
                        </div>
                        {% for para_num, signals in doc.signals.items() %}
                        <div class="border-l-2 border-gray-300 pl-3 para-item" data-signals="{{ signals|join(',') }}">
                            <div class="text-xs text-gray-500 mb-1">Paragraph {{ para_num }}</div>
                            <div class="text-sm text-gray-600 italic">Detailed text not available for historical sessions</div>
                            <div class="flex flex-wrap gap-1 mt-2">
                                {% for signal in signals %}
                                <span class="px-1.5 py-0.5 rounded text-xs font-medium
                                    {% if signal == 'agenda' %}bg-blue-100 text-blue-800
                                    {% elif signal == 'PGA' %}bg-purple-100 text-purple-800
                                    {% elif signal == 'process' %}bg-amber-100 text-amber-800
                                    {% elif signal == 'report' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ signal }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <!-- No signal data available -->
                        <div class="text-sm text-gray-500 italic">
                            No signal data available for this document.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Empty State -->
        <div class="hidden text-center py-12" id="empty-state">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No documents found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or search terms.</p>
        </div>
    </div>

    <!-- Document Detail Panel -->
    <div class="w-80 flex-shrink-0 hidden" id="detail-panel">
        <div class="bg-white border border-gray-200 rounded-lg p-4 sticky top-4">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="detail-title">Document Details</h3>
            <div id="detail-content">
                <p class="text-sm text-gray-500">Select a document to view details</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="loading-overlay">
    <div class="bg-white rounded-lg p-6 flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-un-blue"></div>
        <span class="text-sm text-gray-700">Loading session data...</span>
    </div>
</div>

<script>
// Session data cache
let sessionDataCache = {};
let selectedSessions = ['current'];
let originalDocumentsHTML = '';

// Filter elements (initialized later)
let sourceFilter, signalFilter, doctypeFilter, clearFiltersBtn;

// Filter functionality
function applyFilters() {
    const selectedSources = Array.from(sourceFilter.selectedOptions).map(opt => opt.value);
    const selectedSignals = Array.from(signalFilter.selectedOptions).map(opt => opt.value);
    const selectedDoctypes = Array.from(doctypeFilter.selectedOptions).map(opt => opt.value);
    const searchQuery = document.getElementById('search-input').value.toLowerCase();

    const documentCards = document.querySelectorAll('.document-card');
    const emptyState = document.getElementById('empty-state');
    const statsText = document.getElementById('stats-text');

    let resolutionCount = 0;
    let proposalCount = 0;
    let paragraphCount = 0;

    documentCards.forEach(card => {
        const cardSource = card.dataset.source;
        const cardDoctype = card.dataset.doctype;
        const cardSignals = card.dataset.signals.split(',').filter(s => s);
        const cardSymbol = card.dataset.symbol.toLowerCase();
        const cardTitle = (card.dataset.title || '').toLowerCase();

        // Check filters
        const sourceMatch = selectedSources.length === 0 || selectedSources.includes(cardSource);
        const signalMatch = selectedSignals.length === 0 || selectedSignals.some(s => cardSignals.includes(s));
        const doctypeMatch = selectedDoctypes.length === 0 || selectedDoctypes.includes(cardDoctype);
        const searchMatch = searchQuery === '' ||
            cardSymbol.includes(searchQuery) ||
            cardTitle.includes(searchQuery);

        if (sourceMatch && signalMatch && doctypeMatch && searchMatch) {
            card.classList.remove('hidden');
            if (cardDoctype === 'resolution') {
                resolutionCount++;
            } else {
                proposalCount++;
            }

            // Count visible paragraphs
            const paragraphs = card.querySelectorAll('.para-item');
            paragraphs.forEach(para => {
                const paraSignals = para.dataset.signals.split(',').filter(s => s);
                if (selectedSignals.length === 0 || selectedSignals.some(s => paraSignals.includes(s))) {
                    para.classList.remove('hidden');
                    paragraphCount++;
                } else {
                    para.classList.add('hidden');
                }
            });
        } else {
            card.classList.add('hidden');
        }
    });

    // Show/hide empty state
    const visibleCount = resolutionCount + proposalCount;
    if (visibleCount === 0) {
        emptyState.classList.remove('hidden');
        document.getElementById('documents-container').classList.add('hidden');
    } else {
        emptyState.classList.add('hidden');
        document.getElementById('documents-container').classList.remove('hidden');
    }

    // Update stats
    const parts = [];
    if (resolutionCount > 0) {
        parts.push(`${resolutionCount} resolution${resolutionCount !== 1 ? 's' : ''}`);
    }
    if (proposalCount > 0) {
        parts.push(`${proposalCount} non-adopted proposal${proposalCount !== 1 ? 's' : ''}`);
    }
    statsText.textContent = parts.length > 0 ? `${paragraphCount} paragraphs across ${parts.join(' and ')}` : '0 documents';
}

const basePath = window.location.pathname.replace(/\/[^/]*$/, '');

function getSessionDataUrl(session) {
    if (session === 'current') {
        return `${basePath}/data.json`;
    }
    return `${basePath}/sessions/${session}/data.json`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function buildSignalParagraphs(doc) {
    const paragraphs = doc.paragraphs || {};
    const signals = doc.signals || {};
    const signalParagraphs = [];

    Object.entries(signals).forEach(([paraNum, paraSignals]) => {
        if (!paraSignals || paraSignals.length === 0) {
            return;
        }
        signalParagraphs.push({
            number: paraNum,
            text: paragraphs[paraNum] || '',
            signals: paraSignals,
        });
    });

    signalParagraphs.sort((a, b) => Number(a.number) - Number(b.number));
    return signalParagraphs;
}

function buildSignalSummary(signalParagraphs) {
    const summary = {};
    signalParagraphs.forEach(para => {
        (para.signals || []).forEach(signal => {
            summary[signal] = (summary[signal] || 0) + 1;
        });
    });
    return summary;
}

function normalizeDocument(doc, session) {
    const signalParagraphs = doc.signal_paragraphs || buildSignalParagraphs(doc);
    const signalSummary = doc.signal_summary && Object.keys(doc.signal_summary).length > 0
        ? doc.signal_summary
        : buildSignalSummary(signalParagraphs);

    return {
        ...doc,
        session,
        signal_paragraphs: signalParagraphs,
        signal_summary: signalSummary,
    };
}

function getSessionSortValue(session) {
    if (session === 'current') {
        return Number.MAX_SAFE_INTEGER;
    }
    const parsed = Number.parseInt(session, 10);
    return Number.isNaN(parsed) ? -1 : parsed;
}

// Initialize the explorer
document.addEventListener('DOMContentLoaded', function() {
    // Store original document HTML for current session
    originalDocumentsHTML = document.getElementById('documents-container').innerHTML;

    initializeFilters();
    initializeSearch();
    initializeSessionSelector();
    initializeDetailPanel();
});

// Session selector
function initializeSessionSelector() {
    const sessionSelector = document.getElementById('session-selector');

    // Populate session options dynamically
    populateSessionOptions(sessionSelector).then(() => {
        loadSelectedSessions();
    });

    sessionSelector.addEventListener('change', function() {
        const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
        selectedSessions = selectedOptions;
        loadSelectedSessions();
    });
}

// Populate session selector with available sessions
async function populateSessionOptions(selector) {
    // Clear existing options except the current session option
    const currentOption = selector.querySelector('option[value="current"]');
    selector.innerHTML = '';

    // Re-add current session option
    if (currentOption) {
        selector.appendChild(currentOption);
    } else {
        const newCurrentOption = document.createElement('option');
        newCurrentOption.value = 'current';
        newCurrentOption.textContent = 'Current Session';
        newCurrentOption.selected = true;
        selector.appendChild(newCurrentOption);
    }

    // Check which session directories exist (in reverse chronological order)
    const availableSessions = [79, 78, 77, 76, 75];

    for (const session of availableSessions) {
        try {
            // Check if session data exists
            const response = await fetch(getSessionDataUrl(session.toString()), { method: 'HEAD' });
            if (response.ok) {
                const option = document.createElement('option');
                option.value = session.toString();
                option.textContent = `Session ${session}`;
                option.selected = true;
                selector.appendChild(option);
            }
        } catch (error) {
            // Session not available, skip
            console.log(`Session ${session} not available`);
        }
    }

    // Select all available sessions by default
    selectedSessions = Array.from(selector.options).map(option => option.value);
}

// Load all selected sessions and combine their documents
async function loadSelectedSessions() {
    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.classList.remove('hidden');

    try {
        const allDocuments = [];

        for (const session of selectedSessions) {
            const sessionKey = session.toString();

            // Load session data via AJAX
            if (!sessionDataCache[sessionKey]) {
                const response = await fetch(getSessionDataUrl(sessionKey));
                if (!response.ok) throw new Error(`Failed to load session ${sessionKey} data`);
                sessionDataCache[sessionKey] = await response.json();
            }

            // Add session documents with session identifier
            const sessionData = sessionDataCache[sessionKey];
            if (!sessionData.documents || !Array.isArray(sessionData.documents)) {
                console.error(`Invalid session data format for ${sessionKey}: missing documents array`);
                continue;
            }

            const sessionDocs = sessionData.documents
                .map(doc => normalizeDocument(doc, sessionKey))
                .filter(doc => doc.signal_paragraphs.length > 0 || Object.keys(doc.signal_summary || {}).length > 0);

            allDocuments.push(...sessionDocs);
        }

        // If only current session is selected, restore original HTML
        if (selectedSessions.length === 1 && selectedSessions[0] === 'current') {
            document.getElementById('documents-container').innerHTML = originalDocumentsHTML;
            initializeDocumentCards();
            applyFilters();
        } else {
            // Render combined documents from selected sessions
            renderCombinedDocuments(allDocuments);
        }

    } catch (error) {
        console.error('Error loading selected sessions:', error);
        alert('Failed to load session data. Please try again.');
    } finally {
        loadingOverlay.classList.add('hidden');
    }
}

// Render documents from multiple sessions
function renderCombinedDocuments(allDocuments) {
    // Sort documents by our unified sorting logic
    allDocuments.sort((a, b) => {
        const sessionA = getSessionSortValue(a.session);
        const sessionB = getSessionSortValue(b.session);
        if (sessionA !== sessionB) {
            return sessionB - sessionA;
        }
        const aKey = `${a.symbol}`;
        const bKey = `${b.symbol}`;
        return aKey.localeCompare(bKey);
    });

    const container = document.getElementById('documents-container');

    const html = allDocuments.map(doc => {
        const signalParagraphs = doc.signal_paragraphs || [];
        const sessionLabel = doc.session === 'current' ? 'Current' : doc.session;
        const title = escapeHtml(doc.title || '');
        const symbol = escapeHtml(doc.symbol || '');

        const summaryHtml = Object.entries(doc.signal_summary || {}).map(([signal, count]) =>
            `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getSignalColor(signal)}">
                ${signal} (${count})
            </span>`
        ).join('');

        const paragraphsHtml = signalParagraphs.length
            ? signalParagraphs.map(para => `
                <div class="border-l-2 border-gray-300 pl-3 para-item" data-signals="${(para.signals || []).join(',')}">
                    <div class="text-xs text-gray-500 mb-1">Paragraph ${escapeHtml(para.number)}</div>
                    <p class="text-sm text-gray-900">${escapeHtml(para.text)}</p>
                    <div class="flex flex-wrap gap-1 mt-2">
                        ${(para.signals || []).map(signal => `
                            <span class="px-1.5 py-0.5 rounded text-xs font-medium ${getSignalColor(signal)}">${signal}</span>
                        `).join('')}
                    </div>
                </div>
            `).join('')
            : '<div class="text-sm text-gray-500 italic">No signal data available for this document.</div>';

        return `
            <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors${doc.doc_type === 'proposal' ? ' border-l-4 border-l-amber-400' : ''}"
                 data-symbol="${doc.symbol}"
                 data-source="${doc.origin || doc.source || ''}"
                 data-doctype="${doc.doc_type}"
                 data-signals="${Object.keys(doc.signal_summary || {}).join(',')}"
                 data-session="${doc.session}"
                 data-un-url="${doc.un_url || ''}"
                 data-title="${doc.title || ''}">
                <!-- Document Header -->
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="font-semibold text-gray-900">
                                    ${symbol}
                                </span>
                                ${doc.doc_type === 'proposal' ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Proposal</span>' : ''}
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">${sessionLabel}</span>
                            </div>
                            ${doc.title ? `<p class="text-sm text-gray-600 truncate" title="${title}">${title}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${doc.un_url ? `<a href="${doc.un_url}" target="_blank" class="text-xs text-muted hover:text-un-blue transition-colors">View PDF</a>` : ''}
                        </div>
                    </div>
                </div>

                <!-- Signal Summary -->
                <div class="px-4 py-3">
                    <div class="flex flex-wrap gap-2">
                        ${summaryHtml || '<span class="text-xs text-gray-500 italic">No signals</span>'}
                    </div>
                </div>

                <!-- Expandable Content -->
                <div class="border-t border-gray-200 hidden expandable-content">
                    <div class="px-4 py-3 space-y-3">
                        ${paragraphsHtml}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
    initializeDocumentCards();
    applyFilters();
}



// Helper functions
function getOriginColor(origin) {
    const colors = {
        'Plenary': 'bg-amber-50 text-amber-700',
        'C1': 'bg-red-50 text-red-700',
        'C2': 'bg-green-50 text-green-700',
        'C3': 'bg-blue-50 text-blue-700',
        'C4': 'bg-purple-50 text-purple-700',
        'C5': 'bg-orange-50 text-orange-700',
        'C6': 'bg-teal-50 text-teal-700'
    };
    return colors[origin] || 'bg-gray-100 text-gray-700';
}

function getSignalColor(signal) {
    const colors = {
        'agenda': 'bg-blue-100 text-blue-800',
        'PGA': 'bg-purple-100 text-purple-800',
        'process': 'bg-amber-100 text-amber-800',
        'report': 'bg-green-100 text-green-800'
    };
    return colors[signal] || 'bg-gray-100 text-gray-800';
}

// Search functionality
function initializeSearch() {
    const searchInput = document.getElementById('search-input');

    searchInput.addEventListener('input', function() {
        applyFilters();
    });
}

// Filter functionality (similar to original but with search)
function initializeFilters() {
    sourceFilter = document.getElementById('source-filter');
    signalFilter = document.getElementById('signal-filter');
    doctypeFilter = document.getElementById('doctype-filter');
    clearFiltersBtn = document.getElementById('clear-filters');



    // Event listeners
    sourceFilter.addEventListener('change', applyFilters);
    signalFilter.addEventListener('change', applyFilters);
    doctypeFilter.addEventListener('change', applyFilters);

    clearFiltersBtn.addEventListener('click', function() {
        Array.from(sourceFilter.options).forEach(opt => opt.selected = false);
        Array.from(signalFilter.options).forEach(opt => opt.selected = false);
        Array.from(doctypeFilter.options).forEach(opt => opt.selected = false);
        document.getElementById('search-input').value = '';
        applyFilters();
    });
}

// Document card interactions
function initializeDocumentCards() {
    const documentCards = document.querySelectorAll('.document-card');

    documentCards.forEach(card => {
        card.addEventListener('click', function() {
            // Toggle expanded content
            const content = this.querySelector('.expandable-content');
            if (!content) {
                return;
            }
            const isExpanded = !content.classList.contains('hidden');

            // Hide all expanded content first
            document.querySelectorAll('.document-card .expandable-content').forEach(div => {
                div.classList.add('hidden');
            });

            // Show clicked content if it wasn't already expanded
            if (!isExpanded) {
                content.classList.remove('hidden');
            }

            // Update detail panel
            updateDetailPanel(this.dataset);
        });
    });
}

// Detail panel
function initializeDetailPanel() {
    // Initially hidden
}

function updateDetailPanel(data) {
    const detailPanel = document.getElementById('detail-panel');
    const detailContent = document.getElementById('detail-content');

    if (data.symbol) {
        detailContent.innerHTML = `
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-900">${data.symbol}</h4>
                    ${data.title ? `<p class="text-sm text-gray-600 mt-1">${data.title}</p>` : ''}
                </div>
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wide">Source</span>
                    <p class="text-sm text-gray-900 mt-1">${data.source}</p>
                </div>
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wide">Type</span>
                    <p class="text-sm text-gray-900 mt-1">${data.doctype}</p>
                </div>
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wide">Signals</span>
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${data.signals.split(',').filter(s => s).map(signal =>
                            `<span class="px-2 py-1 rounded-full text-xs font-medium ${getSignalColor(signal)}">${signal}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="pt-2">
                    <a href="${data.unUrl}" target="_blank" class="text-sm text-un-blue hover:underline">View PDF →</a>
                </div>
            </div>
        `;
        detailPanel.classList.remove('hidden');
    } else {
        detailPanel.classList.add('hidden');
    }
}

// Initialize document cards on page load
initializeDocumentCards();
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }} · <a href="./data.json" class="text-un-blue hover:underline">JSON API</a>
{% endblock %}