{% extends "base.html" %}

{% block title %}Signal Browser - Mandate Pipeline{% endblock %}

{% block content %}
<!-- Header (hidden per UX requirements) -->
<div class="mb-4 hidden">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Signal Browser</h1>
</div>


<div class="sticky top-20 z-10 space-y-2 bg-white/95 pb-2 backdrop-blur">
    <!-- Search -->
    <div class="rounded-lg border border-gray-200 bg-gray-50/80 p-2 shadow-sm">
        <input type="text" id="search-input" placeholder="Search by symbol, title, or content..."
               class="w-full px-3 py-1.5 border border-gray-300 rounded-md bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
    </div>

    <!-- Filters - Compact Layout -->
    <div class="rounded-lg border border-gray-200 bg-white p-2 shadow-sm">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-start">
            <!-- Adoption Session (default: 80th) -->
            <div>
                <label for="session-selector" class="block text-[10px] font-semibold uppercase tracking-wide text-gray-500 mb-1">Session</label>
                <select id="session-selector" class="w-full px-2 py-1 border border-gray-300 rounded-md bg-white text-xs shadow-sm focus:outline-none focus:ring-1 focus:ring-un-blue">
                    <option value="80" selected>80th</option>
                    <option value="79">79th</option>
                    <option value="78">78th</option>
                    <option value="77">77th</option>
                    <option value="76">76th</option>
                    <option value="75">75th</option>
                </select>
            </div>
            
            <!-- Implementation Session - Multiselect -->
            <div>
                <label for="implementation-filter" class="block text-[10px] font-semibold uppercase tracking-wide text-gray-500 mb-1">Implementation</label>
                <select id="implementation-filter" multiple size="3" aria-label="Select multiple implementation sessions" aria-multiselectable="true" class="w-full px-2 py-1 border border-gray-300 rounded-md bg-white text-xs shadow-sm focus:outline-none focus:ring-1 focus:ring-un-blue">
                    {% for session in [85, 84, 83, 82, 81, 80] %}
                    <option value="{{ session }}">{{ session }}th</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Signal - Multiselect -->
            <div>
                <label for="signal-filter" class="block text-[10px] font-semibold uppercase tracking-wide text-gray-500 mb-1">Signal</label>
                <select id="signal-filter" multiple size="3" aria-label="Select multiple signal types" aria-multiselectable="true" class="w-full px-2 py-1 border border-gray-300 rounded-md bg-white text-xs shadow-sm focus:outline-none focus:ring-1 focus:ring-un-blue">
                    {% for check in checks %}
                    <option value="{{ check.signal }}">{{ check.signal }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Source - Multiselect -->
            <div>
                <label for="source-filter" class="block text-[10px] font-semibold uppercase tracking-wide text-gray-500 mb-1">Source</label>
                <select id="source-filter" multiple size="3" aria-label="Select multiple sources" aria-multiselectable="true" class="w-full px-2 py-1 border border-gray-300 rounded-md bg-white text-xs shadow-sm focus:outline-none focus:ring-1 focus:ring-un-blue">
                    {% for origin_code in origin_order %}
                    {% set origin_label = 'Pl' if origin_code == 'Plenary' else origin_code %}
                    <option value="{{ origin_code }}">{{ origin_label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Clear filters button (compact) -->
        <div class="mt-2 flex justify-end">
            <button id="clear-filters" class="px-3 py-1 text-xs font-medium text-gray-600 hover:text-gray-900 transition-colors">
                Clear filters
            </button>
        </div>
        
        <!-- Hidden filters (Status, Type, Group by Implementation) -->
        <div class="hidden">
            <div id="status-filter"></div>
            <div id="type-filter"></div>
            <button id="group-implementation"></button>
            <input id="include-no-signals" type="checkbox">
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div id="main-content">
    <!-- Document List -->
    <div id="document-list">
        <div class="space-y-4" id="documents-container">
            <!-- Documents will be loaded dynamically via JavaScript -->
        </div>

        <!-- Scroll Sentinel for IntersectionObserver (invisible) -->
        <div id="scroll-sentinel" class="h-4"></div>

        <!-- Loading Spinner for infinite scroll -->
        <div id="scroll-loading" class="hidden py-6 text-center">
            <div class="inline-flex items-center gap-2 text-sm text-gray-500">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-un-blue"></div>
                <span>Loading more documents...</span>
            </div>
        </div>

        <!-- Documents Count -->
        <div id="documents-count" class="py-4 text-center text-xs text-gray-500 hidden"></div>

        <!-- Empty State -->
        <div class="hidden text-center py-12" id="empty-state">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No documents found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or search terms.</p>
        </div>
    </div>

</div>

<!-- Loading Indicator -->
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="loading-overlay">
    <div class="bg-white rounded-lg p-6 flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-un-blue"></div>
        <span class="text-sm text-gray-700">Loading session data...</span>
    </div>
</div>

<script>
// ============================================
// URL CLEANUP - Redirect /index.html to /
// ============================================
(function() {
    const path = window.location.pathname;
    if (path.endsWith('/index.html')) {
        const newPath = path.replace(/\/index\.html$/, '/');
        const newUrl = newPath + window.location.search + window.location.hash;
        window.history.replaceState(null, '', newUrl);
    }
})();

// ============================================
// PERFORMANCE OPTIMIZATIONS
// ============================================

// Pagination configuration
const PAGE_SIZE = 50;
let currentPage = 0;
let filteredDocumentsCache = [];
let isLoadingMore = false;

// Session data cache
let sessionDataCache = {};
let selectedSessions = [];
let allDocumentsCache = [];

// DOM element caches (populated once on init)
let cachedDocumentsContainer = null;
let cachedEmptyState = null;
let cachedLoadMoreBtn = null;
let cachedLoadMoreContainer = null;
let cachedSearchInput = null;

const signalPhraseMap = Object.fromEntries(({{ checks | tojson }} || []).map(check => [check.signal, check.phrases || []]));
const implementationSessionMap = {
    '85': ['eighty-fifth', 'eighty fifth'],
    '84': ['eighty-fourth', 'eighty fourth'],
    '83': ['eighty-third', 'eighty third'],
    '82': ['eighty-second', 'eighty second'],
    '81': ['eighty-first', 'eighty first'],
    '80': ['eightieth']
};

// Filter elements (initialized later)
let sessionSelector, implementationFilter, sourceFilter, signalFilter, statusFilter, typeFilter;
let clearFiltersBtn, groupImplementationBtn, includeNoSignalsToggle;
let groupByImplementation = false;

// ============================================
// DEBOUNCE UTILITY
// ============================================
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Debounced filter application (300ms delay for search)
const debouncedApplyFilters = debounce(() => {
    requestAnimationFrame(() => applyFilters());
}, 300);

// Helper functions for multiselect dropdowns
function getSelectedValues(selectElement) {
    if (!selectElement) return [];
    if (selectElement.multiple) {
        return Array.from(selectElement.selectedOptions).map(opt => opt.value);
    } else {
        return selectElement.value ? [selectElement.value] : [];
    }
}

function setSelectedValues(selectElement, values) {
    if (!selectElement) return;
    const valueSet = new Set(values);
    if (selectElement.multiple) {
        Array.from(selectElement.options).forEach(opt => {
            opt.selected = valueSet.has(opt.value);
        });
    } else {
        selectElement.value = values.length > 0 ? values[0] : '';
    }
}

function getActiveValues(container) {
    // Support both select elements and legacy pill containers
    if (container.tagName === 'SELECT') {
        return getSelectedValues(container);
    }
    return Array.from(container.querySelectorAll('.filter-pill.is-active')).map(pill => pill.dataset.value);
}

function setActiveValues(container, values) {
    // Support both select elements and legacy pill containers  
    if (container.tagName === 'SELECT') {
        setSelectedValues(container, values);
    } else {
        const valueSet = new Set(values);
        container.querySelectorAll('.filter-pill').forEach(pill => {
            setPillActive(pill, valueSet.has(pill.dataset.value));
        });
    }
}

// Legacy pill functions (kept for backward compatibility if needed)
const activePillClasses = ['bg-un-blue', 'text-white', 'border-un-blue'];
const inactivePillClasses = ['border-gray-200', 'text-gray-600'];
const activeImplementationClasses = ['bg-indigo-600', 'text-white', 'border-indigo-600'];
const inactiveImplementationClasses = ['border-indigo-200', 'text-indigo-700', 'bg-indigo-50'];

function setPillActive(pill, isActive) {
    const isImplementation = pill.dataset.pill === 'implementation';
    const activeClasses = isImplementation ? activeImplementationClasses : activePillClasses;
    const inactiveClasses = isImplementation ? inactiveImplementationClasses : inactivePillClasses;

    pill.classList.toggle('is-active', isActive);
    activeClasses.forEach(cls => pill.classList.toggle(cls, isActive));
    inactiveClasses.forEach(cls => pill.classList.toggle(cls, !isActive));
}

function wirePillGroup(container, onChange) {
    container.addEventListener('click', event => {
        const target = event.target.closest('.filter-pill');
        if (!target) {
            return;
        }
        setPillActive(target, !target.classList.contains('is-active'));
        onChange();
    });
}

function updateUrlState() {
    const params = new URLSearchParams();
    const searchQuery = document.getElementById('search-input').value.trim();

    if (searchQuery) {
        params.set('q', searchQuery);
    }

    const sessions = getActiveValues(sessionSelector);
    selectedSessions = sessions;
    const implementations = getActiveValues(implementationFilter);
    const sources = getActiveValues(sourceFilter);
    const signals = getActiveValues(signalFilter);
    const statuses = getActiveValues(statusFilter);
    const types = getActiveValues(typeFilter);
    const includeNoSignals = includeNoSignalsToggle && includeNoSignalsToggle.checked;

    if (sessions.length > 0) {
        params.set('sessions', sessions.join(','));
    }
    if (implementations.length > 0) {
        params.set('implementation', implementations.join(','));
    }
    if (sources.length > 0) {
        params.set('sources', sources.join(','));
    }
    if (signals.length > 0) {
        params.set('signals', signals.join(','));
    }
    if (statuses.length > 0) {
        params.set('status', statuses.join(','));
    }
    if (types.length > 0) {
        params.set('type', types.join(','));
    }
    if (includeNoSignals) {
        params.set('include', 'all');
    }
    if (groupByImplementation) {
        params.set('group', 'implementation');
    }

    const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
    window.history.replaceState({}, '', newUrl);
}

function applyFiltersFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const searchQuery = params.get('q') || '';
    document.getElementById('search-input').value = searchQuery;

    const sessions = params.get('sessions');
    const sources = params.get('sources');
    const signals = params.get('signals');
    const statuses = params.get('status');
    const implementations = params.get('implementation');
    const group = params.get('group');
    const types = params.get('type');
    const include = params.get('include');

    if (sessions) {
        setActiveValues(sessionSelector, sessions.split(','));
    }
    if (implementations) {
        setActiveValues(implementationFilter, implementations.split(','));
    }
    if (sources) {
        setActiveValues(sourceFilter, sources.split(','));
    }
    if (signals) {
        setActiveValues(signalFilter, signals.split(','));
    }
    if (statuses) {
        setActiveValues(statusFilter, statuses.split(','));
    }
    if (types) {
        setActiveValues(typeFilter, types.split(','));
    }

    if (includeNoSignalsToggle) {
        includeNoSignalsToggle.checked = include === 'all';
    }

    groupByImplementation = group === 'implementation';
    if (groupImplementationBtn) {
        groupImplementationBtn.classList.toggle('bg-indigo-600', groupByImplementation);
        groupImplementationBtn.classList.toggle('text-white', groupByImplementation);
        groupImplementationBtn.classList.toggle('border-indigo-600', groupByImplementation);
        groupImplementationBtn.classList.toggle('bg-indigo-50', !groupByImplementation);
        groupImplementationBtn.classList.toggle('text-indigo-700', !groupByImplementation);
        groupImplementationBtn.classList.toggle('border-indigo-200', !groupByImplementation);
    }

    selectedSessions = getActiveValues(sessionSelector);
}

// ============================================
// OPTIMIZED FILTERING (works with pagination)
// ============================================

// Check if a document matches current filters (operates on data, not DOM)
function documentMatchesFilters(doc, filters) {
    const {
        selectedSources,
        selectedSignals,
        selectedStatuses,
        selectedImplementations,
        selectedSessions,
        selectedTypes,
        includeNoSignals,
        searchQuery,
    } = filters;

    // Source filter
    const docSource = doc.origin || doc.source || '';
    if (selectedSources.length > 0 && !selectedSources.includes(docSource)) {
        return false;
    }

    // Status filter
    const docStatus = doc.doc_type === 'resolution'
        ? 'adopted'
        : (doc.doc_type === 'proposal' ? 'draft' : 'decision');
    if (selectedStatuses.length > 0 && !selectedStatuses.includes(docStatus)) {
        return false;
    }

    // Session filter
    const docSession = doc.session ? doc.session.toString() : '';
    if (selectedSessions.length > 0 && !selectedSessions.includes(docSession)) {
        return false;
    }

    // Type filter
    const docType = doc.doc_type || '';
    if (selectedTypes.length > 0 && !selectedTypes.includes(docType)) {
        return false;
    }

    const hasSignals = (doc.signal_paragraphs && doc.signal_paragraphs.length > 0)
        || (doc.signal_summary && Object.keys(doc.signal_summary).length > 0);
    if (!hasSignals && (!includeNoSignals || selectedSignals.length > 0)) {
        return false;
    }

    const paragraphs = doc.signal_paragraphs || [];
    if (paragraphs.length === 0) {
        const baseText = `${doc.symbol || ''} ${doc.title || ''} ${doc.decision_text || ''}`.toLowerCase();
        const searchMatch = searchQuery === '' || baseText.includes(searchQuery);
        const implementationMatch = selectedImplementations.length === 0;
        const signalMatch = selectedSignals.length === 0;
        return searchMatch && implementationMatch && signalMatch;
    }

    for (const para of paragraphs) {
        const paraSignals = para.signals || [];
        const paraText = (para.text || '').toLowerCase();

        const signalMatch = selectedSignals.length === 0 || selectedSignals.some(s => paraSignals.includes(s));
        const searchMatch = searchQuery === '' || paraText.includes(searchQuery) ||
                           (doc.symbol || '').toLowerCase().includes(searchQuery) ||
                           (doc.title || '').toLowerCase().includes(searchQuery);
        const implementationMatch = selectedImplementations.length === 0 || selectedImplementations.some(session => {
            const phrases = implementationSessionMap[session] || [];
            return phrases.some(phrase => paraText.includes(phrase));
        });

        if (signalMatch && searchMatch && implementationMatch) {
            return true;
        }
    }

    return false;
}

// Filter functionality (optimized for pagination)
function applyFilters() {
    const selectedSources = getActiveValues(sourceFilter);
    const selectedSignals = getActiveValues(signalFilter);
    const selectedStatuses = getActiveValues(statusFilter);
    const selectedImplementations = getActiveValues(implementationFilter);
    const selectedTypes = getActiveValues(typeFilter);
    const includeNoSignals = includeNoSignalsToggle && includeNoSignalsToggle.checked;
    selectedSessions = getActiveValues(sessionSelector);
    const searchQuery = (cachedSearchInput || document.getElementById('search-input')).value.toLowerCase();

    const filters = {
        selectedSources,
        selectedSignals,
        selectedStatuses,
        selectedImplementations,
        selectedSessions,
        selectedTypes,
        includeNoSignals,
        searchQuery,
    };

    // Filter documents from cache (not DOM)
    filteredDocumentsCache = allDocumentsCache.filter(doc => documentMatchesFilters(doc, filters));

    // Reset pagination
    currentPage = 0;

    // Re-render first page of filtered documents
    const container = cachedDocumentsContainer || document.getElementById('documents-container');
    const emptyState = cachedEmptyState || document.getElementById('empty-state');

    if (filteredDocumentsCache.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        container.classList.add('hidden');
        updateDocumentsCount();
        updateUrlState();
        return;
    }

    emptyState.classList.add('hidden');
    container.classList.remove('hidden');

    // Render first page
    const firstPageDocs = filteredDocumentsCache.slice(0, PAGE_SIZE);

    requestAnimationFrame(() => {
        container.innerHTML = firstPageDocs.map(doc => renderDocumentCard(doc, true)).join('');
        initializeDocumentCards();
        initializeInfiniteScroll();
        updateDocumentsCount();

        // Apply highlights to visible content
        applySignalHighlights();
        applyImplementationHighlights();
        applySearchHighlights(searchQuery);
    });

    updateUrlState();
}

function getImplementationSessionForText(text) {
    const lowered = text.toLowerCase();
    const orderedSessions = Object.keys(implementationSessionMap).sort((a, b) => Number(b) - Number(a));
    for (const session of orderedSessions) {
        const phrases = implementationSessionMap[session] || [];
        if (phrases.some(phrase => lowered.includes(phrase))) {
            return session;
        }
    }
    return null;
}

function getImplementationSessionForDoc(doc) {
    const paragraphTexts = [];

    if (Array.isArray(doc.signal_paragraphs)) {
        doc.signal_paragraphs.forEach(para => {
            if (para.text) {
                paragraphTexts.push(para.text);
            }
        });
    }

    if (paragraphTexts.length === 0 && doc.paragraphs) {
        Object.values(doc.paragraphs).forEach(text => {
            if (text) {
                paragraphTexts.push(text);
            }
        });
    }

    const combinedText = paragraphTexts.join(' ');
    return combinedText ? getImplementationSessionForText(combinedText) : null;
}

const basePath = window.location.pathname.replace(/\/[^/]*$/, '');

function getSessionDataUrl(session) {
    if (session === 'current' || session === '80') {
        return `${basePath}/data.json`;
    }
    return `${basePath}/sessions/${session}/data.json`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function applySearchHighlights(query) {
    const highlightTargets = document.querySelectorAll('[data-search]');
    const trimmedQuery = query.trim();

    highlightTargets.forEach(target => {
        target.querySelectorAll('mark.search-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        if (!trimmedQuery) {
            return;
        }

        highlightQueryInElement(target, trimmedQuery, 'search-highlight bg-red-100 text-red-900 rounded px-0.5');
    });
}

function highlightQueryInElement(element, query, className) {
    const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(escapedQuery, 'gi');
    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null);
    const textNodes = [];

    while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
    }

    textNodes.forEach(node => {
        const text = node.nodeValue;
        if (!text || !regex.test(text)) {
            return;
        }
        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        text.replace(regex, (match, index) => {
            fragment.appendChild(document.createTextNode(text.slice(lastIndex, index)));
            const mark = document.createElement('mark');
            mark.className = className;
            mark.textContent = match;
            fragment.appendChild(mark);
            lastIndex = index + match.length;
            return match;
        });
        fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
        node.parentNode.replaceChild(fragment, node);
    });
}

function applySignalHighlights() {
    const paragraphTargets = document.querySelectorAll('[data-paragraph]');

    paragraphTargets.forEach(target => {
        target.querySelectorAll('mark.signal-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        const paraItem = target.closest('.para-item');
        const signals = paraItem ? paraItem.dataset.signals.split(',').filter(Boolean) : [];

        signals.forEach(signal => {
            const phrases = signalPhraseMap[signal] || [];
            phrases.sort((a, b) => b.length - a.length).forEach(phrase => {
                highlightQueryInElement(target, phrase, `signal-highlight ${getSignalHighlightClass(signal)} rounded px-0.5`);
            });
        });
    });
}

function applyImplementationHighlights() {
    const paragraphTargets = document.querySelectorAll('[data-paragraph]');

    paragraphTargets.forEach(target => {
        target.querySelectorAll('mark.implementation-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        Object.values(implementationSessionMap).forEach(phrases => {
            phrases.forEach(phrase => {
                highlightQueryInElement(target, phrase, 'implementation-highlight bg-indigo-100 text-indigo-900 rounded px-0.5');
            });
        });
    });
}

function buildSignalParagraphs(doc) {
    const paragraphs = doc.paragraphs || {};
    const signals = doc.signals || {};
    const signalParagraphs = [];

    Object.entries(signals).forEach(([paraNum, paraSignals]) => {
        if (!paraSignals || paraSignals.length === 0) {
            return;
        }
        signalParagraphs.push({
            number: paraNum,
            text: paragraphs[paraNum] || '',
            signals: paraSignals,
        });
    });

    signalParagraphs.sort((a, b) => Number(a.number) - Number(b.number));
    return signalParagraphs;
}

function buildSignalSummary(signalParagraphs) {
    const summary = {};
    signalParagraphs.forEach(para => {
        (para.signals || []).forEach(signal => {
            summary[signal] = (summary[signal] || 0) + 1;
        });
    });
    return summary;
}

function normalizeDocument(doc, session) {
    const signalParagraphs = doc.signal_paragraphs || buildSignalParagraphs(doc);
    const signalSummary = doc.signal_summary && Object.keys(doc.signal_summary).length > 0
        ? doc.signal_summary
        : buildSignalSummary(signalParagraphs);
    const derivedSession = doc.session || getSessionFromSymbol(doc.symbol);
    const docType = doc.doc_type || (doc.symbol && doc.symbol.includes('/RES/') ? 'resolution' : (doc.symbol && doc.symbol.includes('/L.') ? 'proposal' : ''));

    return {
        ...doc,
        session: derivedSession || session,
        doc_type: docType,
        signal_paragraphs: signalParagraphs,
        signal_summary: signalSummary,
    };
}

function getSessionFromSymbol(symbol) {
    if (!symbol) {
        return null;
    }
    const resMatch = symbol.match(/^A\/RES\/(\d+)/);
    if (resMatch) {
        return resMatch[1];
    }
    const committeeMatch = symbol.match(/^A\/C\.\d+\/(\d+)\/L\./);
    if (committeeMatch) {
        return committeeMatch[1];
    }
    const plenaryMatch = symbol.match(/^A\/(\d+)\/L\./);
    if (plenaryMatch) {
        return plenaryMatch[1];
    }
    return null;
}

function getDisplayTitle(doc) {
    if (!doc.title) {
        return '';
    }
    const parts = (doc.symbol || '').split('/');
    const numberPart = parts.length >= 2 ? `${parts[parts.length - 2]}/${parts[parts.length - 1]}` : '';
    if (numberPart && doc.title.startsWith(`${numberPart}. `)) {
        return doc.title.slice(numberPart.length + 2);
    }
    return doc.title;
}

function getSessionSortValue(session) {
    if (session === 'current') {
        return 80;
    }
    const parsed = Number.parseInt(session, 10);
    return Number.isNaN(parsed) ? -1 : parsed;
}

function getDocumentSortKey(doc) {
    const sessionValue = getSessionSortValue(doc.session);
    const symbol = doc.symbol || '';
    const isProposal = doc.doc_type === 'proposal' || symbol.includes('/L.');
    const isResolution = doc.doc_type === 'resolution' || symbol.includes('/RES/');
    const isDecision = doc.doc_type === 'decision';

    let categoryRank = 3;
    let committeeRank = 99;
    let docNumber = Number.MAX_SAFE_INTEGER;

    if (isProposal) {
        const plenaryMatch = symbol.match(/^A\/(\d+)\/L\.(\d+)/);
        if (plenaryMatch) {
            categoryRank = 0;
            docNumber = Number.parseInt(plenaryMatch[2], 10);
        } else {
            const committeeMatch = symbol.match(/^A\/C\.(\d+)\/(\d+)\/L\.(\d+)/);
            if (committeeMatch) {
                categoryRank = 1;
                committeeRank = Number.parseInt(committeeMatch[1], 10);
                docNumber = Number.parseInt(committeeMatch[3], 10);
            }
        }
    } else if (isResolution) {
        const resolutionMatch = symbol.match(/^A\/RES\/(\d+)\/(\d+)/);
        if (resolutionMatch) {
            categoryRank = 2;
            docNumber = Number.parseInt(resolutionMatch[2], 10);
        }
    } else if (isDecision) {
        const decisionMatch = symbol.match(/(\d+)(?!.*\d)/);
        if (decisionMatch) {
            categoryRank = 3;
            docNumber = Number.parseInt(decisionMatch[1], 10);
        }
    }

    return {
        sessionValue,
        categoryRank,
        committeeRank,
        docNumber,
        symbol,
    };
}

// Initialize the explorer
document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    initializeSearch();
    initializeSessionSelector();
});

// Session selector
function initializeSessionSelector() {
    sessionSelector = document.getElementById('session-selector');

    // Session selector is now a static select element, no need to populate dynamically
    // Apply filters from URL
    applyFiltersFromUrl();
    
    // Wire up the select element
    if (sessionSelector) {
        sessionSelector.addEventListener('change', () => {
            selectedSessions = getActiveValues(sessionSelector);
            loadSelectedSessions();
        });
    }
    
    // Set default selection to 80th session if none is set
    if (!selectedSessions || selectedSessions.length === 0) {
        selectedSessions = ['80'];
        setActiveValues(sessionSelector, ['80']);
    }
    
    loadSelectedSessions();
}

// Load all selected sessions and combine their documents
async function loadSelectedSessions() {
    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.classList.remove('hidden');

    try {
        const allDocuments = [];
        const sessionsToLoad = selectedSessions.length
            ? selectedSessions
            : ['80']; // Default to 80th session if none selected

        for (const session of sessionsToLoad) {
            const sessionKey = session.toString();

            // Load session data via AJAX
            if (!sessionDataCache[sessionKey]) {
                const response = await fetch(getSessionDataUrl(sessionKey));
                if (!response.ok) throw new Error(`Failed to load session ${sessionKey} data`);
                sessionDataCache[sessionKey] = await response.json();
            }

            // Add session documents with session identifier
            const sessionData = sessionDataCache[sessionKey];
            if (!sessionData.documents || !Array.isArray(sessionData.documents)) {
                console.error(`Invalid session data format for ${sessionKey}: missing documents array`);
                continue;
            }

            const allowNoSignals = includeNoSignalsToggle && includeNoSignalsToggle.checked;
            const sessionDocs = sessionData.documents
                .map(doc => normalizeDocument(doc, sessionKey))
                .filter(doc => {
                    const hasSignals = doc.signal_paragraphs.length > 0 || Object.keys(doc.signal_summary || {}).length > 0;
                    return allowNoSignals || hasSignals;
                });

            allDocuments.push(...sessionDocs);
        }

        const dedupedDocuments = [];
        const seenDocuments = new Set();
        allDocuments.forEach(doc => {
            const key = `${doc.session || ''}::${doc.doc_type || ''}::${doc.symbol || ''}`;
            if (seenDocuments.has(key)) {
                return;
            }
            seenDocuments.add(key);
            dedupedDocuments.push(doc);
        });

        // Render combined documents from selected sessions
        renderCombinedDocuments(dedupedDocuments);

    } catch (error) {
        console.error('Error loading selected sessions:', error);
        alert('Failed to load session data. Please try again.');
    } finally {
        loadingOverlay.classList.add('hidden');
    }
}

// ============================================
// DOCUMENT CARD RENDERING
// ============================================
function renderDocumentCard(doc, isCollapsed = true) {
    const signalParagraphs = doc.signal_paragraphs || [];
    const title = escapeHtml(getDisplayTitle(doc));
    const symbol = escapeHtml(doc.symbol || '');
    const hasSignals = signalParagraphs.length > 0 || Object.keys(doc.signal_summary || {}).length > 0;
    const paraCount = signalParagraphs.length;
    const isDecision = doc.doc_type === 'decision';
    const decisionText = escapeHtml(doc.decision_text || '');
    const metaItems = [];

    if (isDecision) {
        if (doc.meeting_date) metaItems.push(`Date ${escapeHtml(doc.meeting_date)}`);
        if (doc.meeting_number) metaItems.push(`Meeting ${escapeHtml(doc.meeting_number)}`);
        if (doc.agenda_item) metaItems.push(`Agenda ${escapeHtml(doc.agenda_item)}`);
        if (doc.session) metaItems.push(`Session ${escapeHtml(doc.session)}`);
    }

    const paragraphsHtml = signalParagraphs.length
        ? signalParagraphs.map(para => `
            <div class="para-item text-sm text-gray-900" data-signals="${(para.signals || []).join(',')}">
                <span class="inline-flex flex-wrap items-center gap-1">
                    ${(para.signals || []).map(signal => `
                        <span class="px-1.5 py-0.5 rounded-full text-xs font-medium ${getSignalColor(signal)}">${signal}</span>
                    `).join('')}
                </span>
                <span class="ml-1 font-semibold text-gray-700">${escapeHtml(para.number)}.</span>
                <span class="text-gray-800" data-paragraph data-search>${escapeHtml(para.text)}</span>
            </div>
        `).join('')
        : `
            <div class="para-item text-sm text-gray-900" data-signals="">
                <div class="text-xs font-semibold uppercase tracking-wide text-gray-400">No signals detected</div>
                ${decisionText
                    ? `<p class="text-gray-700 leading-relaxed mt-2" data-paragraph data-search>${decisionText}</p>`
                    : '<p class="text-gray-500 italic mt-2" data-paragraph data-search>No signal data available for this document.</p>'}
            </div>
        `;

    return `
        <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors${doc.doc_type === 'proposal' ? ' border-l-4 border-l-amber-400' : ''}${doc.doc_type === 'decision' ? ' border-l-4 border-l-slate-400' : ''}"
             data-symbol="${doc.symbol}"
             data-source="${doc.origin || doc.source || ''}"
             data-status="${doc.doc_type === 'resolution' ? 'adopted' : (doc.doc_type === 'proposal' ? 'draft' : 'decision')}"
             data-type="${doc.doc_type || ''}"
             data-has-signals="${hasSignals ? 'true' : 'false'}"
             data-signals="${Object.keys(doc.signal_summary || {}).join(',')}"
             data-session="${doc.session || ''}"
             data-un-url="${doc.un_url || ''}"
             data-igov-url="${doc.igov_url || ''}"
             data-title="${title}">
            <!-- Document Header (clickable to expand/collapse) -->
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 cursor-pointer doc-header" role="button" aria-expanded="${!isCollapsed}">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="font-semibold text-gray-900" data-search>
                                ${symbol}
                            </span>
                            ${isDecision ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700">Decision</span>' : ''}
                            ${!isDecision && doc.origin && doc.origin !== 'Unknown' && doc.origin !== 'IGov' ? `<span class="text-xs text-gray-500">Â· ${escapeHtml(doc.origin)}</span>` : ''}
                            ${doc.doc_type === 'proposal' ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Draft</span>' : ''}
                            <span class="text-xs text-gray-400">${paraCount} signal${paraCount !== 1 ? 's' : ''}</span>
                        </div>
                        ${title ? `<p class="text-sm text-gray-600 truncate" title="${title}" data-search>${title}</p>` : ''}
                        ${metaItems.length ? `<div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500">${metaItems.map(item => `<span>${item}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        ${isDecision && doc.igov_url ? `<a href="${doc.igov_url}" target="_blank" class="text-xs text-muted hover:text-un-blue transition-colors" onclick="event.stopPropagation()">View IGov</a>` : ''}
                        ${!isDecision && doc.un_url ? `<a href="${doc.un_url}" target="_blank" class="text-xs text-muted hover:text-un-blue transition-colors" onclick="event.stopPropagation()">View PDF</a>` : ''}
                        <svg class="expand-icon w-4 h-4 text-gray-400 transition-transform ${isCollapsed ? '' : 'rotate-180'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Paragraphs (collapsible) -->
            <div class="border-t border-gray-200 expandable-content ${isCollapsed ? 'hidden' : ''}">
                <div class="px-4 py-3 space-y-3">
                    ${paragraphsHtml}
                </div>
            </div>
        </div>
    `;
}

// ============================================
// INFINITE SCROLL WITH INTERSECTION OBSERVER
// ============================================

let scrollObserver = null;
let cachedScrollSentinel = null;
let cachedScrollLoading = null;
let cachedDocsCount = null;

// Update the documents count display
function updateDocumentsCount() {
    if (!cachedDocsCount) return;

    const totalFiltered = filteredDocumentsCache.length;
    const rendered = Math.min((currentPage + 1) * PAGE_SIZE, totalFiltered);

    if (totalFiltered > 0) {
        cachedDocsCount.classList.remove('hidden');
        cachedDocsCount.textContent = `Showing ${rendered} of ${totalFiltered} documents`;
    } else {
        cachedDocsCount.classList.add('hidden');
    }
}

// Check if more documents can be loaded
function hasMoreDocuments() {
    const rendered = (currentPage + 1) * PAGE_SIZE;
    return rendered < filteredDocumentsCache.length;
}

// Load more documents (append to existing) - triggered by IntersectionObserver
function loadMoreDocuments() {
    if (isLoadingMore || !hasMoreDocuments()) return;

    isLoadingMore = true;
    if (cachedScrollLoading) cachedScrollLoading.classList.remove('hidden');

    requestAnimationFrame(() => {
        const container = cachedDocumentsContainer;
        const startIdx = (currentPage + 1) * PAGE_SIZE;
        const endIdx = Math.min(startIdx + PAGE_SIZE, filteredDocumentsCache.length);
        const docsToRender = filteredDocumentsCache.slice(startIdx, endIdx);

        if (docsToRender.length === 0) {
            isLoadingMore = false;
            if (cachedScrollLoading) cachedScrollLoading.classList.add('hidden');
            updateDocumentsCount();
            return;
        }

        // Create document fragment for batch insertion
        const fragment = document.createDocumentFragment();
        const tempDiv = document.createElement('div');

        docsToRender.forEach(doc => {
            tempDiv.innerHTML = renderDocumentCard(doc, true);
            const card = tempDiv.firstElementChild;
            if (card) fragment.appendChild(card);
        });

        container.appendChild(fragment);
        currentPage++;
        isLoadingMore = false;

        if (cachedScrollLoading) cachedScrollLoading.classList.add('hidden');

        // Initialize newly added cards
        initializeDocumentCards();
        updateDocumentsCount();
    });
}

// Initialize IntersectionObserver for infinite scroll
function initializeInfiniteScroll() {
    cachedScrollSentinel = document.getElementById('scroll-sentinel');
    cachedScrollLoading = document.getElementById('scroll-loading');
    cachedDocsCount = document.getElementById('documents-count');

    if (!cachedScrollSentinel) return;

    // Disconnect existing observer if any
    if (scrollObserver) {
        scrollObserver.disconnect();
    }

    scrollObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !isLoadingMore && hasMoreDocuments()) {
                loadMoreDocuments();
            }
        });
    }, {
        root: null,
        rootMargin: '200px', // Start loading 200px before reaching the sentinel
        threshold: 0
    });

    scrollObserver.observe(cachedScrollSentinel);
}

// Render documents from multiple sessions (with pagination)
function renderCombinedDocuments(allDocuments) {
    // Sort documents by our unified sorting logic
    allDocuments.sort((a, b) => {
        const keyA = getDocumentSortKey(a);
        const keyB = getDocumentSortKey(b);

        if (keyA.sessionValue !== keyB.sessionValue) {
            return keyA.sessionValue - keyB.sessionValue;
        }
        if (keyA.categoryRank !== keyB.categoryRank) {
            return keyA.categoryRank - keyB.categoryRank;
        }
        if (keyA.committeeRank !== keyB.committeeRank) {
            return keyA.committeeRank - keyB.committeeRank;
        }
        if (keyA.docNumber !== keyB.docNumber) {
            return keyA.docNumber - keyB.docNumber;
        }
        return keyA.symbol.localeCompare(keyB.symbol);
    });

    allDocumentsCache = [...allDocuments];
    filteredDocumentsCache = [...allDocuments];
    currentPage = 0;

    // Cache DOM elements if not already cached
    if (!cachedDocumentsContainer) {
        cachedDocumentsContainer = document.getElementById('documents-container');
        cachedEmptyState = document.getElementById('empty-state');
    }

    const container = cachedDocumentsContainer;

    if (!groupByImplementation) {
        // Render first page only (infinite scroll will load more)
        const firstPageDocs = allDocuments.slice(0, PAGE_SIZE);
        container.innerHTML = firstPageDocs.map(doc => renderDocumentCard(doc, true)).join('');
        initializeDocumentCards();
        initializeInfiniteScroll();
        updateDocumentsCount();
        applyFilters();
        return;
    }

    // Group by implementation (render all for now, pagination is complex with groups)
    const groupOrder = Object.keys(implementationSessionMap)
        .sort((a, b) => Number(b) - Number(a))
        .concat('Unspecified');
    const groupedDocs = new Map(groupOrder.map(key => [key, []]));

    allDocuments.forEach(doc => {
        const groupKey = getImplementationSessionForDoc(doc) || 'Unspecified';
        if (!groupedDocs.has(groupKey)) {
            groupedDocs.set(groupKey, []);
        }
        groupedDocs.get(groupKey).push(doc);
    });

    const groupedHtml = Array.from(groupedDocs.entries())
        .filter(([, docs]) => docs.length > 0)
        .map(([groupKey, docs]) => {
            const label = groupKey === 'Unspecified'
                ? 'Implementation Session: Unspecified'
                : `Implementation Session ${groupKey}`;
            return `
                <div class="implementation-group space-y-4" data-group="${groupKey}">
                    <div class="text-xs font-semibold uppercase tracking-wide text-indigo-700">${label}</div>
                    ${docs.map(doc => renderDocumentCard(doc, true)).join('')}
                </div>
            `;
        })
        .join('');

    container.innerHTML = groupedHtml;
    initializeDocumentCards();
    updateDocumentsCount();
    applyFilters();
}



// Helper functions
function getOriginColor(origin) {
    const colors = {
        'Plenary': 'bg-amber-50 text-amber-700',
        'C1': 'bg-red-50 text-red-700',
        'C2': 'bg-green-50 text-green-700',
        'C3': 'bg-blue-50 text-blue-700',
        'C4': 'bg-purple-50 text-purple-700',
        'C5': 'bg-orange-50 text-orange-700',
        'C6': 'bg-teal-50 text-teal-700'
    };
    return colors[origin] || 'bg-gray-100 text-gray-700';
}

function getSignalColor(signal) {
    const colors = {
        'agenda': 'bg-blue-100 text-blue-800',
        'PGA': 'bg-purple-100 text-purple-800',
        'process': 'bg-amber-100 text-amber-800',
        'report': 'bg-green-100 text-green-800',
        'observer': 'bg-slate-100 text-slate-800'
    };
    return colors[signal] || 'bg-gray-100 text-gray-800';
}

function getSignalHighlightClass(signal) {
    const colors = {
        'agenda': 'bg-blue-50 text-blue-900',
        'PGA': 'bg-purple-50 text-purple-900',
        'process': 'bg-amber-50 text-amber-900',
        'report': 'bg-green-50 text-green-900',
        'observer': 'bg-slate-50 text-slate-900'
    };
    return colors[signal] || 'text-gray-800';
}

// Search functionality (with debouncing for performance)
function initializeSearch() {
    cachedSearchInput = document.getElementById('search-input');

    // Use debounced filter for search input (300ms delay)
    cachedSearchInput.addEventListener('input', function() {
        debouncedApplyFilters();
    });

    // Immediate filter on Enter key
    cachedSearchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyFilters();
        }
    });
}

// Filter functionality (similar to original but with search)
function initializeFilters() {
    sessionSelector = document.getElementById('session-selector');
    implementationFilter = document.getElementById('implementation-filter');
    sourceFilter = document.getElementById('source-filter');
    signalFilter = document.getElementById('signal-filter');
    statusFilter = document.getElementById('status-filter');
    typeFilter = document.getElementById('type-filter');
    clearFiltersBtn = document.getElementById('clear-filters');
    groupImplementationBtn = document.getElementById('group-implementation');
    includeNoSignalsToggle = document.getElementById('include-no-signals');

    // Wire up select elements with change listeners
    // Note: sessionSelector is wired up in initializeSessionSelector()
    if (implementationFilter) {
        implementationFilter.addEventListener('change', applyFilters);
    }
    if (sourceFilter) {
        sourceFilter.addEventListener('change', applyFilters);
    }
    if (signalFilter) {
        signalFilter.addEventListener('change', applyFilters);
    }
    // statusFilter and typeFilter are hidden, no need to wire them up

    if (includeNoSignalsToggle) {
        includeNoSignalsToggle.addEventListener('change', function() {
            loadSelectedSessions();
        });
    }

    if (groupImplementationBtn) {
        groupImplementationBtn.addEventListener('click', function() {
            groupByImplementation = !groupByImplementation;
            groupImplementationBtn.classList.toggle('bg-indigo-600', groupByImplementation);
            groupImplementationBtn.classList.toggle('text-white', groupByImplementation);
            groupImplementationBtn.classList.toggle('border-indigo-600', groupByImplementation);
            groupImplementationBtn.classList.toggle('bg-indigo-50', !groupByImplementation);
            groupImplementationBtn.classList.toggle('text-indigo-700', !groupByImplementation);
            groupImplementationBtn.classList.toggle('border-indigo-200', !groupByImplementation);

            if (allDocumentsCache.length > 0) {
                renderCombinedDocuments(allDocumentsCache);
            } else {
                applyFilters();
            }
        });
    }

    clearFiltersBtn.addEventListener('click', function() {
        setActiveValues(sessionSelector, ['80']); // Reset to default 80th session
        setActiveValues(implementationFilter, []);
        setActiveValues(sourceFilter, []);
        setActiveValues(signalFilter, []);
        setActiveValues(statusFilter, []);
        setActiveValues(typeFilter, []);
        selectedSessions = ['80']; // Reset to default
        groupByImplementation = false;
        if (groupImplementationBtn) {
            groupImplementationBtn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
            groupImplementationBtn.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
        }
        if (includeNoSignalsToggle) {
            includeNoSignalsToggle.checked = false;
        }
        document.getElementById('search-input').value = '';
        loadSelectedSessions();
    });
}

// Document card interactions (expand/collapse)
function initializeDocumentCards() {
    // Add click handlers for expand/collapse on document headers
    const headers = document.querySelectorAll('.doc-header:not([data-initialized])');

    headers.forEach(header => {
        header.setAttribute('data-initialized', 'true');
        header.addEventListener('click', function(e) {
            // Don't toggle if clicking on a link
            if (e.target.closest('a')) return;

            const card = header.closest('.document-card');
            const content = card.querySelector('.expandable-content');
            const icon = header.querySelector('.expand-icon');

            if (content) {
                const isHidden = content.classList.contains('hidden');
                content.classList.toggle('hidden');
                header.setAttribute('aria-expanded', isHidden ? 'true' : 'false');

                if (icon) {
                    icon.classList.toggle('rotate-180', isHidden);
                }
            }
        });
    });
}

// Initialize document cards on page load
initializeDocumentCards();
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }} Â· <a href="./data.json" class="text-un-blue hover:underline">JSON API</a>
{% endblock %}
