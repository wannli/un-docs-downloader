{% extends "base.html" %}

{% block title %}Semaphore{% endblock %}



{% block splash %}
<div id="splash">
    <div class="splash-center">
        <!-- Scene: track + semaphore + train -->
        <div class="splash-scene">
            <!-- Track -->
            <div class="splash-track">
                <div class="splash-track-line"></div>
                <div class="splash-track-ties"></div>
            </div>

            <!-- Semaphore signal (right end) -->
            <div class="semaphore-signal">
                <svg width="32" height="90" viewBox="0 0 32 90" fill="none">
                    <!-- Base plate -->
                    <rect x="8" y="84" width="16" height="6" rx="1" fill="rgba(255,255,255,0.5)"/>
                    <!-- Post -->
                    <rect x="14" y="8" width="4" height="78" rx="2" fill="rgba(255,255,255,0.85)"/>
                    <!-- Finial -->
                    <circle cx="16" cy="6" r="4" fill="rgba(255,255,255,0.7)"/>
                    <!-- Lamp housing -->
                    <rect x="11" y="18" width="10" height="12" rx="2" fill="rgba(255,255,255,0.6)"/>
                    <circle id="signal-lamp" class="signal-lamp" cx="16" cy="24" r="4"/>
                    <!-- Arm (pivots at post, extends left) -->
                    <rect id="signal-arm" class="arm-stop" x="0" y="15" width="16" height="5" rx="2" fill="rgba(255,255,255,0.9)"/>
                    <!-- Arm end disc -->
                    <circle class="arm-stop" cx="2" cy="17.5" r="3" fill="rgba(255,255,255,0.7)"/>
                </svg>
            </div>

            <!-- Train -->
            <div class="splash-train-wrap">
                <svg id="splash-train" class="splash-train" width="260" height="52" viewBox="0 0 260 52" fill="none">
                    <!-- === Tender car (leftmost) === -->
                    <rect x="2" y="16" width="36" height="24" rx="2" fill="rgba(255,255,255,0.55)"/>
                    <rect x="6" y="12" width="28" height="8" rx="2" fill="rgba(255,255,255,0.45)"/>
                    <!-- Coal texture -->
                    <rect x="10" y="13" width="4" height="3" rx="1" fill="rgba(0,158,219,0.3)"/>
                    <rect x="16" y="14" width="5" height="2" rx="1" fill="rgba(0,158,219,0.25)"/>
                    <rect x="24" y="13" width="4" height="3" rx="1" fill="rgba(0,158,219,0.3)"/>

                    <!-- === Passenger car 1 === -->
                    <rect x="42" y="14" width="44" height="26" rx="3" fill="rgba(255,255,255,0.65)"/>
                    <!-- Roof -->
                    <rect x="44" y="11" width="40" height="5" rx="2.5" fill="rgba(255,255,255,0.5)"/>
                    <!-- Windows -->
                    <rect x="46" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="53" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="60" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="67" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="74" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <!-- Door -->
                    <rect x="81" y="18" width="3" height="14" rx="0.5" fill="rgba(0,158,219,0.4)"/>

                    <!-- === Passenger car 2 === -->
                    <rect x="90" y="14" width="44" height="26" rx="3" fill="rgba(255,255,255,0.75)"/>
                    <rect x="92" y="11" width="40" height="5" rx="2.5" fill="rgba(255,255,255,0.6)"/>
                    <rect x="94" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="101" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="108" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="115" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="122" y="19" width="5" height="7" rx="1" fill="#009edb"/>
                    <rect x="129" y="18" width="3" height="14" rx="0.5" fill="rgba(0,158,219,0.4)"/>

                    <!-- === Locomotive (rightmost, leads) === -->
                    <!-- Boiler -->
                    <rect x="140" y="16" width="70" height="24" rx="4" fill="rgba(255,255,255,0.9)"/>
                    <ellipse cx="210" cy="28" rx="6" ry="12" fill="rgba(255,255,255,0.85)"/>
                    <!-- Boiler bands -->
                    <rect x="155" y="16" width="2" height="24" rx="1" fill="rgba(0,158,219,0.15)"/>
                    <rect x="175" y="16" width="2" height="24" rx="1" fill="rgba(0,158,219,0.15)"/>
                    <rect x="195" y="16" width="2" height="24" rx="1" fill="rgba(0,158,219,0.15)"/>
                    <!-- Cab -->
                    <rect x="138" y="6" width="24" height="18" rx="2" fill="rgba(255,255,255,0.9)"/>
                    <rect x="137" y="4" width="26" height="4" rx="1" fill="rgba(255,255,255,0.7)"/>
                    <!-- Cab windows -->
                    <rect x="141" y="9" width="8" height="8" rx="1.5" fill="#009edb"/>
                    <rect x="151" y="9" width="8" height="8" rx="1.5" fill="#009edb"/>
                    <!-- Smokestack -->
                    <rect x="200" y="4" width="7" height="14" rx="2" fill="rgba(255,255,255,0.9)"/>
                    <rect x="198" y="1" width="11" height="4" rx="2" fill="rgba(255,255,255,0.75)"/>
                    <!-- Steam dome -->
                    <ellipse cx="185" cy="14" rx="5" ry="4" fill="rgba(255,255,255,0.8)"/>
                    <!-- Headlight -->
                    <circle cx="215" cy="22" r="3" fill="rgba(255,255,200,0.8)"/>
                    <!-- Cowcatcher -->
                    <path d="M214 40 L224 32 L224 40 Z" fill="rgba(255,255,255,0.6)"/>
                    <path d="M216 40 L226 34 L226 40 Z" fill="rgba(255,255,255,0.4)"/>
                    <!-- Pilot beam -->
                    <rect x="214" y="36" width="14" height="3" rx="1" fill="rgba(255,255,255,0.7)"/>
                    <!-- Running board -->
                    <rect x="140" y="38" width="76" height="2" rx="0.5" fill="rgba(255,255,255,0.4)"/>

                    <!-- === Wheels === -->
                    <!-- Loco drive wheels (large) -->
                    <circle cx="160" cy="43" r="6" fill="rgba(255,255,255,0.3)" stroke="white" stroke-width="1.5"/>
                    <circle cx="160" cy="43" r="2" fill="rgba(255,255,255,0.5)"/>
                    <circle cx="178" cy="43" r="6" fill="rgba(255,255,255,0.3)" stroke="white" stroke-width="1.5"/>
                    <circle cx="178" cy="43" r="2" fill="rgba(255,255,255,0.5)"/>
                    <circle cx="196" cy="43" r="6" fill="rgba(255,255,255,0.3)" stroke="white" stroke-width="1.5"/>
                    <circle cx="196" cy="43" r="2" fill="rgba(255,255,255,0.5)"/>
                    <!-- Coupling rod -->
                    <rect x="158" y="42" width="40" height="1.5" rx="0.75" fill="rgba(255,255,255,0.5)"/>
                    <!-- Loco front wheel (small) -->
                    <circle cx="212" cy="44" r="4" fill="rgba(255,255,255,0.3)" stroke="white" stroke-width="1"/>
                    <!-- Tender wheels -->
                    <circle cx="10" cy="44" r="4" fill="rgba(255,255,255,0.25)" stroke="white" stroke-width="1"/>
                    <circle cx="26" cy="44" r="4" fill="rgba(255,255,255,0.25)" stroke="white" stroke-width="1"/>
                    <!-- Car 1 wheels -->
                    <circle cx="50" cy="44" r="3.5" fill="rgba(255,255,255,0.25)" stroke="white" stroke-width="1"/>
                    <circle cx="78" cy="44" r="3.5" fill="rgba(255,255,255,0.25)" stroke="white" stroke-width="1"/>
                    <!-- Car 2 wheels -->
                    <circle cx="98" cy="44" r="3.5" fill="rgba(255,255,255,0.3)" stroke="white" stroke-width="1"/>
                    <circle cx="126" cy="44" r="3.5" fill="rgba(255,255,255,0.3)" stroke="white" stroke-width="1"/>
                    <!-- Couplers -->
                    <rect x="36" y="30" width="8" height="3" rx="1" fill="rgba(255,255,255,0.3)"/>
                    <rect x="84" y="30" width="8" height="3" rx="1" fill="rgba(255,255,255,0.3)"/>
                    <rect x="132" y="30" width="10" height="3" rx="1" fill="rgba(255,255,255,0.3)"/>
                </svg>
            </div>
        </div>

        <!-- Title -->
        <div class="splash-text">
            <span class="splash-title">Semaphore: </span><span class="splash-sub">spotting mandate signals</span>
        </div>
    </div>
</div>
<script>
(function() {
    const splash = document.getElementById('splash');
    if (!splash) return;

    const train = document.getElementById('splash-train');
    const lamp = document.getElementById('signal-lamp');
    const arms = document.querySelectorAll('.arm-stop');
    const text = splash.querySelector('.splash-text');

    // Phase 1 (0s): tracks + semaphore visible (CSS fade-in)
    // Phase 2 (0.8s): train starts moving (4s transition)
    setTimeout(() => train.classList.add('running'), 800);

    // Phase 3 (2.4s): train ~40% across — signal turns red
    setTimeout(() => {
        lamp.classList.add('red');
        arms.forEach(el => el.classList.add('stopped'));
    }, 2400);

    // Phase 4 (3.0s): title appears
    setTimeout(() => text.classList.add('visible'), 3000);

    // Phase 5 (6s): dismiss splash
    setTimeout(() => splash.classList.add('done'), 6000);
    setTimeout(() => splash.remove(), 6600);

    // Click to skip
    splash.addEventListener('click', () => {
        splash.classList.add('done');
        setTimeout(() => splash.remove(), 600);
    });
})();
</script>
{% endblock %}


{% block header_search %}
<!-- Search in header -->
<input type="text" id="search-input" placeholder="Search documents..."
       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
{% endblock %}

{% block content %}
<!-- Compact filter bar -->
<div class="sticky top-[73px] z-10 bg-white/95 backdrop-blur border-b border-gray-100 -mx-6 px-6 py-2 -mt-10">
    <div class="flex items-center gap-2">
        <!-- Desktop: individual dropdowns -->
        <div class="hidden sm:contents">
            <!-- Session dropdown -->
            <div class="relative" data-dropdown="session">
                <button type="button" class="dropdown-trigger inline-flex items-center gap-1 h-8 rounded-lg border border-gray-200 bg-white px-2.5 text-xs font-medium text-gray-700 hover:border-gray-300 transition-colors">
                    <span class="dropdown-label">Session</span>
                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div class="dropdown-panel hidden absolute top-full left-0 mt-1 bg-white rounded-lg border border-gray-200 shadow-lg p-2 min-w-[160px] max-h-[280px] overflow-y-auto z-20">
                    <div id="session-options" class="space-y-0.5"></div>
                </div>
            </div>

            <!-- Target session dropdown -->
            <div class="relative" data-dropdown="target-session">
                <button type="button" class="dropdown-trigger inline-flex items-center gap-1 h-8 rounded-lg border border-gray-200 bg-white px-2.5 text-xs font-medium text-gray-700 hover:border-gray-300 transition-colors">
                    <span class="dropdown-label">Target</span>
                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div class="dropdown-panel hidden absolute top-full left-0 mt-1 bg-white rounded-lg border border-gray-200 shadow-lg p-2 min-w-[160px] max-h-[280px] overflow-y-auto z-20">
                    <div id="target-session-options" class="space-y-0.5"></div>
                </div>
            </div>

            <!-- Signal dropdown -->
            <div class="relative" data-dropdown="signal">
                <button type="button" class="dropdown-trigger inline-flex items-center gap-1 h-8 rounded-lg border border-gray-200 bg-white px-2.5 text-xs font-medium text-gray-700 hover:border-gray-300 transition-colors">
                    <span class="dropdown-label">Signal</span>
                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div class="dropdown-panel hidden absolute top-full left-0 mt-1 bg-white rounded-lg border border-gray-200 shadow-lg p-2 min-w-[160px] z-20">
                    <div id="signal-options" class="space-y-0.5">
                        {% for check in checks %}
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                            <input type="checkbox" value="{{ check.signal }}" class="filter-checkbox rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                            <span>{{ check.signal }}</span>
                        </label>
                        {% endfor %}
                        <hr class="border-gray-100 my-1">
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-500 italic">
                            <input type="checkbox" value="none" class="filter-checkbox rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                            <span>none</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Type dropdown -->
            <div class="relative" data-dropdown="type">
                <button type="button" class="dropdown-trigger inline-flex items-center gap-1 h-8 rounded-lg border border-gray-200 bg-white px-2.5 text-xs font-medium text-gray-700 hover:border-gray-300 transition-colors">
                    <span class="dropdown-label">Type</span>
                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div class="dropdown-panel hidden absolute top-full left-0 mt-1 bg-white rounded-lg border border-gray-200 shadow-lg p-2 min-w-[160px] z-20">
                    <div id="type-options" class="space-y-0.5">
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                            <input type="checkbox" value="resolution" class="filter-checkbox rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                            <span>Resolutions</span>
                        </label>
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                            <input type="checkbox" value="proposal" class="filter-checkbox rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                            <span>Proposals</span>
                        </label>
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                            <input type="checkbox" value="decision" class="filter-checkbox rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                            <span>Decisions</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile: single "Filters" button -->
        <div class="sm:hidden relative" data-dropdown="mobile-filters">
            <button type="button" class="dropdown-trigger inline-flex items-center gap-1 h-8 rounded-lg border border-gray-200 bg-white px-2.5 text-xs font-medium text-gray-700 hover:border-gray-300 transition-colors">
                <span class="dropdown-label">Filters</span>
                <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div class="dropdown-panel hidden absolute top-full left-0 mt-1 bg-white rounded-lg border border-gray-200 shadow-lg p-3 min-w-[220px] max-h-[70vh] overflow-y-auto z-20">
                <div class="space-y-3">
                    <div>
                        <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 mb-1.5">Session</div>
                        <div id="mobile-session-options" class="space-y-0.5"></div>
                    </div>
                    <hr class="border-gray-100">
                    <div>
                        <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 mb-1.5">Target</div>
                        <div id="mobile-target-session-options" class="space-y-0.5"></div>
                    </div>
                    <hr class="border-gray-100">
                    <div>
                        <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 mb-1.5">Signal</div>
                        <div id="mobile-signal-options" class="space-y-0.5">
                            {% for check in checks %}
                            <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                                <input type="checkbox" value="{{ check.signal }}" class="mobile-filter-checkbox filter-checkbox-signal rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                                <span>{{ check.signal }}</span>
                            </label>
                            {% endfor %}
                            <hr class="border-gray-100 my-1">
                            <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-500 italic">
                                <input type="checkbox" value="none" class="mobile-filter-checkbox filter-checkbox-signal rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                                <span>none</span>
                            </label>
                        </div>
                    </div>
                    <hr class="border-gray-100">
                    <div>
                        <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 mb-1.5">Type</div>
                        <div id="mobile-type-options" class="space-y-0.5">
                            <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                                <input type="checkbox" value="resolution" class="mobile-filter-checkbox filter-checkbox-type rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                                <span>Resolutions</span>
                            </label>
                            <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                                <input type="checkbox" value="proposal" class="mobile-filter-checkbox filter-checkbox-type rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                                <span>Proposals</span>
                            </label>
                            <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
                                <input type="checkbox" value="decision" class="mobile-filter-checkbox filter-checkbox-type rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
                                <span>Decisions</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spacer -->
        <div class="flex-1"></div>

        <!-- Document count (inline) -->
        <span id="documents-count" class="text-[11px] text-gray-400 whitespace-nowrap hidden"></span>

        <!-- Clear button -->
        <button id="clear-filters" class="hidden h-8 w-8 items-center justify-center rounded-lg border border-gray-200 text-gray-400 hover:text-gray-600 hover:border-gray-300 transition-colors" type="button" title="Clear all filters">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>
</div>

<!-- Main Content Area -->
<div id="main-content" class="mt-4">
    <!-- Document List -->
    <div id="document-list">
        <div class="space-y-4" id="documents-container">
            <!-- Documents will be loaded dynamically via JavaScript -->
        </div>

        <!-- Scroll Sentinel for IntersectionObserver (invisible) -->
        <div id="scroll-sentinel" class="h-4"></div>

        <!-- Loading Spinner for infinite scroll -->
        <div id="scroll-loading" class="hidden py-6 text-center">
            <div class="inline-flex items-center gap-2 text-sm text-gray-500">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-un-blue"></div>
                <span>Loading more documents...</span>
            </div>
        </div>

        <!-- Empty State -->
        <div class="hidden text-center py-12" id="empty-state">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No documents found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or search terms.</p>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="loading-overlay">
    <div class="bg-white rounded-lg p-6 flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-un-blue"></div>
        <span class="text-sm text-gray-700">Loading documents...</span>
    </div>
</div>

<script>
// ============================================
// URL CLEANUP
// ============================================
(function() {
    const path = window.location.pathname;
    if (path.endsWith('/index.html')) {
        const newPath = path.replace(/\/index\.html$/, '/');
        window.history.replaceState(null, '', newPath + window.location.search + window.location.hash);
    }
})();

// ============================================
// STATE
// ============================================
const PAGE_SIZE = 50;
let currentPage = 0;
let filteredDocumentsCache = [];
let isLoadingMore = false;
let allDocumentsCache = [];

const basePath = window.location.pathname.replace(/\/[^/]*$/, '');
const signalPhraseMap = Object.fromEntries(({{ checks | tojson }} || []).map(c => [c.signal, c.phrases || []]));

// DOM caches
let cachedDocumentsContainer = null;
let cachedEmptyState = null;
let cachedSearchInput = null;
let cachedDocsCount = null;
let cachedScrollSentinel = null;
let cachedScrollLoading = null;
let scrollObserver = null;

// ============================================
// UTILITIES
// ============================================
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

// ============================================
// DROPDOWN MANAGEMENT
// ============================================
function initDropdowns() {
    // Toggle dropdown on button click
    document.querySelectorAll('[data-dropdown]').forEach(wrapper => {
        const trigger = wrapper.querySelector('.dropdown-trigger');
        const panel = wrapper.querySelector('.dropdown-panel');

        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = !panel.classList.contains('hidden');
            closeAllDropdowns();
            if (!isOpen) {
                panel.classList.remove('hidden');
            }
        });
    });

    // Close dropdowns on outside click
    document.addEventListener('click', (e) => {
        if (!e.target.closest('[data-dropdown]')) {
            closeAllDropdowns();
        }
    });
}

function closeAllDropdowns() {
    document.querySelectorAll('.dropdown-panel').forEach(p => p.classList.add('hidden'));
}

// ============================================
// FILTER STATE
// ============================================
function getSelectedValues(containerId) {
    return Array.from(document.querySelectorAll(`#${containerId} .filter-checkbox:checked`)).map(cb => cb.value);
}

function setSelectedValues(containerId, values) {
    const valueSet = new Set(values);
    document.querySelectorAll(`#${containerId} .filter-checkbox`).forEach(cb => {
        cb.checked = valueSet.has(cb.value);
    });
}

function getFilterState() {
    const isMobile = window.innerWidth < 640;
    return {
        sessions: getSelectedValues(isMobile ? 'mobile-session-options' : 'session-options'),
        targetSessions: getSelectedValues(isMobile ? 'mobile-target-session-options' : 'target-session-options'),
        signals: getSelectedValues(isMobile ? 'mobile-signal-options' : 'signal-options'),
        types: getSelectedValues(isMobile ? 'mobile-type-options' : 'type-options'),
        searchQuery: (cachedSearchInput || document.getElementById('search-input')).value.toLowerCase().trim(),
    };
}

function syncMobileDesktopFilters(source) {
    // Sync checkboxes between mobile and desktop
    const pairs = [
        ['session-options', 'mobile-session-options'],
        ['target-session-options', 'mobile-target-session-options'],
        ['signal-options', 'mobile-signal-options'],
        ['type-options', 'mobile-type-options'],
    ];
    for (const [desktopId, mobileId] of pairs) {
        const sourceId = source === 'mobile' ? mobileId : desktopId;
        const targetId = source === 'mobile' ? desktopId : mobileId;
        const values = getSelectedValues(sourceId);
        setSelectedValues(targetId, values);
    }
}

function updateDropdownLabels() {
    const state = getFilterState();

    // Session
    updateLabel('[data-dropdown="session"] .dropdown-label', 'Session', state.sessions);
    // Target session
    updateLabel('[data-dropdown="target-session"] .dropdown-label', 'Target', state.targetSessions);
    // Signal
    updateLabel('[data-dropdown="signal"] .dropdown-label', 'Signal', state.signals);
    // Type
    updateLabel('[data-dropdown="type"] .dropdown-label', 'Type', state.types);
    // Mobile
    const totalActive = state.sessions.length + state.targetSessions.length + state.signals.length + state.types.length;
    const mobileLabel = document.querySelector('[data-dropdown="mobile-filters"] .dropdown-label');
    if (mobileLabel) {
        mobileLabel.textContent = totalActive > 0 ? `Filters (${totalActive})` : 'Filters';
    }

    // Show/hide clear button
    const clearBtn = document.getElementById('clear-filters');
    const hasActive = totalActive > 0 || state.searchQuery.length > 0;
    if (clearBtn) {
        clearBtn.classList.toggle('hidden', !hasActive);
        clearBtn.classList.toggle('inline-flex', hasActive);
    }

    // Highlight active dropdown triggers
    document.querySelectorAll('[data-dropdown]').forEach(wrapper => {
        const name = wrapper.dataset.dropdown;
        const trigger = wrapper.querySelector('.dropdown-trigger');
        let isActive = false;
        if (name === 'session') isActive = state.sessions.length > 0;
        else if (name === 'target-session') isActive = state.targetSessions.length > 0;
        else if (name === 'signal') isActive = state.signals.length > 0;
        else if (name === 'type') isActive = state.types.length > 0;
        else if (name === 'mobile-filters') isActive = totalActive > 0;

        trigger.classList.toggle('border-un-blue', isActive);
        trigger.classList.toggle('text-un-blue', isActive);
        trigger.classList.toggle('border-gray-200', !isActive);
        trigger.classList.toggle('text-gray-700', !isActive);
    });
}

function updateLabel(selector, defaultText, values) {
    const el = document.querySelector(selector);
    if (!el) return;
    if (values.length === 0) {
        el.textContent = defaultText;
    } else if (values.length <= 2) {
        el.textContent = values.join(', ');
    } else {
        el.textContent = `${values.length} selected`;
    }
}

// ============================================
// URL STATE
// ============================================
function updateUrlState() {
    const state = getFilterState();
    const params = new URLSearchParams();
    if (state.searchQuery) params.set('q', state.searchQuery);
    if (state.sessions.length) params.set('sessions', state.sessions.join(','));
    if (state.targetSessions.length) params.set('target', state.targetSessions.join(','));
    if (state.signals.length) params.set('signals', state.signals.join(','));
    if (state.types.length) params.set('type', state.types.join(','));
    const newUrl = params.toString() ? `${window.location.pathname}?${params}` : window.location.pathname;
    window.history.replaceState({}, '', newUrl);
}

function applyFiltersFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const q = params.get('q') || '';
    document.getElementById('search-input').value = q;

    const sessions = params.get('sessions');
    const targetSessions = params.get('target');
    const signals = params.get('signals');
    const types = params.get('type');

    if (sessions) {
        setSelectedValues('session-options', sessions.split(','));
        setSelectedValues('mobile-session-options', sessions.split(','));
    }
    if (targetSessions) {
        setSelectedValues('target-session-options', targetSessions.split(','));
        setSelectedValues('mobile-target-session-options', targetSessions.split(','));
    }
    if (signals) {
        setSelectedValues('signal-options', signals.split(','));
        setSelectedValues('mobile-signal-options', signals.split(','));
    }
    if (types) {
        setSelectedValues('type-options', types.split(','));
        setSelectedValues('mobile-type-options', types.split(','));
    }
}

// ============================================
// DOCUMENT FILTERING
// ============================================
function documentMatchesFilters(doc, state) {
    // Session
    const docSession = doc.session ? doc.session.toString() : '';
    if (state.sessions.length > 0 && !state.sessions.includes(docSession)) return false;

    // Target session
    if (state.targetSessions.length > 0) {
        const docTargets = doc.target_sessions || [];
        if (!state.targetSessions.some(t => docTargets.includes(t))) return false;
    }

    // Type
    if (state.types.length > 0 && !state.types.includes(doc.doc_type || '')) return false;

    // Signal filter
    const hasSignals = (doc.signal_paragraphs && doc.signal_paragraphs.length > 0)
        || (doc.signal_summary && Object.keys(doc.signal_summary).length > 0);

    const selectedSignals = state.signals.filter(s => s !== 'none');
    const noneSelected = state.signals.includes('none');

    if (selectedSignals.length > 0 && noneSelected) {
        // "none" + specific signals: show docs matching those signals OR docs with no signals
        const docSignals = Object.keys(doc.signal_summary || {});
        if (!selectedSignals.some(s => docSignals.includes(s)) && hasSignals) return false;
    } else if (selectedSignals.length > 0) {
        // Specific signals only: must have at least one
        const docSignals = Object.keys(doc.signal_summary || {});
        if (!selectedSignals.some(s => docSignals.includes(s))) return false;
    } else if (noneSelected) {
        // "none" only: show documents with no signals
        if (hasSignals) return false;
    } else {
        // No signal filter: default to showing only docs with signals
        if (!hasSignals) return false;
    }

    // Search
    if (state.searchQuery) {
        const searchText = `${doc.symbol || ''} ${doc.title || ''} ${doc.decision_text || ''}`.toLowerCase();
        const paraText = (doc.signal_paragraphs || []).map(p => (p.text || '').toLowerCase()).join(' ');
        if (!searchText.includes(state.searchQuery) && !paraText.includes(state.searchQuery)) return false;
    }

    return true;
}

function applyFilters() {
    const state = getFilterState();
    filteredDocumentsCache = allDocumentsCache.filter(doc => documentMatchesFilters(doc, state));
    currentPage = 0;

    const container = cachedDocumentsContainer || document.getElementById('documents-container');
    const emptyState = cachedEmptyState || document.getElementById('empty-state');

    if (filteredDocumentsCache.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        container.classList.add('hidden');
    } else {
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        const firstPage = filteredDocumentsCache.slice(0, PAGE_SIZE);
        const expandForSearch = !!state.searchQuery;
        requestAnimationFrame(() => {
            container.innerHTML = firstPage.map(doc => renderDocumentCard(doc, true, expandForSearch)).join('');
            initializeDocumentCards();
            initializeInfiniteScroll();
            applySignalHighlights();
            if (state.searchQuery) applySearchHighlights(state.searchQuery);
            applyTargetSessionHighlights(state.targetSessions);
        });
    }

    updateDocumentsCount();
    updateDropdownLabels();
    updateUrlState();
}

const debouncedApplyFilters = debounce(() => applyFilters(), 300);

// ============================================
// DATA LOADING
// ============================================
function buildSignalParagraphs(doc) {
    const paragraphs = doc.paragraphs || {};
    const signals = doc.signals || {};
    const result = [];
    Object.entries(signals).forEach(([num, sigs]) => {
        if (sigs && sigs.length) result.push({ number: num, text: paragraphs[num] || '', signals: sigs });
    });
    result.sort((a, b) => Number(a.number) - Number(b.number));
    return result;
}

function normalizeDocument(doc) {
    const sp = doc.signal_paragraphs || buildSignalParagraphs(doc);
    const ss = doc.signal_summary && Object.keys(doc.signal_summary).length > 0
        ? doc.signal_summary
        : (() => { const s = {}; sp.forEach(p => (p.signals || []).forEach(sig => s[sig] = (s[sig] || 0) + 1)); return s; })();
    const session = doc.session || getSessionFromSymbol(doc.symbol);
    const docType = doc.doc_type || (doc.symbol?.includes('/RES/') ? 'resolution' : doc.symbol?.includes('/L.') ? 'proposal' : '');
    const targetSessions = extractTargetSessions(sp, session);
    return { ...doc, session, doc_type: docType, signal_paragraphs: sp, signal_summary: ss, target_sessions: targetSessions };
}

const ORDINAL_TO_NUMBER = {
    'eightieth':80,
    'eighty-first':81,'eighty-second':82,'eighty-third':83,'eighty-fourth':84,'eighty-fifth':85,
    'eighty-sixth':86,'eighty-seventh':87,'eighty-eighth':88,'eighty-ninth':89,'ninetieth':90,
};

// Reverse map: number → ordinal string (for highlighting)
const NUMBER_TO_ORDINAL = Object.fromEntries(Object.entries(ORDINAL_TO_NUMBER).map(([k, v]) => [v.toString(), k]));

function extractTargetSessions(signalParagraphs, docSession) {
    const targets = new Set();
    const sessionPattern = /(\w+(?:-\w+)?)\s+session/gi;
    for (const para of signalParagraphs) {
        const text = (para.text || '').toLowerCase();
        let match;
        while ((match = sessionPattern.exec(text)) !== null) {
            const ordinal = match[1].toLowerCase();
            const num = ORDINAL_TO_NUMBER[ordinal];
            if (num && (!docSession || num.toString() !== docSession.toString())) {
                targets.add(num.toString());
            }
        }
    }
    return [...targets].sort((a, b) => Number(a) - Number(b));
}

function getSessionFromSymbol(symbol) {
    if (!symbol) return null;
    let m = symbol.match(/^A\/RES\/(\d+)/); if (m) return m[1];
    m = symbol.match(/^A\/C\.\d+\/(\d+)\/L\./); if (m) return m[1];
    m = symbol.match(/^A\/(\d+)\/L\./); if (m) return m[1];
    return null;
}

async function loadData() {
    const overlay = document.getElementById('loading-overlay');
    overlay.classList.remove('hidden');

    try {
        const response = await fetch(`${basePath}/data.json`);
        if (!response.ok) throw new Error('Failed to load data');
        const data = await response.json();

        const documents = (data.documents || []).map(doc => normalizeDocument(doc));

        // Populate session checkboxes from data
        const sessions = [...new Set(documents.map(d => d.session).filter(Boolean).map(String))];
        sessions.sort((a, b) => Number(b) - Number(a));
        populateSessionCheckboxes('session-options', sessions);
        populateSessionCheckboxes('mobile-session-options', sessions);

        // Populate target session checkboxes from extracted data
        const targetSessions = [...new Set(documents.flatMap(d => d.target_sessions || []))];
        targetSessions.sort((a, b) => Number(b) - Number(a));
        populateSessionCheckboxes('target-session-options', targetSessions);
        populateSessionCheckboxes('mobile-target-session-options', targetSessions);

        // Apply URL state
        applyFiltersFromUrl();

        // Store and render
        allDocumentsCache = documents;
        sortDocuments(allDocumentsCache);
        applyFilters();
    } catch (error) {
        console.error('Error loading data:', error);
    } finally {
        overlay.classList.add('hidden');
    }
}

function populateSessionCheckboxes(containerId, sessions) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = sessions.map(s => `
        <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer text-xs text-gray-700">
            <input type="checkbox" value="${s}" class="filter-checkbox rounded border-gray-300 text-un-blue focus:ring-un-blue h-3.5 w-3.5">
            <span>${s}</span>
        </label>
    `).join('');
}

// ============================================
// SORTING
// ============================================
function sortDocuments(docs) {
    docs.sort((a, b) => {
        const sA = Number(a.session) || 0, sB = Number(b.session) || 0;
        if (sA !== sB) return sB - sA; // newest session first

        const rankA = docTypeRank(a), rankB = docTypeRank(b);
        if (rankA !== rankB) return rankA - rankB;

        return compareSymbols(a.symbol || '', b.symbol || '');
    });
}

function compareSymbols(a, b) {
    // Numeric-aware comparison: split on / and compare segments
    const partsA = a.split('/'), partsB = b.split('/');
    for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
        const pA = partsA[i] || '', pB = partsB[i] || '';
        const nA = Number(pA), nB = Number(pB);
        if (!isNaN(nA) && !isNaN(nB)) {
            if (nA !== nB) return nA - nB;
        } else {
            const cmp = pA.localeCompare(pB);
            if (cmp !== 0) return cmp;
        }
    }
    return 0;
}

function docTypeRank(doc) {
    if (doc.doc_type === 'resolution') return 0;
    if (doc.doc_type === 'proposal') return 1;
    return 2;
}

// ============================================
// DOCUMENT CARD RENDERING
// ============================================
function getDisplayTitle(doc) {
    if (!doc.title) return '';
    const parts = (doc.symbol || '').split('/');
    const numPart = parts.length >= 2 ? `${parts[parts.length - 2]}/${parts[parts.length - 1]}` : '';
    if (numPart && doc.title.startsWith(`${numPart}. `)) return doc.title.slice(numPart.length + 2);
    return doc.title;
}

function getSignalColor(signal) {
    const colors = {
        'agenda': 'bg-blue-100 text-blue-800',
        'PGA': 'bg-purple-100 text-purple-800',
        'process': 'bg-amber-100 text-amber-800',
        'report': 'bg-green-100 text-green-800',
        'observer': 'bg-slate-100 text-slate-800'
    };
    return colors[signal] || 'bg-gray-100 text-gray-800';
}

function getSignalDotColor(signal) {
    const colors = {
        'agenda': 'bg-blue-500',
        'PGA': 'bg-purple-500',
        'process': 'bg-amber-500',
        'report': 'bg-green-500',
        'observer': 'bg-slate-500'
    };
    return colors[signal] || 'bg-gray-500';
}

function getSignalHighlightClass(signal) {
    const colors = {
        'agenda': 'bg-blue-50 text-blue-900',
        'PGA': 'bg-purple-50 text-purple-900',
        'process': 'bg-amber-50 text-amber-900',
        'report': 'bg-green-50 text-green-900',
        'observer': 'bg-slate-50 text-slate-900'
    };
    return colors[signal] || 'text-gray-800';
}

function renderDocumentCard(doc, isCollapsed = true, forceExpand = false) {
    const signalParagraphs = doc.signal_paragraphs || [];
    const title = escapeHtml(getDisplayTitle(doc));
    const collapsed = forceExpand ? false : isCollapsed;
    const symbol = escapeHtml(doc.symbol || '');
    const isDecision = doc.doc_type === 'decision';
    const decisionText = escapeHtml(doc.decision_text || '');
    const metaItems = [];

    if (isDecision) {
        if (doc.meeting_date) metaItems.push(`Date ${escapeHtml(doc.meeting_date)}`);
        if (doc.meeting_number) metaItems.push(`Meeting ${escapeHtml(doc.meeting_number)}`);
        if (doc.agenda_item) metaItems.push(`Agenda ${escapeHtml(doc.agenda_item)}`);
        if (doc.session) metaItems.push(`Session ${escapeHtml(doc.session)}`);
    }

    const paragraphsHtml = signalParagraphs.length
        ? signalParagraphs.map(para => `
            <div class="para-item text-sm text-gray-900" data-signals="${(para.signals || []).join(',')}">
                <div class="leading-relaxed">
                    ${!isDecision ? `<span class="font-semibold text-gray-700">${escapeHtml(para.number)}.</span>` : ''}
                    <span class="text-gray-800" data-paragraph data-search>${escapeHtml(para.text)}</span>
                </div>
            </div>
        `).join('')
        : `
            <div class="para-item text-sm text-gray-900" data-signals="">
                <div class="text-xs font-semibold uppercase tracking-wide text-gray-400">No signals detected</div>
                ${decisionText
                    ? `<p class="text-gray-700 leading-relaxed mt-2" data-paragraph data-search>${decisionText}</p>`
                    : '<p class="text-gray-500 italic mt-2" data-paragraph data-search>No signal data available for this document.</p>'}
            </div>
        `;

    return `
        <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors${doc.doc_type === 'proposal' ? ' border-l-4 border-l-amber-400' : ''}${doc.doc_type === 'decision' ? ' border-l-4 border-l-slate-400' : ''}"
             data-symbol="${doc.symbol}"
             data-type="${doc.doc_type || ''}"
             data-session="${doc.session || ''}">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 cursor-pointer doc-header" role="button" aria-expanded="${!collapsed}">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="font-semibold text-gray-900" data-search>${symbol}</span>
                            ${isDecision ? `<span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700">Decision</span>` : ''}
                            ${!isDecision && doc.origin && doc.origin !== 'Unknown' && doc.origin !== 'IGov' ? `<span class="text-xs text-gray-500">· ${escapeHtml(doc.origin)}</span>` : ''}
                            ${doc.doc_type === 'proposal' ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Draft</span>' : ''}
                            ${Object.entries(doc.signal_summary || {}).map(([sig, count]) => `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[10px] font-medium ${getSignalColor(sig)}"><span class="w-1.5 h-1.5 rounded-full ${getSignalDotColor(sig)}"></span>${sig}${count > 1 ? ' ×' + count : ''}</span>`).join('')}
                        </div>
                        ${title ? `<p class="text-sm text-gray-600 truncate" title="${title}" data-search>${title}</p>` : ''}
                        ${metaItems.length ? `<div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500">${metaItems.map(item => `<span>${item}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        ${isDecision && doc.igov_url ? `<a href="${doc.igov_url}" target="_blank" class="text-xs text-muted hover:text-un-blue transition-colors" onclick="event.stopPropagation()">iGov</a>` : ''}
                        ${!isDecision && doc.un_url ? `<a href="${doc.un_url}" target="_blank" class="text-xs text-muted hover:text-un-blue transition-colors" onclick="event.stopPropagation()">PDF</a>` : ''}
                        <svg class="expand-icon w-4 h-4 text-gray-400 transition-transform ${collapsed ? '' : 'rotate-180'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-200 expandable-content ${collapsed ? 'hidden' : ''}">
                <div class="px-4 py-3 space-y-3">
                    ${paragraphsHtml}
                </div>
            </div>
        </div>
    `;
}

// ============================================
// HIGHLIGHTS
// ============================================
function highlightQueryInElement(element, query, className) {
    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(escaped, 'gi');
    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null);
    const nodes = [];
    while (walker.nextNode()) nodes.push(walker.currentNode);
    nodes.forEach(node => {
        const text = node.nodeValue;
        if (!text || !regex.test(text)) return;
        regex.lastIndex = 0;
        const fragment = document.createDocumentFragment();
        let last = 0;
        text.replace(regex, (match, idx) => {
            fragment.appendChild(document.createTextNode(text.slice(last, idx)));
            const mark = document.createElement('mark');
            mark.className = className;
            mark.textContent = match;
            fragment.appendChild(mark);
            last = idx + match.length;
            return match;
        });
        fragment.appendChild(document.createTextNode(text.slice(last)));
        node.parentNode.replaceChild(fragment, node);
    });
}

function applySignalHighlights() {
    document.querySelectorAll('[data-paragraph]').forEach(target => {
        target.querySelectorAll('mark.signal-highlight').forEach(m => m.replaceWith(m.textContent));
        const paraItem = target.closest('.para-item');
        const signals = paraItem ? paraItem.dataset.signals.split(',').filter(Boolean) : [];
        signals.forEach(signal => {
            const phrases = signalPhraseMap[signal] || [];
            phrases.sort((a, b) => b.length - a.length).forEach(phrase => {
                highlightQueryInElement(target, phrase, `signal-highlight ${getSignalHighlightClass(signal)} rounded px-0.5`);
            });
        });
    });
}

function applySearchHighlights(query) {
    if (!query) return;
    document.querySelectorAll('[data-search]').forEach(target => {
        target.querySelectorAll('mark.search-highlight').forEach(m => m.replaceWith(m.textContent));
        highlightQueryInElement(target, query, 'search-highlight bg-red-100 text-red-900 rounded px-0.5');
    });
}

function applyTargetSessionHighlights(targetSessions) {
    // Clear previous target highlights
    document.querySelectorAll('mark.target-highlight').forEach(m => m.replaceWith(m.textContent));
    // If specific targets selected, highlight those; otherwise highlight all known ordinals
    const sessions = (targetSessions && targetSessions.length)
        ? targetSessions
        : Object.keys(NUMBER_TO_ORDINAL);
    const phrases = sessions
        .map(n => NUMBER_TO_ORDINAL[n])
        .filter(Boolean)
        .map(ordinal => `${ordinal} session`);
    if (!phrases.length) return;
    document.querySelectorAll('[data-paragraph]').forEach(target => {
        phrases.forEach(phrase => {
            highlightQueryInElement(target, phrase, 'target-highlight bg-gray-200 text-gray-900 rounded px-0.5');
        });
    });
}

// ============================================
// INFINITE SCROLL
// ============================================
function updateDocumentsCount() {
    if (!cachedDocsCount) cachedDocsCount = document.getElementById('documents-count');
    if (!cachedDocsCount) return;
    const total = filteredDocumentsCache.length;
    if (total > 0) {
        cachedDocsCount.classList.remove('hidden');
        cachedDocsCount.textContent = `${total} documents`;
    } else {
        cachedDocsCount.classList.add('hidden');
    }
}

function hasMoreDocuments() {
    return (currentPage + 1) * PAGE_SIZE < filteredDocumentsCache.length;
}

function loadMoreDocuments() {
    if (isLoadingMore || !hasMoreDocuments()) return;
    isLoadingMore = true;
    if (cachedScrollLoading) cachedScrollLoading.classList.remove('hidden');

    requestAnimationFrame(() => {
        const start = (currentPage + 1) * PAGE_SIZE;
        const end = Math.min(start + PAGE_SIZE, filteredDocumentsCache.length);
        const docs = filteredDocumentsCache.slice(start, end);

        if (docs.length === 0) {
            isLoadingMore = false;
            if (cachedScrollLoading) cachedScrollLoading.classList.add('hidden');
            updateDocumentsCount();
            return;
        }

        const fragment = document.createDocumentFragment();
        const tmp = document.createElement('div');
        const expandForSearch = !!(cachedSearchInput && cachedSearchInput.value.trim());
        docs.forEach(doc => {
            tmp.innerHTML = renderDocumentCard(doc, true, expandForSearch);
            if (tmp.firstElementChild) fragment.appendChild(tmp.firstElementChild);
        });

        cachedDocumentsContainer.appendChild(fragment);
        currentPage++;
        isLoadingMore = false;
        if (cachedScrollLoading) cachedScrollLoading.classList.add('hidden');
        initializeDocumentCards();
        applySignalHighlights();
        const currentState = getFilterState();
        if (currentState.searchQuery) applySearchHighlights(currentState.searchQuery);
        applyTargetSessionHighlights(currentState.targetSessions);
        updateDocumentsCount();
    });
}

function initializeInfiniteScroll() {
    cachedScrollSentinel = document.getElementById('scroll-sentinel');
    cachedScrollLoading = document.getElementById('scroll-loading');
    cachedDocsCount = document.getElementById('documents-count');
    if (!cachedScrollSentinel) return;
    if (scrollObserver) scrollObserver.disconnect();
    scrollObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !isLoadingMore && hasMoreDocuments()) loadMoreDocuments();
        });
    }, { root: null, rootMargin: '200px', threshold: 0 });
    scrollObserver.observe(cachedScrollSentinel);
}

// ============================================
// DOCUMENT CARD INTERACTIONS
// ============================================
function initializeDocumentCards() {
    document.querySelectorAll('.doc-header:not([data-initialized])').forEach(header => {
        header.setAttribute('data-initialized', 'true');
        header.addEventListener('click', function(e) {
            if (e.target.closest('a')) return;
            const card = header.closest('.document-card');
            const content = card.querySelector('.expandable-content');
            const icon = header.querySelector('.expand-icon');
            if (content) {
                const isHidden = content.classList.contains('hidden');
                content.classList.toggle('hidden');
                header.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                if (icon) icon.classList.toggle('rotate-180', isHidden);
            }
        });
    });
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    cachedDocumentsContainer = document.getElementById('documents-container');
    cachedEmptyState = document.getElementById('empty-state');
    cachedSearchInput = document.getElementById('search-input');

    initDropdowns();

    // Wire up filter checkboxes (desktop)
    ['session-options', 'target-session-options', 'signal-options', 'type-options'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', (e) => {
            if (e.target.classList.contains('filter-checkbox')) {
                syncMobileDesktopFilters('desktop');
                applyFilters();
            }
        });
    });

    // Wire up filter checkboxes (mobile)
    ['mobile-session-options', 'mobile-target-session-options', 'mobile-signal-options', 'mobile-type-options'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', (e) => {
            if (e.target.classList.contains('filter-checkbox')) {
                syncMobileDesktopFilters('mobile');
                applyFilters();
            }
        });
    });

    // Search
    cachedSearchInput.addEventListener('input', debouncedApplyFilters);
    cachedSearchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); applyFilters(); }
    });

    // Clear
    document.getElementById('clear-filters').addEventListener('click', () => {
        document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
        cachedSearchInput.value = '';
        applyFilters();
    });

    // Load data
    loadData();
});
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }} · <a href="./data.json" class="text-un-blue hover:underline">JSON API</a>
{% endblock %}
