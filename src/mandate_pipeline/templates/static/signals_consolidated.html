{% extends "base.html" %}

{% block title %}Consolidated Signal Browser - Mandate Pipeline{% endblock %}

{% block nav_index %}./index.html{% endblock %}
{% block nav_signals %}./signals-unified.html{% endblock %}
{% block nav_signals_info %}./signals-info.html{% endblock %}
{% block nav_decisions %}./igov/{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-4 hidden sm:block">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Consolidated Signal Browser</h1>
    <p class="mt-1 text-sm text-gray-500">Resolutions, proposals, and IGov decisions in one view</p>
</div>


<div class="sticky top-20 z-10 space-y-3 bg-white/95 pb-3 backdrop-blur">
    <!-- Search -->
    <div class="rounded-xl border border-gray-200 bg-gray-50/80 p-3 shadow-sm">
        <label for="search-input" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Search</label>
        <input type="text" id="search-input" placeholder="Search by symbol, title, or content..."
               class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
    </div>

    <!-- Filters -->
    <div class="rounded-xl border border-gray-200 bg-white p-2 shadow-sm">
        <div class="flex flex-wrap items-center gap-1.5 md:grid md:grid-cols-2">
            <div class="flex flex-wrap items-center gap-1.5 md:block">
                <label class="hidden md:inline-flex items-center text-[11px] font-semibold uppercase tracking-wide text-gray-500">Session</label>
                <div id="session-selector" class="flex flex-wrap gap-1.5 md:mt-1.5">
                    <button type="button" class="filter-pill inline-flex items-center h-6 whitespace-nowrap rounded-full border border-gray-200 px-2 py-0.5 text-[11px] font-medium text-gray-600 transition-colors hover:border-gray-300 hover:text-gray-900" data-value="80">80</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-1.5 md:block">
                <label class="hidden md:inline-flex items-center text-[11px] font-semibold uppercase tracking-wide text-gray-500">Signal</label>
                <div id="signal-filter" class="flex flex-wrap gap-1.5 md:mt-1.5">
                    {% for check in checks %}
                    <button type="button" class="filter-pill inline-flex items-center h-6 whitespace-nowrap rounded-full border border-gray-200 px-2 py-0.5 text-[11px] font-medium text-gray-600 transition-colors hover:border-gray-300 hover:text-gray-900" data-value="{{ check.signal }}">{{ check.signal }}</button>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="mt-2 flex items-center justify-between md:hidden">
            <button id="toggle-filters" class="rounded-full border border-gray-200 px-3 py-1 text-[11px] font-semibold text-gray-600 hover:border-gray-300 hover:text-gray-900" type="button" aria-expanded="false">
                More filters
            </button>
        </div>
        <div id="extra-filters" class="mt-2 hidden md:grid md:grid-cols-2 gap-2">
            <div class="min-h-[60px]">
                <label class="inline-flex items-center text-[11px] font-semibold uppercase tracking-wide text-gray-500">Document Type</label>
                <div id="doctype-filter" class="mt-1.5 flex flex-wrap gap-1.5">
                    <button type="button" class="filter-pill inline-flex items-center h-6 whitespace-nowrap rounded-full border border-gray-200 px-2 py-0.5 text-[11px] font-medium text-gray-600 transition-colors hover:border-gray-300 hover:text-gray-900" data-value="resolution">Resolution</button>
                    <button type="button" class="filter-pill inline-flex items-center h-6 whitespace-nowrap rounded-full border border-gray-200 px-2 py-0.5 text-[11px] font-medium text-gray-600 transition-colors hover:border-gray-300 hover:text-gray-900" data-value="proposal">Proposal</button>
                    <button type="button" class="filter-pill inline-flex items-center h-6 whitespace-nowrap rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[11px] font-medium text-slate-600 transition-colors hover:border-slate-300 hover:text-slate-800" data-value="decision">Decision</button>
                </div>
            </div>
            <div class="min-h-[60px]">
                <label class="inline-flex items-center text-[11px] font-semibold uppercase tracking-wide text-gray-500">Implementation Session</label>
                <div id="implementation-filter" class="mt-1.5 flex flex-wrap gap-1.5">
                    {% for session in [85, 84, 83, 82, 81, 80] %}
                    <button type="button" class="filter-pill filter-pill-implementation inline-flex items-center h-6 whitespace-nowrap rounded-full border border-indigo-200 bg-indigo-50 px-2 py-0.5 text-[11px] font-medium text-indigo-700 transition-colors hover:border-indigo-300 hover:text-indigo-800" data-pill="implementation" data-value="{{ session }}">{{ session }}</button>
                    {% endfor %}
                </div>
            </div>
            <div class="min-h-[60px]">
                <label class="inline-flex items-center text-[11px] font-semibold uppercase tracking-wide text-gray-500">Source</label>
                <div id="source-filter" class="mt-1.5 flex flex-wrap gap-1.5">
                    {% for origin_code in origin_order %}
                    {% set origin_label = 'Pl' if origin_code == 'Plenary' else origin_code %}
                    <button type="button" class="filter-pill inline-flex items-center h-6 whitespace-nowrap rounded-full border border-gray-200 px-2 py-0.5 text-[11px] font-medium text-gray-600 transition-colors hover:border-gray-300 hover:text-gray-900" data-value="{{ origin_code }}">{{ origin_label }}</button>
                    {% endfor %}
                </div>
            </div>
            <div class="flex flex-wrap items-end gap-2">
                <button id="group-implementation" class="flex h-8 items-center justify-center rounded-lg border border-indigo-200 bg-indigo-50 px-3 text-[11px] font-semibold text-indigo-700 hover:border-indigo-300 hover:text-indigo-800 transition-colors" type="button">
                    Group by Implementation
                </button>
                <button id="clear-filters" class="flex h-8 items-center justify-center rounded-lg border border-gray-200 px-3 text-[11px] font-semibold text-gray-600 hover:border-gray-300 hover:text-gray-900 transition-colors">
                    Clear filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div id="main-content">
    <!-- Document List -->
    <div id="document-list">
        <div class="space-y-4" id="documents-container">
            {% for doc in documents %}
            {% set is_decision = doc.decision_number is defined %}
            <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors{% if doc.doc_type == 'proposal' %} border-l-4 border-l-amber-400{% elif is_decision %} border-l-4 border-l-slate-400{% endif %}"
                 data-symbol="{{ doc.decision_number if is_decision else doc.symbol }}"
                 data-source="{{ doc.origin|default('') }}"
                 data-status="{{ 'adopted' if doc.doc_type == 'resolution' else 'draft' }}"
                 data-doctype="{{ 'decision' if is_decision else doc.doc_type }}"
                 data-signals="{{ doc.signal_summary.keys()|list|join(',') }}"
                 data-un-url="{{ doc.igov_url if is_decision else doc.un_url }}"
                 data-title="{{ doc.title or '' }}"
                 data-session="{{ doc.session|default('80') }}">
                <!-- Document Header -->
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="font-semibold text-gray-900" data-search>
                                    {{ doc.decision_number if is_decision else doc.symbol }}
                                </span>
                                {% if is_decision %}
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700">
                                    Decision
                                </span>
                                {% elif doc.origin and doc.origin != 'Unknown' %}
                                <span class="text-xs text-gray-500">· {{ doc.origin }}</span>
                                {% endif %}
                                {% if doc.doc_type == 'proposal' %}
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
                                    Draft
                                </span>
                                {% endif %}
                            </div>
                            {% if doc.title %}
                            {% if is_decision %}
                            <p class="text-sm text-gray-600 truncate" title="{{ doc.title }}" data-search>{{ doc.title }}</p>
                            {% else %}
                            {% set title_number = doc.symbol.split('/')[-2:]|join('/') %}
                            {% set display_title = doc.title[title_number|length + 2:] if doc.title.startswith(title_number ~ '. ') else doc.title %}
                            <p class="text-sm text-gray-600 truncate" title="{{ doc.title }}" data-search>{{ display_title }}</p>
                            {% endif %}
                            {% endif %}
                            {% if is_decision %}
                            <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500">
                                {% if doc.meeting_date %}
                                <span>Date {{ doc.meeting_date }}</span>
                                {% endif %}
                                {% if doc.meeting_number %}
                                <span>Meeting {{ doc.meeting_number }}</span>
                                {% endif %}
                                {% if doc.agenda_item %}
                                <span>Agenda {{ doc.agenda_item }}</span>
                                {% endif %}
                                {% if doc.session %}
                                <span>Session {{ doc.session }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            {% if is_decision and doc.igov_url %}
                            <a href="{{ doc.igov_url }}" target="_blank"
                               class="text-xs text-muted hover:text-un-blue transition-colors">
                                View IGov
                            </a>
                            {% elif doc.un_url %}
                            <a href="{{ doc.un_url }}" target="_blank"
                               class="text-xs text-muted hover:text-un-blue transition-colors">
                                View PDF
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Paragraphs -->
                <div class="border-t border-gray-200 expandable-content" id="content-{{ loop.index }}">
                    <div class="px-4 py-3 space-y-3">
                        {% if doc.signal_paragraphs %}
                        {% for para in doc.signal_paragraphs %}
                        {% set primary_signal = para.signals[0] if para.signals else '' %}
                        <div class="para-item text-sm text-gray-900" data-signals="{{ para.signals|join(',') }}">
                            <span class="inline-flex flex-wrap items-center gap-1">
                                {% for signal in para.signals %}
                                <span class="px-1.5 py-0.5 rounded-full text-xs font-medium
                                    {% if signal == 'agenda' %}bg-blue-100 text-blue-800
                                    {% elif signal == 'PGA' %}bg-purple-100 text-purple-800
                                    {% elif signal == 'process' %}bg-amber-100 text-amber-800
                                    {% elif signal == 'report' %}bg-green-100 text-green-800
                                    {% elif signal == 'observer' %}bg-slate-100 text-slate-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">{{ signal }}</span>
                                {% endfor %}
                            </span>
                            {% if para.number %}
                            <span class="ml-1 font-semibold text-gray-700">{{ para.number }}.</span>
                            {% endif %}
                            <span class="text-gray-800" data-paragraph data-search>{{ para.text }}</span>
                        </div>
                        {% endfor %}
                        {% elif doc.signals %}
                        {% for para_num, signals in doc.signals.items() %}
                        {% set primary_signal = signals[0] if signals else '' %}
                        <div class="para-item text-sm text-gray-900" data-signals="{{ signals|join(',') }}">
                            <span class="inline-flex flex-wrap items-center gap-1">
                                {% for signal in signals %}
                                <span class="px-1.5 py-0.5 rounded-full text-xs font-medium
                                    {% if signal == 'agenda' %}bg-blue-100 text-blue-800
                                    {% elif signal == 'PGA' %}bg-purple-100 text-purple-800
                                    {% elif signal == 'process' %}bg-amber-100 text-amber-800
                                    {% elif signal == 'report' %}bg-green-100 text-green-800
                                    {% elif signal == 'observer' %}bg-slate-100 text-slate-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">{{ signal }}</span>
                                {% endfor %}
                            </span>
                            <span class="ml-1 font-semibold text-gray-700">{{ para_num }}.</span>
                            <span class="text-gray-500 italic" data-paragraph data-search>Paragraph text not available for historical sessions.</span>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-sm text-gray-500 italic">
                            No signal data available for this document.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Empty State -->
        <div class="hidden text-center py-12" id="empty-state">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No documents found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or search terms.</p>
        </div>
    </div>

</div>

<!-- Loading Indicator -->
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="loading-overlay">
    <div class="bg-white rounded-lg p-6 flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-un-blue"></div>
        <span class="text-sm text-gray-700">Loading session data...</span>
    </div>
</div>

<script>
// Session data cache
let sessionDataCache = {};
let selectedSessions = [];
let allDocumentsCache = [];

const signalPhraseMap = Object.fromEntries(({{ checks | tojson }} || []).map(check => [check.signal, check.phrases || []]));
const implementationSessionMap = {
    '85': ['eighty-fifth', 'eighty fifth'],
    '84': ['eighty-fourth', 'eighty fourth'],
    '83': ['eighty-third', 'eighty third'],
    '82': ['eighty-second', 'eighty second'],
    '81': ['eighty-first', 'eighty first'],
    '80': ['eightieth']
};

// Filter elements (initialized later)
let sessionSelector, implementationFilter, sourceFilter, signalFilter, doctypeFilter, clearFiltersBtn, groupImplementationBtn;
let groupByImplementation = false;

const activePillClasses = ['bg-un-blue', 'text-white', 'border-un-blue'];
const inactivePillClasses = ['border-gray-200', 'text-gray-600'];
const activeImplementationClasses = ['bg-indigo-600', 'text-white', 'border-indigo-600'];
const inactiveImplementationClasses = ['border-indigo-200', 'text-indigo-700', 'bg-indigo-50'];
const activeDecisionClasses = ['bg-slate-600', 'text-white', 'border-slate-600'];
const inactiveDecisionClasses = ['border-slate-200', 'text-slate-600', 'bg-slate-50'];

function setPillActive(pill, isActive) {
    const isImplementation = pill.dataset.pill === 'implementation';
    const isDecision = pill.dataset.value === 'decision';

    let activeClasses, inactiveClasses;
    if (isImplementation) {
        activeClasses = activeImplementationClasses;
        inactiveClasses = inactiveImplementationClasses;
    } else if (isDecision) {
        activeClasses = activeDecisionClasses;
        inactiveClasses = inactiveDecisionClasses;
    } else {
        activeClasses = activePillClasses;
        inactiveClasses = inactivePillClasses;
    }

    pill.classList.toggle('is-active', isActive);
    activeClasses.forEach(cls => pill.classList.toggle(cls, isActive));
    inactiveClasses.forEach(cls => pill.classList.toggle(cls, !isActive));
}

function getActiveValues(container) {
    return Array.from(container.querySelectorAll('.filter-pill.is-active')).map(pill => pill.dataset.value);
}

function setActiveValues(container, values) {
    const valueSet = new Set(values);
    container.querySelectorAll('.filter-pill').forEach(pill => {
        setPillActive(pill, valueSet.has(pill.dataset.value));
    });
}

function wirePillGroup(container, onChange) {
    container.addEventListener('click', event => {
        const target = event.target.closest('.filter-pill');
        if (!target) {
            return;
        }
        setPillActive(target, !target.classList.contains('is-active'));
        onChange();
    });
}

function updateUrlState() {
    const params = new URLSearchParams();
    const searchQuery = document.getElementById('search-input').value.trim();

    if (searchQuery) {
        params.set('q', searchQuery);
    }

    const sessions = getActiveValues(sessionSelector);
    selectedSessions = sessions;
    const implementations = getActiveValues(implementationFilter);
    const sources = getActiveValues(sourceFilter);
    const signals = getActiveValues(signalFilter);
    const doctypes = getActiveValues(doctypeFilter);

    if (sessions.length > 0) {
        params.set('sessions', sessions.join(','));
    }
    if (implementations.length > 0) {
        params.set('implementation', implementations.join(','));
    }
    if (sources.length > 0) {
        params.set('sources', sources.join(','));
    }
    if (signals.length > 0) {
        params.set('signals', signals.join(','));
    }
    if (doctypes.length > 0) {
        params.set('doctypes', doctypes.join(','));
    }
    if (groupByImplementation) {
        params.set('group', 'implementation');
    }

    const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
    window.history.replaceState({}, '', newUrl);
}

function applyFiltersFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const searchQuery = params.get('q') || '';
    document.getElementById('search-input').value = searchQuery;

    const sessions = params.get('sessions');
    const sources = params.get('sources');
    const signals = params.get('signals');
    const doctypes = params.get('doctypes');
    const implementations = params.get('implementation');
    const group = params.get('group');

    if (sessions) {
        setActiveValues(sessionSelector, sessions.split(','));
    }
    if (implementations) {
        setActiveValues(implementationFilter, implementations.split(','));
    }
    if (sources) {
        setActiveValues(sourceFilter, sources.split(','));
    }
    if (signals) {
        setActiveValues(signalFilter, signals.split(','));
    }
    if (doctypes) {
        setActiveValues(doctypeFilter, doctypes.split(','));
    }

    groupByImplementation = group === 'implementation';
    if (groupImplementationBtn) {
        groupImplementationBtn.classList.toggle('bg-indigo-600', groupByImplementation);
        groupImplementationBtn.classList.toggle('text-white', groupByImplementation);
        groupImplementationBtn.classList.toggle('border-indigo-600', groupByImplementation);
        groupImplementationBtn.classList.toggle('bg-indigo-50', !groupByImplementation);
        groupImplementationBtn.classList.toggle('text-indigo-700', !groupByImplementation);
        groupImplementationBtn.classList.toggle('border-indigo-200', !groupByImplementation);
    }

    selectedSessions = getActiveValues(sessionSelector);
}

// Filter functionality
function applyFilters() {
    const selectedSources = getActiveValues(sourceFilter);
    const selectedSignals = getActiveValues(signalFilter);
    const selectedDoctypes = getActiveValues(doctypeFilter);
    const selectedImplementations = getActiveValues(implementationFilter);
    selectedSessions = getActiveValues(sessionSelector);
    const searchQuery = document.getElementById('search-input').value.toLowerCase();

    const documentCards = document.querySelectorAll('.document-card');
    const emptyState = document.getElementById('empty-state');

    let visibleCount = 0;

    documentCards.forEach(card => {
        const cardSource = card.dataset.source;
        const cardDoctype = card.dataset.doctype;
        const cardSession = card.dataset.session;

        const sourceMatch = selectedSources.length === 0 || selectedSources.includes(cardSource);
        const doctypeMatch = selectedDoctypes.length === 0 || selectedDoctypes.includes(cardDoctype);
        const sessionMatch = selectedSessions.length === 0 || selectedSessions.includes(cardSession);

        let visibleParagraphs = 0;
        const paragraphs = card.querySelectorAll('.para-item');
        paragraphs.forEach(para => {
            const paraSignals = para.dataset.signals.split(',').filter(s => s);
            const paraText = Array.from(para.querySelectorAll('[data-search]'))
                .map(node => node.textContent || '')
                .join(' ')
                .toLowerCase();

            const signalMatch = selectedSignals.length === 0 || selectedSignals.some(s => paraSignals.includes(s));
            const searchMatch = searchQuery === '' || paraText.includes(searchQuery);
            const implementationMatch = selectedImplementations.length === 0 || selectedImplementations.some(session => {
                const phrases = implementationSessionMap[session] || [];
                return phrases.some(phrase => paraText.includes(phrase));
            });

            if (signalMatch && searchMatch && implementationMatch) {
                para.classList.remove('hidden');
                visibleParagraphs += 1;
            } else {
                para.classList.add('hidden');
            }
        });

        const cardMatch = sourceMatch && doctypeMatch && sessionMatch && visibleParagraphs > 0;

        if (cardMatch) {
            card.classList.remove('hidden');
            visibleCount += 1;
        } else {
            card.classList.add('hidden');
        }
    });

    if (visibleCount === 0) {
        emptyState.classList.remove('hidden');
        document.getElementById('documents-container').classList.add('hidden');
    } else {
        emptyState.classList.add('hidden');
        document.getElementById('documents-container').classList.remove('hidden');
    }

    if (groupByImplementation) {
        document.querySelectorAll('.implementation-group').forEach(group => {
            const visibleCards = group.querySelectorAll('.document-card:not(.hidden)');
            group.classList.toggle('hidden', visibleCards.length === 0);
        });
    }

    applySignalHighlights();
    applyImplementationHighlights();
    applySearchHighlights(searchQuery);
    updateUrlState();
}

function getImplementationSessionForText(text) {
    const lowered = text.toLowerCase();
    const orderedSessions = Object.keys(implementationSessionMap).sort((a, b) => Number(b) - Number(a));
    for (const session of orderedSessions) {
        const phrases = implementationSessionMap[session] || [];
        if (phrases.some(phrase => lowered.includes(phrase))) {
            return session;
        }
    }
    return null;
}

function getImplementationSessionForDoc(doc) {
    const paragraphTexts = [];

    if (Array.isArray(doc.signal_paragraphs)) {
        doc.signal_paragraphs.forEach(para => {
            if (para.text) {
                paragraphTexts.push(para.text);
            }
        });
    }

    if (paragraphTexts.length === 0 && doc.paragraphs) {
        Object.values(doc.paragraphs).forEach(text => {
            if (text) {
                paragraphTexts.push(text);
            }
        });
    }

    const combinedText = paragraphTexts.join(' ');
    return combinedText ? getImplementationSessionForText(combinedText) : null;
}

const basePath = window.location.pathname.replace(/\/[^/]*$/, '');

function getSessionDataUrl(session) {
    if (session === 'current' || session === '80') {
        return `${basePath}/data-consolidated.json`;
    }
    return `${basePath}/sessions/${session}/data-consolidated.json`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function applySearchHighlights(query) {
    const highlightTargets = document.querySelectorAll('[data-search]');
    const trimmedQuery = query.trim();

    highlightTargets.forEach(target => {
        target.querySelectorAll('mark.search-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        if (!trimmedQuery) {
            return;
        }

        highlightQueryInElement(target, trimmedQuery, 'search-highlight bg-red-100 text-red-900 rounded px-0.5');
    });
}

function highlightQueryInElement(element, query, className) {
    const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(escapedQuery, 'gi');
    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null);
    const textNodes = [];

    while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
    }

    textNodes.forEach(node => {
        const text = node.nodeValue;
        if (!text || !regex.test(text)) {
            return;
        }
        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        text.replace(regex, (match, index) => {
            fragment.appendChild(document.createTextNode(text.slice(lastIndex, index)));
            const mark = document.createElement('mark');
            mark.className = className;
            mark.textContent = match;
            fragment.appendChild(mark);
            lastIndex = index + match.length;
            return match;
        });
        fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
        node.parentNode.replaceChild(fragment, node);
    });
}

function applySignalHighlights() {
    const paragraphTargets = document.querySelectorAll('[data-paragraph]');

    paragraphTargets.forEach(target => {
        target.querySelectorAll('mark.signal-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        const paraItem = target.closest('.para-item');
        const signals = paraItem ? paraItem.dataset.signals.split(',').filter(Boolean) : [];

        signals.forEach(signal => {
            const phrases = signalPhraseMap[signal] || [];
            phrases.sort((a, b) => b.length - a.length).forEach(phrase => {
                highlightQueryInElement(target, phrase, `signal-highlight ${getSignalHighlightClass(signal)} rounded px-0.5`);
            });
        });
    });
}

function applyImplementationHighlights() {
    const paragraphTargets = document.querySelectorAll('[data-paragraph]');

    paragraphTargets.forEach(target => {
        target.querySelectorAll('mark.implementation-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        Object.values(implementationSessionMap).forEach(phrases => {
            phrases.forEach(phrase => {
                highlightQueryInElement(target, phrase, 'implementation-highlight bg-indigo-100 text-indigo-900 rounded px-0.5');
            });
        });
    });
}

function buildSignalParagraphs(doc) {
    const paragraphs = doc.paragraphs || {};
    const signals = doc.signals || {};
    const signalParagraphs = [];

    Object.entries(signals).forEach(([paraNum, paraSignals]) => {
        if (!paraSignals || paraSignals.length === 0) {
            return;
        }
        signalParagraphs.push({
            number: paraNum,
            text: paragraphs[paraNum] || '',
            signals: paraSignals,
        });
    });

    signalParagraphs.sort((a, b) => Number(a.number) - Number(b.number));
    return signalParagraphs;
}

function buildSignalSummary(signalParagraphs) {
    const summary = {};
    signalParagraphs.forEach(para => {
        (para.signals || []).forEach(signal => {
            summary[signal] = (summary[signal] || 0) + 1;
        });
    });
    return summary;
}

function normalizeDocument(doc, session) {
    const signalParagraphs = doc.signal_paragraphs || buildSignalParagraphs(doc);
    const signalSummary = doc.signal_summary && Object.keys(doc.signal_summary).length > 0
        ? doc.signal_summary
        : buildSignalSummary(signalParagraphs);

    // Handle decisions vs resolutions/proposals
    const isDecision = !!doc.decision_number;
    const symbol = isDecision ? doc.decision_number : doc.symbol;
    const derivedSession = isDecision ? doc.session : (getSessionFromSymbol(symbol) || session);

    return {
        ...doc,
        session: derivedSession || session,
        signal_paragraphs: signalParagraphs,
        signal_summary: signalSummary,
        doc_type: isDecision ? 'decision' : doc.doc_type,
    };
}

function getSessionFromSymbol(symbol) {
    if (!symbol) {
        return null;
    }
    const resMatch = symbol.match(/^A\/RES\/(\d+)/);
    if (resMatch) {
        return resMatch[1];
    }
    const committeeMatch = symbol.match(/^A\/C\.\d+\/(\d+)\/L\./);
    if (committeeMatch) {
        return committeeMatch[1];
    }
    const plenaryMatch = symbol.match(/^A\/(\d+)\/L\./);
    if (plenaryMatch) {
        return plenaryMatch[1];
    }
    return null;
}

function getDisplayTitle(doc) {
    if (!doc.title) {
        return '';
    }
    // For decisions, return full title
    if (doc.decision_number) {
        return doc.title;
    }
    const parts = (doc.symbol || '').split('/');
    const numberPart = parts.length >= 2 ? `${parts[parts.length - 2]}/${parts[parts.length - 1]}` : '';
    if (numberPart && doc.title.startsWith(`${numberPart}. `)) {
        return doc.title.slice(numberPart.length + 2);
    }
    return doc.title;
}

function getSessionSortValue(session) {
    if (session === 'current') {
        return 80;
    }
    const parsed = Number.parseInt(session, 10);
    return Number.isNaN(parsed) ? -1 : parsed;
}

function getDocumentSortKey(doc) {
    const sessionValue = getSessionSortValue(doc.session);
    const isDecision = !!doc.decision_number;
    const symbol = isDecision ? doc.decision_number : (doc.symbol || '');
    const isProposal = doc.doc_type === 'proposal' || symbol.includes('/L.');
    const isResolution = doc.doc_type === 'resolution' || symbol.includes('/RES/');

    // Category ranks: proposals (0-1), resolutions (2), decisions (3)
    let categoryRank = 4;
    let committeeRank = 99;
    let docNumber = Number.MAX_SAFE_INTEGER;

    if (isDecision) {
        categoryRank = 3;
        // Extract decision number for sorting
        const decMatch = symbol.match(/(\d+)\/(\d+)/);
        if (decMatch) {
            docNumber = Number.parseInt(decMatch[2], 10);
        }
    } else if (isProposal) {
        const plenaryMatch = symbol.match(/^A\/(\d+)\/L\.(\d+)/);
        if (plenaryMatch) {
            categoryRank = 0;
            docNumber = Number.parseInt(plenaryMatch[2], 10);
        } else {
            const committeeMatch = symbol.match(/^A\/C\.(\d+)\/(\d+)\/L\.(\d+)/);
            if (committeeMatch) {
                categoryRank = 1;
                committeeRank = Number.parseInt(committeeMatch[1], 10);
                docNumber = Number.parseInt(committeeMatch[3], 10);
            }
        }
    } else if (isResolution) {
        const resolutionMatch = symbol.match(/^A\/RES\/(\d+)\/(\d+)/);
        if (resolutionMatch) {
            categoryRank = 2;
            docNumber = Number.parseInt(resolutionMatch[2], 10);
        }
    }

    return {
        sessionValue,
        categoryRank,
        committeeRank,
        docNumber,
        symbol,
    };
}

// Initialize the explorer
document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    initializeSearch();
    initializeSessionSelector();
});

// Session selector
function initializeSessionSelector() {
    sessionSelector = document.getElementById('session-selector');

    // Populate session options dynamically
    populateSessionOptions(sessionSelector).then(() => {
        applyFiltersFromUrl();
        wirePillGroup(sessionSelector, () => {
            selectedSessions = getActiveValues(sessionSelector);
            loadSelectedSessions();
        });
        selectedSessions = getActiveValues(sessionSelector);
        loadSelectedSessions();
    });
}

// Populate session selector with available sessions
async function populateSessionOptions(selector) {
    selector.innerHTML = '';

    const currentButton = document.createElement('button');
    currentButton.type = 'button';
    currentButton.className = 'filter-pill inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-xs font-medium text-gray-600 transition-colors hover:border-gray-300 hover:text-gray-900';
    currentButton.dataset.value = '80';
    currentButton.textContent = '80';
    selector.appendChild(currentButton);

    // Check which session directories exist (in reverse chronological order)
    const availableSessions = [79, 78, 77, 76, 75, 74, 73, 72, 71, 70, 69, 68, 67, 66, 65, 64, 63, 62, 61, 60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50];

    for (const session of availableSessions) {
        try {
            // Check if session data exists
            const response = await fetch(getSessionDataUrl(session.toString()), { method: 'HEAD' });
            if (response.ok) {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'filter-pill inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-xs font-medium text-gray-600 transition-colors hover:border-gray-300 hover:text-gray-900';
                button.dataset.value = session.toString();
                button.textContent = session.toString();
                selector.appendChild(button);
            }
        } catch (error) {
            // Session not available, skip
            console.log(`Session ${session} not available`);
        }
    }

    setActiveValues(selector, []);
    selectedSessions = [];
}

// Load all selected sessions and combine their documents
async function loadSelectedSessions() {
    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.classList.remove('hidden');

    try {
        const allDocuments = [];
        const sessionsToLoad = selectedSessions.length
            ? selectedSessions
            : Array.from(sessionSelector.querySelectorAll('.filter-pill')).map(pill => pill.dataset.value);

        for (const session of sessionsToLoad) {
            const sessionKey = session.toString();

            // Load session data via AJAX
            if (!sessionDataCache[sessionKey]) {
                const response = await fetch(getSessionDataUrl(sessionKey));
                if (!response.ok) throw new Error(`Failed to load session ${sessionKey} data`);
                sessionDataCache[sessionKey] = await response.json();
            }

            // Add session documents with session identifier
            const sessionData = sessionDataCache[sessionKey];
            if (!sessionData.documents || !Array.isArray(sessionData.documents)) {
                console.error(`Invalid session data format for ${sessionKey}: missing documents array`);
                continue;
            }

            const sessionDocs = sessionData.documents
                .map(doc => normalizeDocument(doc, sessionKey))
                .filter(doc => doc.signal_paragraphs.length > 0 || Object.keys(doc.signal_summary || {}).length > 0);

            allDocuments.push(...sessionDocs);
        }

        // Render combined documents from selected sessions
        renderCombinedDocuments(allDocuments);

    } catch (error) {
        console.error('Error loading selected sessions:', error);
        alert('Failed to load session data. Please try again.');
    } finally {
        loadingOverlay.classList.add('hidden');
    }
}

// Render documents from multiple sessions
function renderCombinedDocuments(allDocuments) {
    // Sort documents by our unified sorting logic
    allDocuments.sort((a, b) => {
        const keyA = getDocumentSortKey(a);
        const keyB = getDocumentSortKey(b);

        if (keyA.sessionValue !== keyB.sessionValue) {
            return keyA.sessionValue - keyB.sessionValue;
        }
        if (keyA.categoryRank !== keyB.categoryRank) {
            return keyA.categoryRank - keyB.categoryRank;
        }
        if (keyA.committeeRank !== keyB.committeeRank) {
            return keyA.committeeRank - keyB.committeeRank;
        }
        if (keyA.docNumber !== keyB.docNumber) {
            return keyA.docNumber - keyB.docNumber;
        }
        return keyA.symbol.localeCompare(keyB.symbol);
    });

    allDocumentsCache = [...allDocuments];

    const container = document.getElementById('documents-container');

    const renderDocumentCard = doc => {
        const isDecision = !!doc.decision_number;
        const signalParagraphs = doc.signal_paragraphs || [];
        const title = escapeHtml(getDisplayTitle(doc));
        const symbol = escapeHtml(isDecision ? doc.decision_number : (doc.symbol || ''));

        const paragraphsHtml = signalParagraphs.length
            ? signalParagraphs.map(para => `
                <div class="para-item text-sm text-gray-900" data-signals="${(para.signals || []).join(',')}">
                    <span class="inline-flex flex-wrap items-center gap-1">
                        ${(para.signals || []).map(signal => `
                            <span class="px-1.5 py-0.5 rounded-full text-xs font-medium ${getSignalColor(signal)}">${signal}</span>
                        `).join('')}
                    </span>
                    ${para.number ? `<span class="ml-1 font-semibold text-gray-700">${escapeHtml(String(para.number))}.</span>` : ''}
                    <span class="text-gray-800" data-paragraph data-search>${escapeHtml(para.text)}</span>
                </div>
            `).join('')
            : '<div class="text-sm text-gray-500 italic">No signal data available for this document.</div>';

        const borderClass = isDecision ? ' border-l-4 border-l-slate-400' : (doc.doc_type === 'proposal' ? ' border-l-4 border-l-amber-400' : '');
        const docTypeLabel = isDecision ? 'decision' : doc.doc_type;
        const externalUrl = isDecision ? doc.igov_url : doc.un_url;
        const linkLabel = isDecision ? 'View IGov' : 'View PDF';

        // Decision metadata
        let metadataHtml = '';
        if (isDecision) {
            const parts = [];
            if (doc.meeting_date) parts.push(`Date ${escapeHtml(doc.meeting_date)}`);
            if (doc.meeting_number) parts.push(`Meeting ${escapeHtml(String(doc.meeting_number))}`);
            if (doc.agenda_item) parts.push(`Agenda ${escapeHtml(doc.agenda_item)}`);
            if (doc.session) parts.push(`Session ${escapeHtml(String(doc.session))}`);
            if (parts.length) {
                metadataHtml = `<div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500">${parts.map(p => `<span>${p}</span>`).join('')}</div>`;
            }
        }

        return `
            <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors${borderClass}"
                 data-symbol="${symbol}"
                 data-source="${doc.origin || doc.source || ''}"
                 data-status="${doc.doc_type === 'resolution' ? 'adopted' : 'draft'}"
                 data-doctype="${docTypeLabel}"
                 data-signals="${Object.keys(doc.signal_summary || {}).join(',')}"
                 data-session="${doc.session}"
                 data-un-url="${externalUrl || ''}"
                 data-title="${title}">
                <!-- Document Header -->
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="font-semibold text-gray-900" data-search>
                                    ${symbol}
                                </span>
                                ${isDecision ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700">Decision</span>' : ''}
                                ${doc.origin && doc.origin !== 'Unknown' && !isDecision ? `<span class="text-xs text-gray-500">· ${escapeHtml(doc.origin)}</span>` : ''}
                                ${doc.doc_type === 'proposal' ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Draft</span>' : ''}
                            </div>
                            ${title ? `<p class="text-sm text-gray-600 truncate" title="${title}" data-search>${title}</p>` : ''}
                            ${metadataHtml}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${externalUrl ? `<a href="${externalUrl}" target="_blank" class="text-xs text-muted hover:text-un-blue transition-colors">${linkLabel}</a>` : ''}
                        </div>
                    </div>
                </div>

                <!-- Paragraphs -->
                <div class="border-t border-gray-200 expandable-content">
                    <div class="px-4 py-3 space-y-3">
                        ${paragraphsHtml}
                    </div>
                </div>
            </div>
        `;
    };

    if (!groupByImplementation) {
        container.innerHTML = allDocuments.map(renderDocumentCard).join('');
        initializeDocumentCards();
        applyFilters();
        return;
    }

    const groupOrder = Object.keys(implementationSessionMap)
        .sort((a, b) => Number(b) - Number(a))
        .concat('Unspecified');
    const groupedDocs = new Map(groupOrder.map(key => [key, []]));

    allDocuments.forEach(doc => {
        const groupKey = getImplementationSessionForDoc(doc) || 'Unspecified';
        if (!groupedDocs.has(groupKey)) {
            groupedDocs.set(groupKey, []);
        }
        groupedDocs.get(groupKey).push(doc);
    });

    const groupedHtml = Array.from(groupedDocs.entries())
        .filter(([, docs]) => docs.length > 0)
        .map(([groupKey, docs]) => {
            const label = groupKey === 'Unspecified'
                ? 'Implementation Session: Unspecified'
                : `Implementation Session ${groupKey}`;
            return `
                <div class="implementation-group space-y-4" data-group="${groupKey}">
                    <div class="text-xs font-semibold uppercase tracking-wide text-indigo-700">${label}</div>
                    ${docs.map(renderDocumentCard).join('')}
                </div>
            `;
        })
        .join('');

    container.innerHTML = groupedHtml;
    initializeDocumentCards();
    applyFilters();
}



// Helper functions
function getOriginColor(origin) {
    const colors = {
        'Plenary': 'bg-amber-50 text-amber-700',
        'C1': 'bg-red-50 text-red-700',
        'C2': 'bg-green-50 text-green-700',
        'C3': 'bg-blue-50 text-blue-700',
        'C4': 'bg-purple-50 text-purple-700',
        'C5': 'bg-orange-50 text-orange-700',
        'C6': 'bg-teal-50 text-teal-700'
    };
    return colors[origin] || 'bg-gray-100 text-gray-700';
}

function getSignalColor(signal) {
    const colors = {
        'agenda': 'bg-blue-100 text-blue-800',
        'PGA': 'bg-purple-100 text-purple-800',
        'process': 'bg-amber-100 text-amber-800',
        'report': 'bg-green-100 text-green-800',
        'observer': 'bg-slate-100 text-slate-800'
    };
    return colors[signal] || 'bg-gray-100 text-gray-800';
}

function getSignalHighlightClass(signal) {
    const colors = {
        'agenda': 'bg-blue-50 text-blue-900',
        'PGA': 'bg-purple-50 text-purple-900',
        'process': 'bg-amber-50 text-amber-900',
        'report': 'bg-green-50 text-green-900',
        'observer': 'bg-slate-50 text-slate-900'
    };
    return colors[signal] || 'text-gray-800';
}

// Search functionality
function initializeSearch() {
    const searchInput = document.getElementById('search-input');

    searchInput.addEventListener('input', function() {
        applyFilters();
    });
}

// Filter functionality (similar to original but with search)
function initializeFilters() {
    sessionSelector = document.getElementById('session-selector');
    implementationFilter = document.getElementById('implementation-filter');
    sourceFilter = document.getElementById('source-filter');
    signalFilter = document.getElementById('signal-filter');
    doctypeFilter = document.getElementById('doctype-filter');
    clearFiltersBtn = document.getElementById('clear-filters');
    groupImplementationBtn = document.getElementById('group-implementation');
    const toggleFiltersBtn = document.getElementById('toggle-filters');
    const extraFilters = document.getElementById('extra-filters');

    wirePillGroup(implementationFilter, applyFilters);
    wirePillGroup(sourceFilter, applyFilters);
    wirePillGroup(signalFilter, applyFilters);
    wirePillGroup(doctypeFilter, applyFilters);

    if (toggleFiltersBtn && extraFilters) {
        toggleFiltersBtn.addEventListener('click', function() {
            const isHidden = extraFilters.classList.contains('hidden');
            extraFilters.classList.toggle('hidden', !isHidden);
            toggleFiltersBtn.textContent = isHidden ? 'Hide filters' : 'More filters';
            toggleFiltersBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        });
    }

    groupImplementationBtn.addEventListener('click', function() {
        groupByImplementation = !groupByImplementation;
        groupImplementationBtn.classList.toggle('bg-indigo-600', groupByImplementation);
        groupImplementationBtn.classList.toggle('text-white', groupByImplementation);
        groupImplementationBtn.classList.toggle('border-indigo-600', groupByImplementation);
        groupImplementationBtn.classList.toggle('bg-indigo-50', !groupByImplementation);
        groupImplementationBtn.classList.toggle('text-indigo-700', !groupByImplementation);
        groupImplementationBtn.classList.toggle('border-indigo-200', !groupByImplementation);

        if (allDocumentsCache.length > 0) {
            renderCombinedDocuments(allDocumentsCache);
        } else {
            applyFilters();
        }
    });

    clearFiltersBtn.addEventListener('click', function() {
        setActiveValues(sessionSelector, []);
        setActiveValues(implementationFilter, []);
        setActiveValues(sourceFilter, []);
        setActiveValues(signalFilter, []);
        setActiveValues(doctypeFilter, []);
        selectedSessions = [];
        groupByImplementation = false;
        groupImplementationBtn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
        groupImplementationBtn.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
        document.getElementById('search-input').value = '';
        loadSelectedSessions();
    });
}

// Document card interactions
function initializeDocumentCards() {
    // No click interactions needed; paragraphs are expanded by default.
}

// Initialize document cards on page load
initializeDocumentCards();
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }} · <a href="./data-consolidated.json" class="text-un-blue hover:underline">JSON API</a>
{% endblock %}
