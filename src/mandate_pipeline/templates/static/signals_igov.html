{% extends "base.html" %}

{% block title %}IGov Decision Signal Explorer - Mandate Pipeline{% endblock %}

{% block nav_index %}./index.html{% endblock %}
{% block nav_signals %}./signals-unified.html{% endblock %}
{% block nav_signals_info %}../signals-info.html{% endblock %}
{% block nav_api %}../data.json{% endblock %}

{% block content %}
<div class="mb-4 hidden sm:block">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">IGov Decision Signal Explorer</h1>
</div>

<div class="sticky top-20 z-10 space-y-3 bg-white/95 pb-3 backdrop-blur">
    <div class="rounded-xl border border-gray-200 bg-gray-50/80 p-3 shadow-sm">
        <label for="search-input" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Search</label>
        <input type="text" id="search-input" placeholder="Search by decision number, title, or content..."
               class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
    </div>

    <div class="rounded-xl border border-gray-200 bg-white p-3 shadow-sm">
        <div class="grid gap-3 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto] md:items-end">
            <div>
                <label for="session-filter" class="inline-flex items-center text-[11px] font-semibold uppercase tracking-wide text-gray-500">Session</label>
                <select id="session-filter" multiple class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="6">
                    {% for session_number in sessions %}
                    <option value="{{ session_number }}">Session {{ session_number }}</option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-[11px] text-gray-400">Select one or more sessions.</p>
            </div>
            <div>
                <label for="signal-filter" class="inline-flex items-center text-[11px] font-semibold uppercase tracking-wide text-gray-500">Signal</label>
                <select id="signal-filter" multiple class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="6">
                    {% for check in checks %}
                    <option value="{{ check.signal }}">{{ check.signal }}</option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-[11px] text-gray-400">Filter by signal type.</p>
            </div>
            <div class="flex items-center justify-start md:justify-end">
                <button id="clear-filters" class="rounded-full border border-gray-200 px-3 py-1 text-[11px] font-semibold text-gray-600 hover:border-gray-300 hover:text-gray-900" type="button">
                    Clear filters
                </button>
            </div>
        </div>
    </div>
</div>

<div id="main-content">
    <div id="document-list">
        <div class="space-y-4" id="documents-container">
            {% for doc in documents %}
            <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors"
                 data-symbol="{{ doc.decision_number }}"
                 data-title="{{ doc.title or '' }}"
                 data-session="{{ doc.session }}"
                 data-signals="{{ doc.signal_summary.keys()|list|join(',') }}">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="font-semibold text-gray-900" data-search>{{ doc.decision_number }}</span>
                                {% if doc.decision_type %}
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700">{{ doc.decision_type }}</span>
                                {% endif %}
                            </div>
                            {% if doc.title %}
                            <p class="text-sm text-gray-600 truncate" title="{{ doc.title }}" data-search>{{ doc.title }}</p>
                            {% endif %}
                            <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500">
                                {% if doc.meeting_date %}
                                <span>Adopted {{ doc.meeting_date }}</span>
                                {% endif %}
                                {% if doc.meeting_number %}
                                <span>Meeting {{ doc.meeting_number }}</span>
                                {% endif %}
                                {% if doc.agenda_item %}
                                <span>Agenda {{ doc.agenda_item }}</span>
                                {% endif %}
                                {% if doc.session %}
                                <span>Session {{ doc.session }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            {% if doc.igov_url %}
                            <a href="{{ doc.igov_url }}" target="_blank"
                               class="text-xs text-muted hover:text-un-blue transition-colors">
                                View IGov
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-200 expandable-content">
                    <div class="px-4 py-3 space-y-3">
                        {% for para in doc.signal_paragraphs %}
                        <div class="para-item text-sm text-gray-900" data-signals="{{ para.signals|join(',') }}">
                            <span class="inline-flex flex-wrap items-center gap-1">
                                {% for signal in para.signals %}
                                <span class="px-1.5 py-0.5 rounded-full text-xs font-medium
                                    {% if signal == 'agenda' %}bg-blue-100 text-blue-800
                                    {% elif signal == 'PGA' %}bg-purple-100 text-purple-800
                                    {% elif signal == 'process' %}bg-amber-100 text-amber-800
                                    {% elif signal == 'report' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">{{ signal }}</span>
                                {% endfor %}
                            </span>
                            <span class="ml-1 font-semibold text-gray-700">{{ para.number }}.</span>
                            <span class="text-gray-800" data-paragraph data-search>{{ para.text }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="hidden text-center py-12" id="empty-state">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No decisions found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or search terms.</p>
        </div>
    </div>
</div>

<script>
const signalPhraseMap = Object.fromEntries(({{ checks | tojson }} || []).map(check => [check.signal, check.phrases || []]));

function getSelectedValues(selectElement) {
    return Array.from(selectElement.selectedOptions).map(option => option.value);
}

function highlightQueryInElement(element, query, className) {
    const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(escapedQuery, 'gi');
    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null);
    const textNodes = [];

    while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
    }

    textNodes.forEach(node => {
        const text = node.nodeValue;
        if (!text || !regex.test(text)) {
            return;
        }
        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        text.replace(regex, (match, index) => {
            fragment.appendChild(document.createTextNode(text.slice(lastIndex, index)));
            const mark = document.createElement('mark');
            mark.className = className;
            mark.textContent = match;
            fragment.appendChild(mark);
            lastIndex = index + match.length;
            return match;
        });
        fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
        node.parentNode.replaceChild(fragment, node);
    });
}

function applySearchHighlights(query) {
    const highlightTargets = document.querySelectorAll('[data-search]');
    const trimmedQuery = query.trim();

    highlightTargets.forEach(target => {
        target.querySelectorAll('mark.search-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        if (!trimmedQuery) {
            return;
        }

        highlightQueryInElement(target, trimmedQuery, 'search-highlight bg-red-100 text-red-900 rounded px-0.5');
    });
}

function getSignalHighlightClass(signal) {
    const colors = {
        'agenda': 'bg-blue-50 text-blue-900',
        'PGA': 'bg-purple-50 text-purple-900',
        'process': 'bg-amber-50 text-amber-900',
        'report': 'bg-green-50 text-green-900',
        'observer': 'bg-slate-50 text-slate-900'
    };
    return colors[signal] || 'text-gray-800';
}

function applySignalHighlights() {
    const paragraphTargets = document.querySelectorAll('[data-paragraph]');

    paragraphTargets.forEach(target => {
        target.querySelectorAll('mark.signal-highlight').forEach(mark => {
            mark.replaceWith(mark.textContent);
        });

        const paraItem = target.closest('.para-item');
        const signals = paraItem ? paraItem.dataset.signals.split(',').filter(Boolean) : [];

        signals.forEach(signal => {
            const phrases = signalPhraseMap[signal] || [];
            phrases.sort((a, b) => b.length - a.length).forEach(phrase => {
                highlightQueryInElement(target, phrase, `signal-highlight ${getSignalHighlightClass(signal)} rounded px-0.5`);
            });
        });
    });
}

function applyFilters() {
    const selectedSessions = getSelectedValues(document.getElementById('session-filter'));
    const selectedSignals = getSelectedValues(document.getElementById('signal-filter'));
    const searchQuery = document.getElementById('search-input').value.toLowerCase();

    const documentCards = document.querySelectorAll('.document-card');
    const emptyState = document.getElementById('empty-state');
    let visibleCount = 0;

    documentCards.forEach(card => {
        const cardSession = card.dataset.session;
        const cardSignals = card.dataset.signals.split(',').filter(s => s);
        const cardSearchText = [card.dataset.symbol || '', card.dataset.title || ''].join(' ').toLowerCase();

        const sessionMatch = selectedSessions.length === 0 || selectedSessions.includes(cardSession);
        const signalMatch = selectedSignals.length === 0 || selectedSignals.some(s => cardSignals.includes(s));
        const searchMatch = searchQuery === '' || cardSearchText.includes(searchQuery);

        let visibleParagraphs = 0;
        const paragraphs = card.querySelectorAll('.para-item');
        paragraphs.forEach(para => {
            const paraSignals = para.dataset.signals.split(',').filter(s => s);
            const paraText = Array.from(para.querySelectorAll('[data-search]'))
                .map(node => node.textContent || '')
                .join(' ')
                .toLowerCase();
            const paragraphSignalMatch = selectedSignals.length === 0 || selectedSignals.some(s => paraSignals.includes(s));
            const paragraphSearchMatch = searchQuery === '' || paraText.includes(searchQuery);

            if (paragraphSignalMatch && paragraphSearchMatch) {
                para.classList.remove('hidden');
                visibleParagraphs += 1;
            } else {
                para.classList.add('hidden');
            }
        });

        const cardMatch = sessionMatch && signalMatch && searchMatch && visibleParagraphs > 0;
        if (cardMatch) {
            card.classList.remove('hidden');
            visibleCount += 1;
        } else {
            card.classList.add('hidden');
        }
    });

    emptyState.classList.toggle('hidden', visibleCount > 0);
    document.getElementById('documents-container').classList.toggle('hidden', visibleCount === 0);

    applySignalHighlights();
    applySearchHighlights(searchQuery);
}

document.addEventListener('DOMContentLoaded', function() {
    const sessionFilter = document.getElementById('session-filter');
    const signalFilter = document.getElementById('signal-filter');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const searchInput = document.getElementById('search-input');

    sessionFilter.addEventListener('change', applyFilters);
    signalFilter.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);

    clearFiltersBtn.addEventListener('click', function() {
        Array.from(sessionFilter.options).forEach(option => {
            option.selected = false;
        });
        Array.from(signalFilter.options).forEach(option => {
            option.selected = false;
        });
        searchInput.value = '';
        applyFilters();
    });

    applyFilters();
});
</script>
{% endblock %}

{% block footer %}
Generated {{ generated_at }} Â· IGov decisions explorer
{% endblock %}
