<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Signals Explorer - Mandate Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lunr/lunr.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'un-blue': '#009edb',
                        'un-blue-dark': '#0077a8',
                        'muted': '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        ::selection { background: rgba(0, 158, 219, 0.2); }
        .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    </style>
</head>
<body class="min-h-screen bg-white text-gray-900 font-sans antialiased">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100">
        <div class="max-w-5xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="./index.html" class="flex items-center gap-3 group">
                    <div class="w-9 h-9 rounded-lg bg-un-blue flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <span class="text-lg font-semibold text-gray-900 group-hover:text-un-blue transition-colors">Mandate Pipeline</span>
                </a>
                <nav class="flex items-center gap-6">
                    <a href="./signals.html" class="text-muted hover:text-un-blue transition-colors text-sm font-medium">Browser</a>
                    <a href="./signals-info.html" class="text-muted hover:text-un-blue transition-colors text-sm font-medium">About Signals</a>
                    <a href="./sessions/index.html" class="text-muted hover:text-un-blue transition-colors text-sm font-medium">Historical Sessions</a>
                    <a href="./data.json" class="text-muted hover:text-un-blue transition-colors text-sm font-medium">API</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="max-w-5xl mx-auto px-6 py-10">
        
<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Unified Signals Explorer</h1>
    <p class="mt-2 text-muted" id="stats-text">
        0 paragraphs across 0 resolutions
    </p>
</div>

<!-- Session Selector and Search -->
<div class="mb-8 flex flex-wrap gap-4 items-end">
    <div class="flex-1 min-w-[200px]">
        <label for="session-selector" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Sessions</label>
        <select id="session-selector" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="4">
            <option value="current" selected>Current Session</option>
            <option value="79" selected>Session 79</option>
            <option value="78" selected>Session 78</option>
        </select>
        <p class="mt-1 text-xs text-gray-500">Hold Ctrl/Cmd to select multiple</p>
    </div>
    <div class="flex-1 min-w-[300px]">
        <label for="search-input" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Search Documents</label>
        <input type="text" id="search-input" placeholder="Search by symbol, title, or content..."
               class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent">
    </div>
</div>

<!-- Filter Controls -->
<div class="mb-8 flex flex-wrap gap-4 items-end">
    <div class="flex-1 min-w-[200px]">
        <label for="source-filter" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Source</label>
        <select id="source-filter" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="4">
            
            <option value="Plenary">Plenary (General Assembly)</option>
            
            <option value="C1">First Committee (Disarmament)</option>
            
            <option value="C2">Second Committee (Economic &amp; Financial)</option>
            
            <option value="C3">Third Committee (Social, Humanitarian &amp; Cultural)</option>
            
            <option value="C4">Fourth Committee (Decolonization)</option>
            
            <option value="C5">Fifth Committee (Administrative &amp; Budgetary)</option>
            
            <option value="C6">Sixth Committee (Legal)</option>
            
        </select>
    </div>
    <div class="flex-1 min-w-[200px]">
        <label for="signal-filter" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Signal Type</label>
        <select id="signal-filter" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="4">
            
            <option value="agenda"
                class="text-blue-700"
                >agenda</option>
            
            <option value="PGA"
                class="text-purple-700"
                >PGA</option>
            
            <option value="process"
                class="text-amber-700"
                >process</option>
            
            <option value="report"
                class="text-green-700">report</option>
            
            <option value="observer"
                >observer</option>
            
        </select>
    </div>
    <div class="flex-1 min-w-[200px]">
        <label for="doctype-filter" class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-gray-500">Document Type</label>
        <select id="doctype-filter" multiple class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-un-blue focus:border-transparent" size="2">
            <option value="resolution">Resolutions</option>
            <option value="proposal">Non-adopted Proposals</option>
        </select>
    </div>
    <button id="clear-filters" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">
        Clear filters
    </button>
</div>

<!-- Main Content Area with Split View -->
<div class="flex gap-6" id="main-content">
    <!-- Document List -->
    <div class="flex-1 min-w-0" id="document-list">
        <div class="space-y-4" id="documents-container">
            
        </div>

        <!-- Empty State -->
        <div class="hidden text-center py-12" id="empty-state">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No documents found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or search terms.</p>
        </div>
    </div>

    <!-- Document Detail Panel -->
    <div class="w-80 flex-shrink-0 hidden" id="detail-panel">
        <div class="bg-white border border-gray-200 rounded-lg p-4 sticky top-4">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="detail-title">Document Details</h3>
            <div id="detail-content">
                <p class="text-sm text-gray-500">Select a document to view details</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="loading-overlay">
    <div class="bg-white rounded-lg p-6 flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-un-blue"></div>
        <span class="text-sm text-gray-700">Loading session data...</span>
    </div>
</div>

<script>
// Session data cache
let sessionDataCache = {};
let selectedSessions = ['current', '79', '78'];
let originalDocumentsHTML = '';

// Initialize the explorer
document.addEventListener('DOMContentLoaded', function() {
    // Store original document HTML for current session
    originalDocumentsHTML = document.getElementById('documents-container').innerHTML;

    initializeFilters();
    initializeSearch();
    initializeSessionSelector();
    initializeDetailPanel();

    // Load initial data
    loadSessionData('current');
});

// Session selector
function initializeSessionSelector() {
    const sessionSelector = document.getElementById('session-selector');

    sessionSelector.addEventListener('change', function() {
        const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
        selectedSessions = selectedOptions;
        loadSelectedSessions();
    });
}

// Load session data via AJAX
async function loadSessionData(session) {
    if (session === currentSession && session !== 'current') return;

    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.classList.remove('hidden');

    try {
        if (session === 'current') {
            // Restore original document cards from template
            document.getElementById('documents-container').innerHTML = originalDocumentsHTML;
            currentSession = 'current';
            // Re-initialize event listeners for restored cards
            initializeDocumentCards();
            applyFilters();
        } else {
            // Load session data via AJAX
            if (!sessionDataCache[session]) {
                const response = await fetch(`/sessions/${session}/data.json`);
                if (!response.ok) throw new Error('Failed to load session data');
                sessionDataCache[session] = await response.json();
            }

            // Replace document cards with session data
            renderSessionDocuments(sessionDataCache[session], session);
            currentSession = session;
        }
    } catch (error) {
        console.error('Error loading session data:', error);
        alert('Failed to load session data. Please try again.');
    } finally {
        loadingOverlay.classList.add('hidden');
    }
}

// Render session documents
function renderSessionDocuments(sessionData, session) {
    const container = document.getElementById('documents-container');

    // Transform session data to match template format
    const documents = sessionData.documents || [];

    // Sort documents using the same logic as server-side
    documents.sort((a, b) => {
        // Simple client-side sorting (server-side is preferred for accuracy)
        const aSymbol = a.symbol.toLowerCase();
        const bSymbol = b.symbol.toLowerCase();
        if (aSymbol < bSymbol) return -1;
        if (aSymbol > bSymbol) return 1;
        return 0;
    });

    const html = documents.map(doc => `
        <div class="border border-gray-200 rounded-lg overflow-hidden document-card hover:border-gray-300 transition-colors${doc.doc_type === 'proposal' ? ' border-l-4 border-l-amber-400' : ''}"
             data-symbol="${doc.symbol}"
             data-source="${doc.origin}"
             data-doctype="${doc.doc_type}"
             data-signals="${Object.keys(doc.signal_summary || {}).join(',')}"
             data-un-url="${doc.un_url}"
             data-title="${doc.title || ''}"
             data-session="${session}">
            <!-- Document Header -->
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="font-semibold text-gray-900">
                                ${doc.symbol}
                            </span>
                            ${doc.doc_type === 'proposal' ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Proposal</span>' : ''}
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded text-xs font-bold flex-shrink-0
                                ${getOriginColor(doc.origin)}">
                                ${doc.origin.substring(0, 2)}
                            </span>
                        </div>
                        ${doc.title ? `<p class="text-sm text-gray-600 truncate" title="${doc.title}">${doc.title}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <a href="${doc.un_url}" target="_blank" class="text-xs text-muted hover:text-un-blue transition-colors">
                            View PDF
                        </a>
                    </div>
                </div>
            </div>

            <!-- Signal Summary -->
            <div class="px-4 py-3">
                <div class="flex flex-wrap gap-2">
                    ${Object.entries(doc.signal_summary || {}).map(([signal, count]) =>
                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getSignalColor(signal)}">
                            ${signal} (${count})
                        </span>`
                    ).join('')}
                </div>
            </div>

            <!-- Expandable Content -->
            <div class="border-t border-gray-200 hidden">
                <div class="px-4 py-3 space-y-3">
                    ${(doc.signal_paragraphs || []).map(para => `
                        <div class="border-l-2 border-gray-300 pl-3 para-item" data-signals="${para.signals.join(',')}">
                            <div class="text-xs text-gray-500 mb-1">Paragraph ${para.number}</div>
                            <p class="text-sm text-gray-900">${para.text}</p>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${para.signals.map(signal =>
                                    `<span class="px-1.5 py-0.5 rounded text-xs font-medium ${getSignalColor(signal)}">
                                        ${signal}
                                    </span>`
                                ).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = html;

    // Re-initialize event listeners for new cards
    initializeDocumentCards();
}

// Helper functions
function getOriginColor(origin) {
    const colors = {
        'Plenary': 'bg-amber-50 text-amber-700',
        'C1': 'bg-red-50 text-red-700',
        'C2': 'bg-green-50 text-green-700',
        'C3': 'bg-blue-50 text-blue-700',
        'C4': 'bg-purple-50 text-purple-700',
        'C5': 'bg-orange-50 text-orange-700',
        'C6': 'bg-teal-50 text-teal-700'
    };
    return colors[origin] || 'bg-gray-100 text-gray-700';
}

function getSignalColor(signal) {
    const colors = {
        'agenda': 'bg-blue-100 text-blue-800',
        'PGA': 'bg-purple-100 text-purple-800',
        'process': 'bg-amber-100 text-amber-800',
        'report': 'bg-green-100 text-green-800'
    };
    return colors[signal] || 'bg-gray-100 text-gray-800';
}

// Search functionality
function initializeSearch() {
    const searchInput = document.getElementById('search-input');

    searchInput.addEventListener('input', function() {
        applyFilters();
    });
}

// Filter functionality (similar to original but with search)
function initializeFilters() {
    const sourceFilter = document.getElementById('source-filter');
    const signalFilter = document.getElementById('signal-filter');
    const doctypeFilter = document.getElementById('doctype-filter');
    const clearFiltersBtn = document.getElementById('clear-filters');

    function applyFilters() {
        const selectedSources = Array.from(sourceFilter.selectedOptions).map(opt => opt.value);
        const selectedSignals = Array.from(signalFilter.selectedOptions).map(opt => opt.value);
        const selectedDoctypes = Array.from(doctypeFilter.selectedOptions).map(opt => opt.value);
        const searchQuery = document.getElementById('search-input').value.toLowerCase();

        const documentCards = document.querySelectorAll('.document-card');
        const emptyState = document.getElementById('empty-state');
        const statsText = document.getElementById('stats-text');

        let resolutionCount = 0;
        let proposalCount = 0;
        let paragraphCount = 0;

        documentCards.forEach(card => {
            const cardSource = card.dataset.source;
            const cardDoctype = card.dataset.doctype;
            const cardSignals = card.dataset.signals.split(',').filter(s => s);
            const cardSymbol = card.dataset.symbol.toLowerCase();
            const cardTitle = (card.dataset.title || '').toLowerCase();

            // Check filters
            const sourceMatch = selectedSources.length === 0 || selectedSources.includes(cardSource);
            const signalMatch = selectedSignals.length === 0 || selectedSignals.some(s => cardSignals.includes(s));
            const doctypeMatch = selectedDoctypes.length === 0 || selectedDoctypes.includes(cardDoctype);
            const searchMatch = searchQuery === '' ||
                cardSymbol.includes(searchQuery) ||
                cardTitle.includes(searchQuery);

            if (sourceMatch && signalMatch && doctypeMatch && searchMatch) {
                card.classList.remove('hidden');
                if (cardDoctype === 'resolution') {
                    resolutionCount++;
                } else {
                    proposalCount++;
                }

                // Count visible paragraphs
                const paragraphs = card.querySelectorAll('.para-item');
                paragraphs.forEach(para => {
                    const paraSignals = para.dataset.signals.split(',').filter(s => s);
                    if (selectedSignals.length === 0 || selectedSignals.some(s => paraSignals.includes(s))) {
                        para.classList.remove('hidden');
                        paragraphCount++;
                    } else {
                        para.classList.add('hidden');
                    }
                });
            } else {
                card.classList.add('hidden');
            }
        });

        // Show/hide empty state
        const visibleCount = resolutionCount + proposalCount;
        if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
            document.getElementById('documents-container').classList.add('hidden');
        } else {
            emptyState.classList.add('hidden');
            document.getElementById('documents-container').classList.remove('hidden');
        }

        // Update stats
        const parts = [];
        if (resolutionCount > 0) {
            parts.push(`${resolutionCount} resolution${resolutionCount !== 1 ? 's' : ''}`);
        }
        if (proposalCount > 0) {
            parts.push(`${proposalCount} non-adopted proposal${proposalCount !== 1 ? 's' : ''}`);
        }
        statsText.textContent = parts.length > 0 ? `${paragraphCount} paragraphs across ${parts.join(' and ')}` : '0 documents';
    }

    // Event listeners
    sourceFilter.addEventListener('change', applyFilters);
    signalFilter.addEventListener('change', applyFilters);
    doctypeFilter.addEventListener('change', applyFilters);

    clearFiltersBtn.addEventListener('click', function() {
        Array.from(sourceFilter.options).forEach(opt => opt.selected = false);
        Array.from(signalFilter.options).forEach(opt => opt.selected = false);
        Array.from(doctypeFilter.options).forEach(opt => opt.selected = false);
        document.getElementById('search-input').value = '';
        applyFilters();
    });
}

// Document card interactions
function initializeDocumentCards() {
    const documentCards = document.querySelectorAll('.document-card');

    documentCards.forEach(card => {
        card.addEventListener('click', function() {
            // Toggle expanded content
            const content = this.querySelector('div:last-child');
            const isExpanded = !content.classList.contains('hidden');

            // Hide all expanded content first
            document.querySelectorAll('.document-card div:last-child').forEach(div => {
                div.classList.add('hidden');
            });

            // Show clicked content if it wasn't already expanded
            if (!isExpanded) {
                content.classList.remove('hidden');
            }

            // Update detail panel
            updateDetailPanel(this.dataset);
        });
    });
}

// Detail panel
function initializeDetailPanel() {
    // Initially hidden
}

function updateDetailPanel(data) {
    const detailPanel = document.getElementById('detail-panel');
    const detailContent = document.getElementById('detail-content');

    if (data.symbol) {
        detailContent.innerHTML = `
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-900">${data.symbol}</h4>
                    ${data.title ? `<p class="text-sm text-gray-600 mt-1">${data.title}</p>` : ''}
                </div>
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wide">Source</span>
                    <p class="text-sm text-gray-900 mt-1">${data.source}</p>
                </div>
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wide">Type</span>
                    <p class="text-sm text-gray-900 mt-1">${data.doctype}</p>
                </div>
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wide">Signals</span>
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${data.signals.split(',').filter(s => s).map(signal =>
                            `<span class="px-2 py-1 rounded-full text-xs font-medium ${getSignalColor(signal)}">${signal}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="pt-2">
                    <a href="${data.unUrl}" target="_blank" class="text-sm text-un-blue hover:underline">View PDF →</a>
                </div>
            </div>
        `;
        detailPanel.classList.remove('hidden');
    } else {
        detailPanel.classList.add('hidden');
    }
}

// Initialize document cards on page load
initializeDocumentCards();
</script>

    </main>
    
    <!-- Footer -->
    <footer class="border-t border-gray-100 mt-20">
        <div class="max-w-5xl mx-auto px-6 py-8">
            <p class="text-sm text-muted">
                
Generated 2026-01-24 04:07 UTC · <a href="./data.json" class="text-un-blue hover:underline">JSON API</a>

            </p>
        </div>
    </footer>
</body>
</html>